var te=Object.defineProperty;var se=(P,o,e)=>o in P?te(P,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):P[o]=e;var M=(P,o,e)=>se(P,typeof o!="symbol"?o+"":o,e);import{P as T}from"./phaser-0RJB29YE.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const r of t.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(s){if(s.ep)return;s.ep=!0;const t=e(s);fetch(s.href,t)}})();const D={WIDTH:1280,HEIGHT:720,MAX_PLAYERS:4,MAX_CARD_COUNT:8},A={BOOT:"SCENE_BOOT",PRELOAD:"SCENE_PRELOAD",TITLE:"SCENE_TITLE",PLAYER_SETUP:"SCENE_PLAYER_SETUP",GAME:"SCENE_GAME",OVERLAY:"SCENE_OVERLAY",RESULT:"SCENE_RESULT"},m={PRIMARY:15601937,SECONDARY:16769024,OCEAN:1402304,LAND:14478792,HUD_BG:858942,PANEL_DARK:1714762,TEXT_PRIMARY:3355443,GOLD:16766720,SILVER:12632256,BRONZE:13467442,DANGER:15158332,SUCCESS:2600544},d={PRIMARY:"Arial",SIZE:{SM:14,MD:18,LG:24,XL:32}},X={DICE_ROLL_DURATION:1e3,MOVE_PER_SQUARE:200},K={MINI_TO_NORMAL_TURNS:5,NORMAL_TO_KING_TURNS:10},z={SLOT_PREFIX:"sugoroku_save_slot_",METADATA:"sugoroku_save_metadata",VERSION:"1.0.0"},Y={TOPBAR_H:40,HUD_Y:580,HUD_H:140,ACTION_X:960},ne=["sapporo","sendai","tokyo","nagoya","osaka","hiroshima","fukuoka","naha","kanazawa","niigata"];class oe extends T.Scene{constructor(){super({key:A.BOOT})}preload(){}create(){this.scene.start(A.PRELOAD)}}class re extends T.Scene{constructor(){super({key:A.PRELOAD})}preload(){this.showLoadingBar(),this.load.json("cities","assets/data/cities.json"),this.load.json("routes","assets/data/routes.json"),this.load.json("properties","assets/data/properties.json"),this.load.json("cards","assets/data/cards.json"),this.load.json("events","assets/data/events.json")}create(){this.scene.start(A.TITLE)}showLoadingBar(){const{width:o,height:e}=this.scale,n=o/2,s=e/2;this.add.text(n,s-60,"読み込み中...",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:`#${m.TEXT_PRIMARY.toString(16).padStart(6,"0")}`}).setOrigin(.5),this.add.rectangle(n,s,400,20,14540253).setOrigin(.5);const t=this.add.rectangle(n-200,s,0,20,m.PRIMARY).setOrigin(0,.5);this.load.on("progress",r=>{t.width=400*r})}}class J{constructor(){M(this,"slotIndexKey",`${z.SLOT_PREFIX}index`)}save(o,e){try{const n={version:z.VERSION,savedAt:new Date().toISOString(),gameState:e},s=this.getSlotKey(o);return localStorage.setItem(s,JSON.stringify(n)),this.updateSlotIndex(o,e),!0}catch{return console.error(`[SaveManager] Failed to save slot ${o}`),!1}}load(o){var e;try{const n=this.getSlotKey(o),s=localStorage.getItem(n);if(!s)return null;const t=JSON.parse(s);return(e=t.version)!=null&&e.startsWith(z.VERSION.split(".")[0])||console.warn(`[SaveManager] Version mismatch: ${t.version}`),t}catch{return console.error(`[SaveManager] Failed to load slot ${o}`),null}}listSlots(){try{const o=localStorage.getItem(this.slotIndexKey);return o?JSON.parse(o):[]}catch{return[]}}deleteSlot(o){try{const e=this.getSlotKey(o);localStorage.removeItem(e);const n=this.listSlots().filter(s=>s.slotId!==o);return localStorage.setItem(this.slotIndexKey,JSON.stringify(n)),!0}catch{return console.error(`[SaveManager] Failed to delete slot ${o}`),!1}}hasSlot(o){return localStorage.getItem(this.getSlotKey(o))!==null}getSlotKey(o){return`${z.SLOT_PREFIX}${o}`}updateSlotIndex(o,e){const n=this.listSlots(),s=n.findIndex(r=>r.slotId===o),t={slotId:o,savedAt:new Date().toISOString(),currentYear:e.currentYear,totalYears:e.totalYears,playerNames:e.players.map(r=>r.name)};s>=0?n[s]=t:n.push(t),localStorage.setItem(this.slotIndexKey,JSON.stringify(n))}}const W=3;class ie extends T.Scene{constructor(){super({key:A.TITLE});M(this,"saveManager",new J);M(this,"loadPanelObjects",[]);M(this,"isLoadPanelVisible",!1)}create(){const{width:e,height:n}=this.scale,s=e/2,t=n/2;this.add.rectangle(0,0,e,n,m.HUD_BG).setOrigin(0),this.add.rectangle(0,n*.6,e,n*.4,1713022,.6).setOrigin(0),this.add.rectangle(0,0,e,6,m.PRIMARY).setOrigin(0),this.add.rectangle(0,n-6,e,6,m.PRIMARY).setOrigin(0),this.add.text(s,t-130,"双六ゲーム",{fontFamily:d.PRIMARY,fontSize:64,color:"#ffffff",fontStyle:"bold",stroke:"#cc0000",strokeThickness:5}).setOrigin(.5),this.add.text(s,t-55,"〜 桃鉄風 日本一周 〜",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(.5);const r=this.add.graphics();r.lineStyle(1,m.GOLD,.5),r.beginPath(),r.moveTo(s-160,t-25),r.lineTo(s+160,t-25),r.strokePath(),this.createButton(s,t+20,"はじめから",m.PRIMARY,()=>{this.scene.start(A.PLAYER_SETUP)});const l=this.saveManager.listSlots().length>0;this.createButton(s,t+90,"つづきから",l?1402304:3355477,()=>{l&&this.toggleLoadPanel()}),this.add.text(10,n-10,"v1.0.0",{fontFamily:d.PRIMARY,fontSize:10,color:"#555577"}).setOrigin(0,1)}toggleLoadPanel(){this.isLoadPanelVisible?this.hideLoadPanel():this.showLoadPanel()}showLoadPanel(){this.hideLoadPanel(),this.isLoadPanelVisible=!0;const{width:e,height:n}=this.scale,s=e/2,t=this.saveManager.listSlots(),r=this.add.rectangle(0,0,e,n,0,.6).setOrigin(0).setInteractive().on("pointerdown",()=>this.hideLoadPanel());this.loadPanelObjects.push(r);const i=100+W*80+50,l=n/2-i/2,a=this.add.rectangle(s,n/2,500,i,m.PANEL_DARK).setOrigin(.5);a.setStrokeStyle(2,m.GOLD),this.loadPanelObjects.push(a);const c=this.add.rectangle(s,l,500,44,m.PRIMARY).setOrigin(.5,0);this.loadPanelObjects.push(c);const h=this.add.text(s,l+22,"セーブデータを選択",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);this.loadPanelObjects.push(h);for(let u=0;u<W;u++){const g=l+64+u*76,f=t.find(b=>b.slotId===`slot_${u+1}`);f?this.createSlotRow(s,g,f):this.createEmptySlotRow(s,g,`slot_${u+1}`)}const y=this.add.text(s,l+i-22,"✕ 閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#aaaaaa"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.hideLoadPanel());this.loadPanelObjects.push(y)}createSlotRow(e,n,s){const t=new Date(s.savedAt).toLocaleDateString("ja-JP"),r=s.playerNames.join("・"),i=this.add.rectangle(e,n,460,68,1981023).setOrigin(.5).setStrokeStyle(1,3359880).setInteractive({useHandCursor:!0});i.on("pointerover",()=>i.setFillStyle(2771568)),i.on("pointerout",()=>i.setFillStyle(1981023)),i.on("pointerdown",()=>this.loadGame(s.slotId)),this.loadPanelObjects.push(i);const l=this.add.text(e-210,n-14,`${s.currentYear}年目 / ${s.totalYears}年間`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(0,.5);this.loadPanelObjects.push(l);const a=this.add.text(e-210,n+10,r,{fontFamily:d.PRIMARY,fontSize:12,color:"#aabbcc"}).setOrigin(0,.5);this.loadPanelObjects.push(a);const c=this.add.text(e+210,n,t,{fontFamily:d.PRIMARY,fontSize:11,color:"#778899"}).setOrigin(1,.5);this.loadPanelObjects.push(c);const h=this.add.text(e+175,n-20,"×",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#e74c3c"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",y=>{y.event.stopPropagation(),this.saveManager.deleteSlot(s.slotId),this.showLoadPanel()});this.loadPanelObjects.push(h)}createEmptySlotRow(e,n,s){const t=this.add.rectangle(e,n,460,68,1318448).setOrigin(.5).setStrokeStyle(1,2241365);this.loadPanelObjects.push(t);const r=this.add.text(e,n,"--- 空きスロット ---",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#445566"}).setOrigin(.5);this.loadPanelObjects.push(r)}hideLoadPanel(){this.loadPanelObjects.forEach(e=>e.destroy()),this.loadPanelObjects=[],this.isLoadPanelVisible=!1}loadGame(e){const n=this.saveManager.load(e);n&&(this.hideLoadPanel(),this.scene.start(A.GAME,{gameState:n.gameState,saveSlotId:e}))}createButton(e,n,s,t,r){const i=this.add.rectangle(e,n,280,56,t).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,n,s,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1);const l=Math.max(0,t-2236962);i.on("pointerover",()=>{i.setFillStyle(l),i.setScale(1.03)}),i.on("pointerout",()=>{i.setFillStyle(t),i.setScale(1)}),i.on("pointerdown",r)}}const Z=[15158332,3447003,3066993,15965202],ae=["赤","青","緑","黄"];class le extends T.Scene{constructor(){super({key:A.PLAYER_SETUP});M(this,"totalYears",10);M(this,"playerConfigs",[{name:"プレイヤー1",type:"human",difficulty:"normal"},{name:"CPU2",type:"cpu",difficulty:"normal"},{name:"CPU3",type:"cpu",difficulty:"normal"},{name:"CPU4",type:"cpu",difficulty:"normal"}]);M(this,"playerCount",2);M(this,"yearText");M(this,"playerRows",[])}create(){const{width:e,height:n}=this.scale;this.add.rectangle(0,0,e,n,m.HUD_BG).setOrigin(0),this.add.rectangle(0,0,e,56,m.PRIMARY).setOrigin(0),this.add.text(e/2,28,"プレイヤー設定",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5),this.add.text(20,28,"← 戻る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffdddd"}).setOrigin(0,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.scene.start(A.TITLE)),this.createYearSelector(e/2,100);for(let s=0;s<D.MAX_PLAYERS;s++)this.createPlayerRow(s,160+s*118);this.createStartButton(e/2,n-50)}createYearSelector(e,n){this.add.text(e-130,n,"年数：",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(0,.5),this.createSmallButton(e-20,n,"-",()=>{this.totalYears>1&&(this.totalYears--,this.yearText.setText(`${this.totalYears}年`))}),this.yearText=this.add.text(e+40,n,`${this.totalYears}年`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(.5),this.createSmallButton(e+100,n,"+",()=>{this.totalYears<99&&(this.totalYears++,this.yearText.setText(`${this.totalYears}年`))})}createPlayerRow(e,n){const{width:s}=this.scale,t=e<this.playerCount,r=this.playerConfigs[e],i={index:e,y:n,objects:[]},l=this.add.rectangle(s/2,n+50,s-40,108,t?m.PANEL_DARK:857381).setOrigin(.5).setStrokeStyle(t?2:0,Z[e]);i.objects.push(l);const a=this.add.rectangle(20,n+6,4,100,Z[e],t?1:.3).setOrigin(0);i.objects.push(a);const c=this.add.circle(52,n+50,14,Z[e],t?1:.3);i.objects.push(c);const h=this.add.text(76,n+50,`P${e+1} ${ae[e]}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:t?"#ffffff":"#445566",fontStyle:"bold"}).setOrigin(0,.5);if(i.objects.push(h),e>=2){const w=this.add.text(s-24,n+24,t?"✕ 外す":"＋ 追加",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:t?"#ff6666":"#44cc88"}).setOrigin(1,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.togglePlayer(e));i.objects.push(w)}const y=this.add.text(76,n+76,(r==null?void 0:r.name)??`P${e+1}`,{fontFamily:d.PRIMARY,fontSize:12,color:t?"#aabbcc":"#334455"}).setOrigin(0,.5);i.objects.push(y);const u=(r==null?void 0:r.type)==="human"?2600544:2719929,g=this.add.text(260,n+50,(r==null?void 0:r.type)==="human"?"人間":"CPU",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:t?"#ffffff":"#445566",backgroundColor:t?"#"+u.toString(16).padStart(6,"0"):"#223344",padding:{x:12,y:5}}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.toggleType(e));i.objects.push(g);const f=["やさしい","ふつう","むずかしい"],b=["easy","normal","hard"];f.map((w,p)=>{const I=t&&(r==null?void 0:r.type)==="cpu"&&r.difficulty===b[p];return this.add.text(420+p*118,n+50,w,{fontFamily:d.PRIMARY,fontSize:12,color:t&&(r==null?void 0:r.type)==="cpu"?I?"#000000":"#aabbcc":"#334455",backgroundColor:I?"#"+m.SECONDARY.toString(16).padStart(6,"0"):"#1a2a3a",padding:{x:8,y:5}}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.setDifficulty(e,b[p]))}).forEach(w=>i.objects.push(w)),t||c.setAlpha(.3),this.playerRows.push(i)}togglePlayer(e){e<2||(this.playerCount>e?this.playerCount=e:this.playerCount=e+1,this.rebuildRows())}toggleType(e){if(e>=this.playerCount)return;const n=this.playerConfigs[e];n.type=n.type==="human"?"cpu":"human",this.rebuildRows()}setDifficulty(e,n){e>=this.playerCount||(this.playerConfigs[e].difficulty=n,this.rebuildRows())}rebuildRows(){this.playerRows.forEach(e=>e.objects.forEach(n=>n.destroy())),this.playerRows=[];for(let e=0;e<D.MAX_PLAYERS;e++)this.createPlayerRow(e,160+e*118)}createStartButton(e,n){const s=this.add.rectangle(e,n,300,56,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),t=this.add.text(e,n,"ゲームスタート！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5);s.on("pointerover",()=>{s.setFillStyle(13369344),s.setScale(1.03)}),s.on("pointerout",()=>{s.setFillStyle(m.PRIMARY),s.setScale(1)}),s.on("pointerdown",()=>{const r={totalYears:this.totalYears,players:this.playerConfigs.slice(0,this.playerCount)};this.scene.start(A.GAME,{gameConfig:r})}),t.setDepth(1)}createSmallButton(e,n,s,t){const r=this.add.rectangle(e,n,38,38,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,n,s,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),r.on("pointerover",()=>r.setFillStyle(13369344)),r.on("pointerout",()=>r.setFillStyle(m.PRIMARY)),r.on("pointerdown",t)}}const ce={minLat:24,maxLat:46,minLng:122,maxLng:147};function U(P,o,e){const{minLat:n,maxLat:s,minLng:t,maxLng:r}=ce,i=e.x+(o-t)/(r-t)*e.width,l=e.y+(1-(P-n)/(s-n))*e.height;return{x:i,y:l}}function de(P,o,e){return{x:P.x+(o.x-P.x)*e,y:P.y+(o.y-P.y)*e}}function he(P,o,e){const n=[];for(let s=0;s<e;s++){const t=(s+1)/(e+1);n.push(de(P,o,t))}return n}class ye{constructor(){M(this,"cities",new Map);M(this,"routes",[]);M(this,"cityRoutes",new Map)}loadData(o){var e,n;this.cities.clear(),this.routes=o.routes,this.cityRoutes.clear();for(const s of o.cities)this.cities.set(s.id,s),this.cityRoutes.set(s.id,[]);for(const s of o.routes)(e=this.cityRoutes.get(s.fromCityId))==null||e.push(s),(n=this.cityRoutes.get(s.toCityId))==null||n.push(s)}getCityById(o){return this.cities.get(o)}getAllCities(){return Array.from(this.cities.values())}getAllRoutes(){return this.routes}getRoutesFromCity(o){return this.cityRoutes.get(o)??[]}getAdjacentCities(o){return this.getRoutesFromCity(o).map(s=>s.fromCityId===o?s.toCityId:s.fromCityId).map(s=>this.cities.get(s)).filter(s=>s!==void 0)}getOtherCityId(o,e){return o.fromCityId===e?o.toCityId:o.fromCityId}getCityCanvasPos(o,e){const n=this.cities.get(o);if(n)return U(n.lat,n.lng,e)}getAllSquarePositions(o){const e=[];for(const n of this.routes){const s=this.cities.get(n.fromCityId),t=this.cities.get(n.toCityId);if(!s||!t)continue;const r=U(s.lat,s.lng,o),i=U(t.lat,t.lng,o),l=he(r,i,n.squares.length);for(let a=0;a<n.squares.length;a++)e.push({routeId:n.id,squareIndex:a,x:l[a].x,y:l[a].y,type:n.squares[a]})}return e}getRandomDestination(o){const e=Array.from(this.cities.values()).filter(n=>n.id!==o);if(e.length!==0)return e[Math.floor(Math.random()*e.length)]}}class ue{getPropertiesByCity(o,e){return o.filter(n=>n.cityId===e)}getOwnedProperties(o,e){return o.filter(n=>n.ownerId===e)}hasMonopoly(o,e,n){const s=o.filter(t=>t.cityId===e);return s.length>0&&s.every(t=>t.ownerId===n)}buyProperty(o,e,n){const s=o.players.find(c=>c.id===e),t=o.properties.find(c=>c.id===n);if(!s||!t)return{success:!1,reason:"not_enough_money"};if(t.ownerId!==null)return{success:!1,reason:"already_owned"};const r=this.getCurrentPrice(t);if(s.money<r)return{success:!1,reason:"not_enough_money"};const i=o.players.map(c=>c.id===e?{...c,money:c.money-r}:c),l=o.properties.map(c=>c.id===n?{...c,ownerId:e}:c),a={...o,players:i,properties:l};return{success:!0,newState:this.recalcTotalAssets(a)}}upgradeProperty(o,e,n){const s=o.players.find(c=>c.id===e),t=o.properties.find(c=>c.id===n);if(!s||!t||t.ownerId!==e)return{success:!1};if(t.upgradeLevel>=t.upgradePrices.length)return{success:!1};const r=t.upgradePrices[t.upgradeLevel];if(s.money<r)return{success:!1,reason:"not_enough_money"};const i=o.players.map(c=>c.id===e?{...c,money:c.money-r}:c),l=o.properties.map(c=>c.id===n?{...c,upgradeLevel:c.upgradeLevel+1}:c),a={...o,players:i,properties:l};return{success:!0,newState:this.recalcTotalAssets(a)}}payLandFee(o,e,n){const s=o.players.find(a=>a.id===e),t=o.properties.find(a=>a.id===n);if(!s||!t||!t.ownerId||t.ownerId===e)return o;const r=this.getLandFee(t),i=Math.min(r,s.money),l=o.players.map(a=>a.id===e?{...a,money:a.money-i}:a.id===t.ownerId?{...a,money:a.money+i}:a);return this.recalcTotalAssets({...o,players:l})}calcYearEndIncome(o){const e=[];let n=[...o.players];for(const t of o.players){const r=this.calcPlayerAnnualIncome(o.properties,t.id),i=t.incomeMultiplier??1,l={...r,totalIncome:Math.floor(r.totalIncome*i)};e.push(l),n=n.map(a=>a.id===t.id?{...a,money:a.money+l.totalIncome,incomeMultiplier:1}:a)}return{newState:this.recalcTotalAssets({...o,players:n}),results:e}}calcPlayerAnnualIncome(o,e){const n=this.getOwnedProperties(o,e);if(n.length===0)return{playerId:e,propertyIncome:0,monopolyBonus:0,totalIncome:0};const s=new Map;for(const i of n){const l=s.get(i.cityId)??[];l.push(i),s.set(i.cityId,l)}let t=0,r=0;for(const[i,l]of s){const a=l.reduce((y,u)=>y+this.getCurrentIncome(u),0);t+=a;const c=o.filter(y=>y.cityId===i);c.length>0&&c.every(y=>y.ownerId===e)&&(r+=a)}return{playerId:e,propertyIncome:t,monopolyBonus:r,totalIncome:t+r}}getCurrentPrice(o){return o.price}getCurrentIncome(o){return o.upgradeLevel===0?o.income:o.upgradeIncomes[o.upgradeLevel-1]??o.income}getLandFee(o){return Math.floor(this.getCurrentIncome(o)*.5)}sellPropertyForcibly(o,e,n){const s=o.players.find(a=>a.id===e),t=o.properties.find(a=>a.id===n);if(!s||!t||t.ownerId!==e)return o;const r=Math.floor(t.price*.5),i=o.players.map(a=>a.id===e?{...a,money:a.money+r}:a),l=o.properties.map(a=>a.id===n?{...a,ownerId:null,upgradeLevel:0}:a);return this.recalcTotalAssets({...o,players:i,properties:l})}recalcTotalAssets(o){const e=o.players.map(n=>{const s=o.properties.filter(t=>t.ownerId===n.id).reduce((t,r)=>t+r.price,0);return{...n,totalAssets:n.money+s}});return{...o,players:e}}getLastPlacePlayerId(o){return o.reduce((e,n)=>n.totalAssets<e.totalAssets?n:e).id}}function V(P,o){return Math.floor(Math.random()*(o-P+1))+P}function q(){return V(1,6)}function k(P){return P[V(0,P.length-1)]}function fe(P,o){const e=[...P],n=[],s=Math.min(o,e.length);for(let t=0;t<s;t++){const r=V(0,e.length-1);n.push(e[r]),e.splice(r,1)}return n}function pe(P,o){const e=o.reduce((s,t)=>s+t,0);let n=Math.random()*e;for(let s=0;s<P.length;s++)if(n-=o[s],n<=0)return P[s];return P[P.length-1]}const ge={common:60,uncommon:30,rare:10};class me{constructor(){M(this,"allCards",[])}loadCards(o){this.allCards=o}getCardById(o){return this.allCards.find(e=>e.id===o)}getAllCards(){return this.allCards}getCardsByType(o){return this.allCards.filter(e=>e.type===o)}canDrawCard(o,e){const n=o.players.find(s=>s.id===e);return n?n.hand.length<D.MAX_CARD_COUNT:!1}drawRandomCard(){if(this.allCards.length===0)return;const o=this.allCards.map(e=>ge[e.rarity]??10);return pe(this.allCards,o)}gainCard(o,e){if(!this.canDrawCard(o,e))return{newState:o,card:null};const n=this.drawRandomCard();if(!n)return{newState:o,card:null};const s=o.players.map(t=>t.id===e?{...t,hand:[...t.hand,n.id]}:t);return{newState:{...o,players:s},card:n}}buyCard(o,e,n){const s=o.players.find(l=>l.id===e),t=this.getCardById(n);if(!s||!t)return{newState:o,success:!1,reason:"not_found"};if(!this.canDrawCard(o,e))return{newState:o,success:!1,reason:"hand_full"};const r=this.getCardShopPrice(t);if(s.money<r)return{newState:o,success:!1,reason:"not_enough_money"};const i=o.players.map(l=>l.id===e?{...l,money:l.money-r,hand:[...l.hand,t.id]}:l);return{newState:{...o,players:i},success:!0}}getCardShopPrice(o){return{common:500,uncommon:1500,rare:5e3}[o.rarity]??1e3}useCard(o,e,n,s={}){const t=o.players.find(l=>l.id===e),r=this.getCardById(n);if(!t||!r)return{success:!1,reason:"not_found"};if(!t.hand.includes(n))return{success:!1,reason:"not_owner"};const i=l=>({...l,players:l.players.map(a=>a.id===e?{...a,hand:a.hand.filter(c=>c!==n)}:a)});switch(r.type){case"move_to_destination":return this.useMoveToDest(i(o),e,r);case"get_money":return this.useGetMoney(i(o),e,r);case"pay_money":return this.usePayMoney(i(o),e,r);case"bombee_transfer":return r.effect.targetType==="last_to_second"?this.useBombeeTransferLastToSecond(i(o)):s.targetPlayerId?this.useBombeeTransfer(i(o),e,s.targetPlayerId):{success:!1,reason:"no_target"};case"card_steal":return s.targetPlayerId?this.useCardSteal(i(o),e,s.targetPlayerId,s.targetCardId):{success:!1,reason:"no_target"};case"move_to_city":return this.useMoveToCity(i(o),e,r);case"bombee_away":return this.useBombeeAway(i(o),e,r);case"sell_property":return this.useSellProperty(i(o),e,r,s.targetPropertyId,s.targetPlayerId,s.targetCityId);case"steal_property":return this.useStealProperty(i(o),e,r,s.targetCityId);case"monopoly_break":return this.useMonopolyBreak(i(o),e,r);case"buy_property":return this.useBuyProperty(i(o),e,r,s.targetCityId);case"double_income":return this.useDoubleIncome(i(o),e,r);case"move_steps":case"plus_dice":return{success:!0,newState:i(o),message:`${r.name} を使用しました`};default:return{success:!0,newState:i(o),message:`${r.name} を使用しました`}}}useMoveToDest(o,e,n){if(n.effect.targetType==="double_move_next_turn"){const t=n.effect.value??2;return{success:!0,newState:{...o,players:o.players.map(i=>i.id===e?{...i,diceMultiplier:t}:i)},message:`${n.name}！次のターンのサイコロが${t}倍になります！`}}return{success:!0,newState:{...o,players:o.players.map(t=>t.id===e?{...t,position:{...t.position,cityId:o.destinationCityId}}:t)},message:`${n.name}！目的地へ向かいます`}}useGetMoney(o,e,n){const s=n.effect.value??1e3,t=n.effect.targetType;if(t==="property_value_percent"){const i=o.properties.filter(a=>a.ownerId===e).reduce((a,c)=>a+c.price,0),l=Math.floor(i*s/100);return{success:!0,newState:{...o,players:o.players.map(a=>a.id===e?{...a,money:a.money+l,totalAssets:a.totalAssets+l}:a)},message:`${n.name}！${l}万円を獲得しました`}}if(t==="all_players_each"){let i=0,l=[...o.players];for(const a of o.players.filter(c=>c.id!==e)){const c=Math.min(s,a.money);i+=c,l=l.map(h=>h.id===a.id?{...h,money:h.money-c,totalAssets:h.totalAssets-c}:h)}return l=l.map(a=>a.id===e?{...a,money:a.money+i,totalAssets:a.totalAssets+i}:a),{success:!0,newState:{...o,players:l},message:`${n.name}！全員から合計${i}万円受け取りました！`}}return{success:!0,newState:{...o,players:o.players.map(i=>i.id===e?{...i,money:i.money+s,totalAssets:i.totalAssets+s}:i)},message:`${n.name}！${s}万円を獲得しました`}}usePayMoney(o,e,n){const s=n.effect.value??1e3,t=o.players.find(a=>a.id===e),r=n.effect.targetType;if(r==="property_value_percent"){const a=o.properties.filter(h=>h.ownerId===e).reduce((h,y)=>h+y.price,0),c=Math.min(Math.floor(a*s/100),t.money);return{success:!0,newState:{...o,players:o.players.map(h=>h.id===e?{...h,money:h.money-c,totalAssets:h.totalAssets-c}:h)},message:`${n.name}！修繕費${c}万円を支払いました`}}if(r==="total_assets_percent"){const a=Math.min(Math.floor(t.totalAssets*s/100),t.money);return{success:!0,newState:{...o,players:o.players.map(c=>c.id===e?{...c,money:c.money-a,totalAssets:c.totalAssets-a}:c)},message:`${n.name}！税金${a}万円を支払いました`}}if(r==="all_players_each"){const a=o.players.filter(u=>u.id!==e);let c=0,h=t.money,y=[...o.players];for(const u of a){if(h<=0)break;const g=Math.min(s,h);c+=g,h-=g,y=y.map(f=>f.id===u.id?{...f,money:f.money+g,totalAssets:f.totalAssets+g}:f)}return y=y.map(u=>u.id===e?{...u,money:u.money-c,totalAssets:u.totalAssets-c}:u),{success:!0,newState:{...o,players:y},message:`${n.name}！全員に合計${c}万円支払いました`}}const i=Math.min(s,t.money);return{success:!0,newState:{...o,players:o.players.map(a=>a.id===e?{...a,money:a.money-i,totalAssets:a.totalAssets-i}:a)},message:`${n.name}！${i}万円を支払いました`}}useBombeeTransfer(o,e,n){const s=o.players.find(i=>i.id===e),t=o.players.find(i=>i.id===n);return!s||!t?{success:!1,reason:"no_target"}:s.bombeeType==="none"?{success:!1,reason:"no_target"}:{success:!0,newState:{...o,players:o.players.map(i=>i.id===e?{...i,bombeeType:"none",bombeeElapsedTurns:0}:i.id===n?{...i,bombeeType:s.bombeeType,bombeeElapsedTurns:0}:i)},message:`ボンビーを ${t.name} へ移しました！`}}useCardSteal(o,e,n,s){const t=o.players.find(c=>c.id===e),r=o.players.find(c=>c.id===n);if(!r||r.hand.length===0)return{success:!1,reason:"no_target"};if(t&&t.hand.length>=D.MAX_CARD_COUNT)return{success:!1,reason:"hand_full"};const i=s&&r.hand.includes(s)?s:k(r.hand),l={...o,players:o.players.map(c=>c.id===e?{...c,hand:[...c.hand,i]}:c.id===n?{...c,hand:c.hand.filter(h=>h!==i)}:c)},a=this.getCardById(i);return{success:!0,newState:l,message:`${r.name} から「${(a==null?void 0:a.name)??"???"}」を奪いました！`}}useMoveToCity(o,e,n){const s=n.effect.targetType??"tokyo";return{success:!0,newState:{...o,players:o.players.map(r=>r.id===e?{...r,position:{...r.position,cityId:s}}:r)},message:`${n.name}！移動します`}}useBombeeAway(o,e,n){const s=o.players.find(a=>a.id===e);if(!s||s.bombeeType==="none")return{success:!0,newState:o,message:"ボンビーがついていません"};const t=n.effect.targetType==="self_permanent",r=t?n.effect.value??1:0,i={...o,players:o.players.map(a=>a.id===e?{...a,bombeeType:"none",bombeeElapsedTurns:0,bombeeImmuneYears:r}:a)},l=t?`${n.name}！ボンビーを追い払い、${r}年間寄せつけません！`:`${n.name}！ボンビーを追い払いました！`;return{success:!0,newState:i,message:l}}useBombeeTransferLastToSecond(o){const e=[...o.players].sort((r,i)=>r.totalAssets-i.totalAssets);if(e.length<2)return{success:!1,reason:"no_target"};const n=e[0],s=e[1];return n.bombeeType==="none"?{success:!1,reason:"no_target"}:{success:!0,newState:{...o,players:o.players.map(r=>r.id===n.id?{...r,bombeeType:"none",bombeeElapsedTurns:0}:r.id===s.id?{...r,bombeeType:n.bombeeType,bombeeElapsedTurns:0}:r)},message:`ボンビーが${n.name}から${s.name}へ強制移動しました！`}}useSellProperty(o,e,n,s,t,r){const i=(n.effect.value??100)/100;if(n.effect.targetType==="current_city_all"&&r){const u=o.properties.filter(S=>S.cityId===r&&S.ownerId===e);if(u.length===0)return{success:!1,reason:"no_target"};let g=0,f=[...o.properties];for(const S of u)g+=Math.floor(S.price*i),f=f.map(w=>w.id===S.id?{...w,ownerId:null,upgradeLevel:0}:w);const b=o.players.map(S=>S.id===e?{...S,money:S.money+g}:S);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:b,properties:f}),message:`現在地の物件${u.length}件を${g}万円で売却しました！`}}if(n.effect.targetType==="opponent_forced"&&t){const u=o.properties.filter(p=>p.ownerId===t);if(u.length===0)return{success:!1,reason:"no_target"};const g=u.reduce((p,I)=>I.price<p.price?I:p),f=Math.floor(g.price*i),b=o.players.map(p=>p.id===t?{...p,money:p.money+f}:p),S=o.properties.map(p=>p.id===g.id?{...p,ownerId:null,upgradeLevel:0}:p),w=o.players.find(p=>p.id===t);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:b,properties:S}),message:`${w==null?void 0:w.name}の「${g.name}」を強制売却させました！`}}const l=o.properties.filter(u=>u.ownerId===e);if(l.length===0)return{success:!1,reason:"no_target"};const a=(s?l.find(u=>u.id===s):null)??l[0],c=Math.floor(a.price*i),h=o.players.map(u=>u.id===e?{...u,money:u.money+c}:u),y=o.properties.map(u=>u.id===a.id?{...u,ownerId:null,upgradeLevel:0}:u);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:h,properties:y}),message:`「${a.name}」を${c}万円で売却しました`}}useStealProperty(o,e,n,s){if(n.effect.targetType==="current_city_all"&&s){const c=o.properties.filter(y=>y.cityId===s&&y.ownerId!==null&&y.ownerId!==e);if(c.length===0)return{success:!1,reason:"no_target"};const h=o.properties.map(y=>c.find(u=>u.id===y.id)?{...y,ownerId:e}:y);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,properties:h}),message:`現在地の物件${c.length}件を奪い取りました！`}}const t=o.players.filter(c=>c.id!==e);if(t.length===0)return{success:!1,reason:"no_target"};const r=t.reduce((c,h)=>h.totalAssets>c.totalAssets?h:c),i=o.properties.filter(c=>c.ownerId===r.id);if(i.length===0)return{success:!1,reason:"no_target"};const l=i.reduce((c,h)=>h.price<c.price?h:c),a=o.properties.map(c=>c.id===l.id?{...c,ownerId:e}:c);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,properties:a}),message:`「${l.name}」を${r.name}から奪い取りました！`}}useMonopolyBreak(o,e,n){const s=o.players.filter(i=>i.id!==e).map(i=>i.id),t=[...new Set(o.properties.map(i=>i.cityId))];for(const i of t){const l=o.properties.filter(a=>a.cityId===i);if(l.length!==0){for(const a of s)if(l.every(c=>c.ownerId===a)){const c=l.reduce((f,b)=>b.price<f.price?b:f),h=Math.floor(c.price*.8),y=o.players.map(f=>f.id===a?{...f,money:f.money+h}:f),u=o.properties.map(f=>f.id===c.id?{...f,ownerId:null,upgradeLevel:0}:f),g=o.players.find(f=>f.id===a);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:y,properties:u}),message:`${g==null?void 0:g.name}の「${c.name}」の独占を崩しました！(${h}万円返却)`}}}}let r=null;for(const i of t){const l=o.properties.filter(a=>a.cityId===i);if(!(l.length<=1))for(const a of s){const h=l.filter(y=>y.ownerId===a).length/l.length;if(h>0&&h<1&&(!r||h>r.ratio)){const y=l.find(u=>u.ownerId===a);r={oppId:a,prop:y,ratio:h}}}}if(r){const i=Math.floor(r.prop.price*.8),l=o.players.map(h=>h.id===r.oppId?{...h,money:h.money+i}:h),a=o.properties.map(h=>h.id===r.prop.id?{...h,ownerId:null,upgradeLevel:0}:h),c=o.players.find(h=>h.id===r.oppId);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:l,properties:a}),message:`${c==null?void 0:c.name}の「${r.prop.name}」を市場に戻しました！`}}return{success:!1,reason:"no_target"}}useBuyProperty(o,e,n,s){const t=o.players.find(i=>i.id===e);if(!t)return{success:!1,reason:"not_found"};const r=n.effect.targetType;if(r==="current_city_free_one"&&s){const i=o.properties.find(a=>a.cityId===s&&a.ownerId===null);if(!i)return{success:!1,reason:"no_target"};const l=o.properties.map(a=>a.id===i.id?{...a,ownerId:e}:a);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,properties:l}),message:`「${i.name}」を無料で入手しました！`}}if(r==="any_location"){const i=o.properties.filter(c=>c.ownerId===null&&t.money>=c.price).sort((c,h)=>c.price-h.price)[0];if(!i)return{success:!1,reason:"no_target"};const l=o.players.map(c=>c.id===e?{...c,money:c.money-i.price}:c),a=o.properties.map(c=>c.id===i.id?{...c,ownerId:e}:c);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:l,properties:a}),message:`「${i.name}」を購入しました！(${i.price}万円)`}}if(s){const i=n.effect.value??0,l=i/100,a=o.properties.filter(u=>u.cityId===s&&u.ownerId===null).sort((u,g)=>u.price-g.price)[0];if(!a)return{success:!1,reason:"no_target"};const c=Math.floor(a.price*(1-l));if(t.money<c)return{success:!1,reason:"no_target"};const h=o.players.map(u=>u.id===e?{...u,money:u.money-c}:u),y=o.properties.map(u=>u.id===a.id?{...u,ownerId:e}:u);return{success:!0,newState:this.recalcTotalAssetsLocal({...o,players:h,properties:y}),message:`「${a.name}」を${i}%割引で購入しました！(${c}万円)`}}return{success:!1,reason:"no_target"}}useDoubleIncome(o,e,n){const s=n.effect.value??2;if(n.effect.targetType==="one_month"){const i=o.properties.filter(c=>c.ownerId===e).reduce((c,h)=>{const y=h.upgradeLevel===0?h.income:h.upgradeIncomes[h.upgradeLevel-1]??h.income;return c+Math.floor(y/12)},0),l=Math.floor(i*s);return{success:!0,newState:{...o,players:o.players.map(c=>c.id===e?{...c,money:c.money+l,totalAssets:c.totalAssets+l}:c)},message:`今月の収益が${s}倍！${l}万円を即座に獲得しました！`}}return{success:!0,newState:{...o,players:o.players.map(r=>r.id===e?{...r,incomeMultiplier:s}:r)},message:`次の年末決算まで収益が${s}倍になります！`}}recalcTotalAssetsLocal(o){const e=o.players.map(n=>{const s=o.properties.filter(t=>t.ownerId===n.id).reduce((t,r)=>t+r.price,0);return{...n,totalAssets:n.money+s}});return{...o,players:e}}getShopLineup(o=5){return this.allCards.length<=o?[...this.allCards]:fe(this.allCards,o)}getPlayerHand(o,e){const n=o.players.find(s=>s.id===e);return n?n.hand.map(s=>this.getCardById(s)).filter(s=>s!==void 0):[]}discardCard(o,e,n){return{...o,players:o.players.map(s=>s.id===e?{...s,hand:s.hand.filter(t=>t!==n)}:s)}}}class Se{attachBombeeToLastPlace(o){if(o.players.some(r=>r.bombeeType!=="none")||o.players.length<2)return o;const n=this.getLastPlacePlayer(o.players);if(!n)return o;const t=this.getLastPlacePlayer(o.players.filter(r=>!(r.bombeeImmuneYears&&r.bombeeImmuneYears>0)))??n;return{...o,players:o.players.map(r=>r.id===t.id?{...r,bombeeType:"mini",bombeeElapsedTurns:0}:r)}}decrementBombeeImmunity(o){return{...o,players:o.players.map(e=>(e.bombeeImmuneYears??0)>0?{...e,bombeeImmuneYears:e.bombeeImmuneYears-1}:e)}}processBombeeAction(o){const e=o.players.find(l=>l.bombeeType!=="none");if(!e)return{newState:o,message:""};const n=e.bombeeElapsedTurns+1,s=this.checkEvolution(e.bombeeType,n);let t={...o,players:o.players.map(l=>l.id===e.id?{...l,bombeeType:s,bombeeElapsedTurns:n}:l)};const r=this.executeBombeeEffect(t,e.id,s);t=r.newState,t=this.maybeMoveToLastPlace(t,e.id);let i=r.message;return s!==e.bombeeType&&(i=`ボンビーが ${this.getBombeeName(s)} に進化！
`+i),{newState:t,message:i}}checkEvolution(o,e){return o==="mini"&&e>=K.MINI_TO_NORMAL_TURNS?"normal":o==="normal"&&e>=K.NORMAL_TO_KING_TURNS?"king":o}executeBombeeEffect(o,e,n){const s=o.players.find(t=>t.id===e);if(!s)return{newState:o,message:""};switch(n){case"mini":return this.miniAction(o,s);case"normal":return this.normalAction(o,s);case"king":return this.kingAction(o,s);default:return{newState:o,message:""}}}miniAction(o,e){const n=Math.random()*.1+.05,s=Math.max(100,Math.floor(e.money*n)),t=Math.min(s,e.money);return t<=0?{newState:o,message:"ミニボンビーが現れたが、お金がなかった！"}:{newState:{...o,players:o.players.map(i=>i.id===e.id?{...i,money:i.money-t,totalAssets:i.totalAssets-t}:i)},message:`ミニボンビー：${e.name} から ${t}万円を奪った！`}}normalAction(o,e){const n=o.properties.filter(l=>l.ownerId===e.id);if(n.length>0&&Math.random()<.5){const l=k(n),a=Math.floor(l.price*.7);return{newState:{...o,players:o.players.map(h=>h.id!==e.id?h:{...h,money:h.money+a,totalAssets:h.totalAssets-(l.price-a)}),properties:o.properties.map(h=>h.id===l.id?{...h,ownerId:null}:h)},message:`ボンビー：${e.name} の「${l.name}」を売却した！（${a}万円）`}}const s=Math.random()*.2+.2,t=Math.max(500,Math.floor(e.money*s)),r=Math.min(t,e.money);return r<=0?{newState:o,message:"ボンビーが現れたが、お金がなかった！"}:{newState:{...o,players:o.players.map(l=>l.id!==e.id?l:{...l,money:l.money-r,totalAssets:l.totalAssets-r})},message:`ボンビー：${e.name} から ${r}万円を奪った！`}}kingAction(o,e){const s=k([...["sell_all","steal_big","affect_all"]]);if(s==="sell_all"){const t=o.properties.filter(l=>l.ownerId===e.id).slice(0,3);if(t.length===0)return this.kingStealBig(o,e);let r=0,i={...o};for(const l of t)r+=Math.floor(l.price*.3),i={...i,properties:i.properties.map(a=>a.id===l.id?{...a,ownerId:null}:a)};return i={...i,players:i.players.map(l=>l.id!==e.id?l:{...l,money:Math.max(0,l.money-r),totalAssets:Math.max(0,l.totalAssets-r*2)})},{newState:i,message:`キングボンビー：${e.name} の物件 ${t.length} 件を強制売却！`}}if(s==="affect_all"){let t={...o};return t={...t,players:t.players.map(r=>{const i=Math.max(100,Math.floor(r.money*.1)),l=Math.min(i,r.money);return{...r,money:r.money-l,totalAssets:r.totalAssets-l}})},{newState:t,message:"キングボンビー：全員から10%ずつ奪った！"}}return this.kingStealBig(o,e)}kingStealBig(o,e){const n=Math.random()*.2+.4,s=Math.max(2e3,Math.floor(e.money*n)),t=Math.min(s,e.money);return t<=0?{newState:o,message:"キングボンビーが現れたが、お金がなかった！"}:{newState:{...o,players:o.players.map(i=>i.id!==e.id?i:{...i,money:i.money-t,totalAssets:i.totalAssets-t})},message:`キングボンビー：${e.name} から ${t}万円を強奪！`}}maybeMoveToLastPlace(o,e){const n=o.players.filter(r=>r.id!==e&&!(r.bombeeImmuneYears&&r.bombeeImmuneYears>0)),s=this.getLastPlacePlayer(n);if(!s)return o;const t=o.players.find(r=>r.id===e);return!t||t.totalAssets<=s.totalAssets?o:Math.random()<.75?{...o,players:o.players.map(r=>r.id===e?{...r,bombeeType:"none",bombeeElapsedTurns:0}:r.id===s.id?{...r,bombeeType:(t==null?void 0:t.bombeeType)??"mini",bombeeElapsedTurns:0}:r)}:o}getLastPlacePlayer(o){if(o.length!==0)return o.reduce((e,n)=>n.totalAssets<e.totalAssets?n:e)}removeBombee(o,e){return{...o,players:o.players.map(n=>n.id===e?{...n,bombeeType:"none",bombeeElapsedTurns:0}:n)}}getBombeeName(o){return{none:"なし",mini:"ミニボンビー",normal:"ボンビー",king:"キングボンビー"}[o]}getBombeePlayer(o){return o.players.find(e=>e.bombeeType!=="none")}}class be{constructor(){M(this,"allEvents",[])}loadEvents(o){this.allEvents=o}drawMonthlyEvents(o){const e=[];for(const n of this.allEvents){const{trigger:s}=n;if(n.type==="monthly"&&s.month===o){e.push(n);continue}n.type!=="monthly"&&Math.random()<s.probability&&e.push(n)}return e}applyEvent(o,e,n){const{effect:s}=e,t=[];let r={...o};switch(s.type){case"money_percent":r=this.applyMoneyPercent(o,s,n,t);break;case"money_fixed":r=this.applyMoneyFixed(o,s,n,t);break;case"property_income_bonus":r=this.applyPropertyIncomeBonus(o,s,t);break;case"all_money_equalizer":r=this.applyAllMoneyEqualizer(o,s,t);break;case"random_teleport":r=this.applyRandomTeleport(o,n);break}return{event:e,newState:r,affectedPlayers:t}}applyMoneyPercent(o,e,n,s){const t=(e.value??0)/100,r=this.resolveTargets(o,e.targetType,n),i=o.players.map(l=>{if(!r.includes(l.id))return l;const a=Math.floor(l.totalAssets*t),c=a<0?l.money>0?Math.max(-l.money,a):0:a;return s.push({playerId:l.id,delta:c}),{...l,money:l.money+c,totalAssets:l.totalAssets+c}});return{...o,players:i}}applyMoneyFixed(o,e,n,s){const t=e.value??0,r=this.resolveTargets(o,e.targetType,n),i=o.players.map(l=>{if(!r.includes(l.id))return l;const a=t<0?Math.max(t,-Math.max(0,l.money)):t;return s.push({playerId:l.id,delta:a}),{...l,money:l.money+a,totalAssets:l.totalAssets+a}});return{...o,players:i}}applyPropertyIncomeBonus(o,e,n){const s=(e.value??0)/100,t=o.players.map(r=>{const i=o.properties.filter(a=>a.ownerId===r.id);if(i.length===0)return r;const l=Math.floor(i.reduce((a,c)=>a+c.income,0)*s);return l===0?r:(n.push({playerId:r.id,delta:l}),{...r,money:r.money+l,totalAssets:r.totalAssets+l})});return{...o,players:t}}applyAllMoneyEqualizer(o,e,n){const s=e.value??0,t=o.players.map(r=>{const i=s<0?Math.max(s,-Math.max(0,r.money)):s;return n.push({playerId:r.id,delta:i}),{...r,money:r.money+i,totalAssets:r.totalAssets+i}});return{...o,players:t}}applyRandomTeleport(o,e){if(!e)return o;const n=[...new Set(o.properties.map(t=>t.cityId))];if(n.length===0)return o;const s=n[Math.floor(Math.random()*n.length)];return{...o,players:o.players.map(t=>t.id===e?{...t,position:{...t.position,cityId:s}}:t)}}resolveTargets(o,e,n){switch(e){case"all":return o.players.map(s=>s.id);case"self":return n?[n]:[];case"first_place":{const s=this.getFirstPlacePlayer(o.players);return s?[s.id]:[]}case"last_place":{const s=this.getLastPlacePlayer(o.players);return s?[s.id]:[]}default:return o.players.map(s=>s.id)}}getFirstPlacePlayer(o){if(o.length!==0)return o.reduce((e,n)=>n.totalAssets>e.totalAssets?n:e)}getLastPlacePlayer(o){if(o.length!==0)return o.reduce((e,n)=>n.totalAssets<e.totalAssets?n:e)}getAllEvents(){return this.allEvents}getEventById(o){return this.allEvents.find(e=>e.id===o)}}class Pe{constructor(o,e,n){M(this,"boardManager");M(this,"propertyManager");M(this,"cardManager");this.boardManager=o,this.propertyManager=e,this.cardManager=n}chooseRoute(o,e,n){if(n.length===1)return n[0];switch(e.difficulty){case"easy":return this.chooseRouteEasy(n);case"normal":return this.chooseRouteNormal(o,e,n);case"hard":return this.chooseRouteHard(o,e,n);default:return k(n)}}chooseRouteEasy(o){return k(o)}chooseRouteNormal(o,e,n){if(!this.boardManager.getCityById(o.destinationCityId))return k(n);const t=n.map(r=>({choice:r,score:this.estimateDistanceToDestination(r.nextCity.id,o.destinationCityId)}));return t.sort((r,i)=>r.score-i.score),t[0].choice}chooseRouteHard(o,e,n){const s=n.map(t=>{const r=this.estimateDistanceToDestination(t.nextCity.id,o.destinationCityId),i=this.calcCityPropertyValue(o,e.id,t.nextCity.id);return{choice:t,score:-r+i*.01}});return s.sort((t,r)=>r.score-t.score),s[0].choice}decidePurchase(o,e,n){switch(e.difficulty){case"easy":return this.decidePurchaseEasy(e,n);case"normal":return this.decidePurchaseNormal(o,e,n);case"hard":return this.decidePurchaseHard(o,e,n);default:return{type:"skip_property"}}}decidePurchaseEasy(o,e){const n=o.money>=e.price,s=e.price<=o.money*.5;return n&&s&&Math.random()<.5?{type:"buy_property",propertyId:e.id}:{type:"skip_property"}}decidePurchaseNormal(o,e,n){const s=this.propertyManager.getCurrentPrice(n);if(e.money<s)return{type:"skip_property"};const t=this.propertyManager.getCurrentIncome(n);if(t<=0)return{type:"skip_property"};const r=s/t,i=o.totalYears-o.currentYear;return r<=i*.8?{type:"buy_property",propertyId:n.id}:this.canMonopolize(o,e.id,n.cityId)?{type:"buy_property",propertyId:n.id}:{type:"skip_property"}}decidePurchaseHard(o,e,n){const s=this.propertyManager.getCurrentPrice(n);if(e.money<s)return{type:"skip_property"};if(this.canMonopolize(o,e.id,n.cityId))return{type:"buy_property",propertyId:n.id};const t=this.propertyManager.getCurrentIncome(n);if(t/s>=.15)return{type:"buy_property",propertyId:n.id};const i=o.totalYears-o.currentYear;return t>0&&s/t<=i?{type:"buy_property",propertyId:n.id}:{type:"skip_property"}}decideCardUse(o,e){if(e.hand.length===0)return{type:"skip_card"};switch(e.difficulty){case"easy":return this.decideCardEasy(e);case"normal":return this.decideCardNormal(o,e);case"hard":return this.decideCardHard(o,e);default:return{type:"skip_card"}}}decideCardEasy(o){return Math.random()<.3&&o.hand.length>0?{type:"use_card",cardId:k(o.hand)}:{type:"skip_card"}}decideCardNormal(o,e){if(o.totalYears-o.currentYear<=3){const s=e.hand.find(t=>{const r=this.cardManager.getCardById(t);return(r==null?void 0:r.type)==="move_to_destination"});if(s)return{type:"use_card",cardId:s}}if(e.bombeeType!=="none"){const s=e.hand.find(t=>{const r=this.cardManager.getCardById(t);return(r==null?void 0:r.type)==="bombee_away"});if(s)return{type:"use_card",cardId:s}}return{type:"skip_card"}}decideCardHard(o,e){const n=this.cardManager.getPlayerHand(o,e.id);if(n.length===0)return{type:"skip_card"};const s=n.map(t=>({card:t,score:this.scoreCard(o,e,t.id)}));return s.sort((t,r)=>r.score-t.score),s[0].score>=50?{type:"use_card",cardId:s[0].card.id}:{type:"skip_card"}}scoreCard(o,e,n){const s=this.cardManager.getCardById(n);if(!s)return 0;switch(s.type){case"move_to_destination":return this.estimateDistanceToDestination(e.position.cityId,o.destinationCityId)*10;case"bombee_away":return e.bombeeType!=="none"?100:0;case"bombee_transfer":return e.bombeeType==="none"?0:80;case"get_money":return 40;case"steal_property":return 60;default:return 20}}estimateDistanceToDestination(o,e){if(o===e)return 0;const n=new Set,s=[{cityId:o,depth:0}];for(;s.length>0;){const t=s.shift();if(n.has(t.cityId))continue;if(n.add(t.cityId),t.cityId===e)return t.depth;if(t.depth>=10)continue;const r=this.boardManager.getAdjacentCities(t.cityId);for(const i of r)n.has(i.id)||s.push({cityId:i.id,depth:t.depth+1})}return 99}canMonopolize(o,e,n){const s=this.propertyManager.getPropertiesByCity(o.properties,n);return s.length===0?!1:s.every(t=>t.ownerId===e||t.ownerId===null)}calcCityPropertyValue(o,e,n){return this.propertyManager.getPropertiesByCity(o.properties,n).filter(t=>t.ownerId===null||t.ownerId===e).reduce((t,r)=>t+this.propertyManager.getCurrentIncome(r),0)}getStrongestOpponent(o,e){const n=o.players.filter(s=>s.id!==e);if(n.length!==0)return n.reduce((s,t)=>t.totalAssets>s.totalAssets?t:s)}getThinkingDelay(o){return{easy:800,normal:1200,hard:1800}[o]}}class Me{constructor(o){M(this,"boardManager");this.boardManager=o}calcArrivalBonus(o,e){if(!o.players.find(r=>r.id===e))return 0;const s=o.players.filter(r=>r.id!==e).reduce((r,i)=>r+i.totalAssets,0);if(s===0)return 1e3;const t=s/(o.players.length-1);return Math.max(1e3,Math.floor(t*o.players.length*.1))}processArrival(o,e){const n=this.calcArrivalBonus(o,e),s=o.players.map(l=>l.id!==e?l:{...l,money:l.money+n,totalAssets:l.totalAssets+n}),t=this.boardManager.getRandomDestination(o.destinationCityId),r=(t==null?void 0:t.id)??o.destinationCityId,i={...o,players:s,destinationCityId:r};return{bonus:n,newDestinationCityId:r,newState:i}}getDestinationCandidates(o,e,n=3){return o.filter(t=>t.id!==e).sort(()=>Math.random()-.5).slice(0,n)}getDestinationCity(o){return this.boardManager.getCityById(o.destinationCityId)}isAtDestination(o,e){return o.position.cityId===e.destinationCityId}}function O(P){const o=Math.abs(P),e=P<0?"-":"";if(o>=1e4){const n=(o/1e4).toFixed(1);return`${e}${n}億円`}return`${e}${o.toLocaleString()}万円`}const E={x:0,y:Y.TOPBAR_H,width:1280,height:540},R=Y.HUD_Y,N=Y.ACTION_X,G=7,Ie=11,we={shinkansen:4431943,local:9479342,ferry:2733814},ve={shinkansen:"新幹線",local:"在来線",ferry:"フェリー"},$=[15158332,3447003,3066993,15965202],j=5;class Oe extends T.Scene{constructor(){super({key:A.GAME});M(this,"boardManager");M(this,"propertyManager");M(this,"cardManager");M(this,"bombeeManager");M(this,"eventManager");M(this,"cpuManager");M(this,"destinationManager");M(this,"saveManager");M(this,"gameState");M(this,"pawnContainers",[]);M(this,"statusTexts",[]);M(this,"phaseText");M(this,"diceResultText");M(this,"diceButton");M(this,"diceButtonLabel");M(this,"destinationText");M(this,"yearMonthText");M(this,"destinationMarker",null);M(this,"bombeeMarker",null);M(this,"propertyDotContainers",[]);M(this,"hudPlayerBgs",[]);M(this,"junctionUI",null);M(this,"cardDrawnThisMove",!1);M(this,"extraDiceBonus",0);M(this,"isNewGame",!0)}get overlayScene(){return this.scene.get(A.OVERLAY)}init(e){this.boardManager=new ye,this.propertyManager=new ue,this.cardManager=new me,this.bombeeManager=new Se,this.eventManager=new be,this.saveManager=new J;const n=this.cache.json.get("cities"),s=this.cache.json.get("routes");if(this.boardManager.loadData({cities:n,routes:s}),this.cardManager.loadCards(this.cache.json.get("cards")??[]),this.eventManager.loadEvents(this.cache.json.get("events")??[]),this.cpuManager=new Pe(this.boardManager,this.propertyManager,this.cardManager),this.destinationManager=new Me(this.boardManager),this.isNewGame=!e.gameState,e.gameState)this.gameState=e.gameState;else{const t=e.gameConfig??{totalYears:10,players:[{name:"プレイヤー1",type:"human",difficulty:"normal"},{name:"CPU",type:"cpu",difficulty:"normal"}]};this.gameState=this.createInitialState(t)}this.gameState=this.bombeeManager.attachBombeeToLastPlace(this.gameState)}create(){const{width:e,height:n}=this.scale;this.add.rectangle(0,0,e,n,m.OCEAN).setOrigin(0),this.drawMap(),this.createTopBar(),this.createBottomHUD(),this.createPawns(),this.updateMapMarkers(),this.scene.isActive(A.OVERLAY)||this.scene.launch(A.OVERLAY),this.setDiceButtonEnabled(!1),this.time.delayedCall(400,()=>this.startFirstTurn())}drawMap(){const e=this.add.graphics();e.fillStyle(m.LAND,1),e.fillRoundedRect(E.x+30,E.y+10,E.width-60,E.height-20,8);for(const n of this.boardManager.getAllRoutes()){const s=this.boardManager.getCityCanvasPos(n.fromCityId,E),t=this.boardManager.getCityCanvasPos(n.toCityId,E);if(!s||!t)continue;const r=we[n.routeType]??8947848,i=n.routeType==="shinkansen"?3.5:1.8,l=n.routeType==="shinkansen"?1:.7;e.lineStyle(i,r,l),e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(t.x,t.y),e.strokePath()}for(const n of this.boardManager.getAllCities()){const s=this.boardManager.getCityCanvasPos(n.id,E);if(!s)continue;e.fillStyle(16777215,1),e.fillCircle(s.x,s.y,G+2),e.fillStyle(m.PRIMARY,1),e.fillCircle(s.x,s.y,G),this.add.text(s.x+G+3,s.y,n.name,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(0,.5);const t=n;this.add.rectangle(s.x,s.y,26,26,0,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.showCityInfoPopup(t.id))}}showCityInfoPopup(e){const n=this.boardManager.getCityById(e);if(!n)return;const s={hokkaido:"北海道",tohoku:"東北",kanto:"関東",chubu:"中部",kinki:"近畿",chugoku:"中国",shikoku:"四国",kyushu_okinawa:"九州・沖縄"},r=this.propertyManager.getPropertiesByCity(this.gameState.properties,e).map(a=>{const c=a.ownerId?this.gameState.players.find(h=>h.id===a.ownerId):null;return{property:a,ownerName:(c==null?void 0:c.name)??null,ownerColor:(c==null?void 0:c.color)??null}}),i=this.overlayScene,l={cityName:n.name,regionName:s[n.region]??n.region,properties:r,onClose:()=>{}};i.events.emit("show_city_info",l)}createTopBar(){const{width:e}=this.scale,n=Y.TOPBAR_H,s=n/2;this.add.rectangle(0,0,e,n,m.HUD_BG).setOrigin(0),this.add.rectangle(0,n-2,e,2,m.GOLD).setOrigin(0),this.yearMonthText=this.add.text(15,s,"",{fontFamily:d.PRIMARY,fontSize:16,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(0,.5),this.destinationText=this.add.text(e/2,s,"",{fontFamily:d.PRIMARY,fontSize:17,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5),this.add.text(e-12,s,"タイトルへ",{fontFamily:d.PRIMARY,fontSize:11,color:"#aaaaaa"}).setOrigin(1,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.scene.start(A.TITLE)),this.updateTopBar()}createBottomHUD(){const{width:e}=this.scale;this.add.rectangle(0,R,e,Y.HUD_H,m.HUD_BG).setOrigin(0),this.add.rectangle(0,R,e,2,m.GOLD).setOrigin(0);const n=240;this.gameState.players.forEach((l,a)=>{const c=a*n,h=this.add.rectangle(c,R,n-2,Y.HUD_H,m.PANEL_DARK).setOrigin(0);this.hudPlayerBgs.push(h),this.add.rectangle(c,R,4,Y.HUD_H,$[a]).setOrigin(0),this.add.circle(c+n-18,R+18,14,m.GOLD).setDepth(1),this.add.text(c+n-18,R+18,"1",{fontFamily:d.PRIMARY,fontSize:12,color:"#000000",fontStyle:"bold"}).setOrigin(.5).setDepth(2);const y=this.add.text(c+10,R+8,l.name,{fontFamily:d.PRIMARY,fontSize:13,color:"#"+$[a].toString(16).padStart(6,"0"),fontStyle:"bold",stroke:"#000000",strokeThickness:1}),u=this.add.text(c+10,R+34,`所持金 ${O(l.money)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff"}),g=this.add.text(c+10,R+54,`総資産 ${O(l.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:13,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}),f=this.add.text(c+10,R+78,this.getBombeeLabel(l),{fontFamily:d.PRIMARY,fontSize:10,color:"#ff4444"}),b=this.add.text(c+n-10,R+Y.HUD_H-14,`🃏 ${l.hand.length}枚`,{fontFamily:d.PRIMARY,fontSize:10,color:"#aaaaaa"}).setOrigin(1,1);if(a<this.gameState.players.length-1){const S=this.add.graphics();S.lineStyle(1,3359846,.8),S.beginPath(),S.moveTo((a+1)*n-1,R+8),S.lineTo((a+1)*n-1,R+Y.HUD_H-8),S.strokePath()}this.statusTexts.push(y,u,g,f,b)});const s=N+(e-N)/2,t=this.add.graphics();t.lineStyle(1,3359846,.8),t.beginPath(),t.moveTo(N,R+8),t.lineTo(N,R+Y.HUD_H-8),t.strokePath(),this.phaseText=this.add.text(s,R+14,"",{fontFamily:d.PRIMARY,fontSize:12,color:"#cccccc",align:"center"}).setOrigin(.5,0),this.diceResultText=this.add.text(s,R+32,"",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#"+m.SECONDARY.toString(16).padStart(6,"0"),fontStyle:"bold",align:"center"}).setOrigin(.5,0);const r=this.add.rectangle(s,R+76,200,30,9323693).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(s,R+76,"🃏 カードを見る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(1),r.on("pointerover",()=>r.setFillStyle(8207512)),r.on("pointerout",()=>r.setFillStyle(9323693)),r.on("pointerdown",()=>this.onCardButtonClick()),this.diceButton=this.add.rectangle(s,R+112,240,46,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),this.diceButtonLabel=this.add.text(s,R+112,"🎲 サイコロを振る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),this.diceButton.on("pointerover",()=>this.diceButton.setFillStyle(13369344)),this.diceButton.on("pointerout",()=>this.diceButton.setFillStyle(m.PRIMARY)),this.diceButton.on("pointerdown",()=>this.onDiceButtonClick());const i=this.add.rectangle(e-8,R+Y.HUD_H-8,80,20,2600544).setOrigin(1,1).setInteractive({useHandCursor:!0});this.add.text(e-8,R+Y.HUD_H-8,"セーブ",{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff"}).setOrigin(1,1).setDepth(1),i.on("pointerover",()=>i.setFillStyle(2202194)),i.on("pointerout",()=>i.setFillStyle(2600544)),i.on("pointerdown",()=>this.saveGame()),this.updatePhaseText()}getBombeeLabel(e){return e.bombeeType==="none"?"":`👺 ${this.bombeeManager.getBombeeName(e.bombeeType)}`}saveGame(){const e=this.saveManager.save("slot_1",this.gameState);this.overlayScene.events.emit("show_event",{title:e?"セーブ完了":"セーブ失敗",description:e?"スロット1にセーブしました":"セーブに失敗しました",onClose:()=>{}})}createPawns(){this.gameState.players.forEach((e,n)=>{const s=this.boardManager.getCityCanvasPos(e.position.cityId,E);if(!s)return;const t=this.getPawnOffset(n),r=this.add.circle(0,0,Ie,$[n]);r.setStrokeStyle(2,16777215);const i=this.add.text(0,0,`${n+1}`,{fontFamily:d.PRIMARY,fontSize:9,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),l=this.add.container(s.x+t.x,s.y+t.y,[r,i]);l.setDepth(10),this.pawnContainers.push(l)})}getPawnOffset(e){return[{x:-8,y:-8},{x:8,y:-8},{x:-8,y:8},{x:8,y:8}][e]??{x:0,y:0}}onCardButtonClick(){const e=this.gameState.players[this.gameState.currentPlayerIndex],n=this.cardManager.getPlayerHand(this.gameState,e.id);this.overlayScene.events.emit("show_card_hand",{player:e,cards:n,onUseCard:t=>this.handleCardUse(t),onDiscardCard:t=>{const r=this.cardManager.getCardById(t);this.gameState=this.cardManager.discardCard(this.gameState,e.id,t),this.updatePlayerPanel(),r&&this.showActionToast(`「${r.name}」を捨てました`)},onClose:()=>{}})}handleCardUse(e){const n=this.gameState.currentPlayerIndex,s=this.gameState.players[n],t=this.cardManager.getCardById(e);if(t){if(t.type==="sell_property"){const r=t.effect.targetType;if(r==="self_choice"){const i=this.gameState.properties.filter(c=>c.ownerId===s.id);if(i.length===0)return;const l=this.overlayScene,a={title:"売却する物件を選んでください",properties:i,onSelect:c=>{this.applyCardEffect(e,{targetCityId:s.position.cityId,targetPropertyId:c})},onCancel:()=>{}};l.events.emit("show_property_select",a);return}if(r==="opponent_forced"){const i=this.gameState.players.filter(a=>a.id!==s.id);if(i.length===0)return;this.overlayScene.events.emit("show_player_select",{title:"強制売却させるプレイヤーを選んでください",players:i,onSelect:a=>{this.applyCardEffect(e,{targetCityId:s.position.cityId,targetPlayerId:a})},onCancel:()=>{}});return}}if(t.type==="move_steps"&&t.effect.targetType==="any_station"){const r=this.boardManager.getAllCities().map(l=>({id:l.id,name:l.name}));this.overlayScene.events.emit("show_city_select",{title:"テレポート先を選んでください",cities:r,onSelect:l=>{this.applyCardEffect(e,{targetCityId:l})},onCancel:()=>{}});return}if(t.type==="bombee_transfer"&&t.effect.targetType==="last_to_second"){this.applyCardEffect(e,{});return}if(t.type==="bombee_transfer"||t.type==="card_steal"){const r=this.gameState.players.filter(a=>a.id!==s.id);if(r.length===0)return;const i=t.type==="bombee_transfer"?"ボンビーを誰に移しますか？":"カードを誰から奪いますか？",l=this.overlayScene;l.events.emit("show_player_select",{title:i,players:r,onSelect:a=>{if(t.type==="card_steal"&&t.effect.targetType==="selected_card"){const c=this.gameState.players.find(y=>y.id===a),h=this.cardManager.getPlayerHand(this.gameState,a);if(!c||h.length===0){this.applyCardEffect(e,{targetPlayerId:a});return}l.events.emit("show_card_select",{title:`${c.name} のカードを選んでください`,cards:h,onSelect:y=>{this.applyCardEffect(e,{targetPlayerId:a,targetCardId:y})},onCancel:()=>{}});return}this.applyCardEffect(e,{targetPlayerId:a})},onCancel:()=>{}});return}this.applyCardEffect(e,{targetCityId:s.position.cityId})}}applyCardEffect(e,n={}){const s=this.gameState.currentPlayerIndex,t=this.gameState.players[s],r=this.cardManager.getCardById(e),i=this.cardManager.useCard(this.gameState,t.id,e,{targetCityId:n.targetCityId??t.position.cityId,targetPlayerId:n.targetPlayerId,targetPropertyId:n.targetPropertyId,targetCardId:n.targetCardId});if(!i.success||!i.newState)return;if(this.gameState=i.newState,this.updatePlayerPanel(),(r==null?void 0:r.type)==="move_to_destination"||(r==null?void 0:r.type)==="move_to_city"){const a=this.gameState.players[s].position.cityId;this.setDiceButtonEnabled(!1),this.teleportPawn(s,a,()=>{this.onPlayerArrived(s,a)});return}if((r==null?void 0:r.type)==="move_steps"){if(this.setDiceButtonEnabled(!1),r.effect.targetType==="any_station"&&n.targetCityId){const c=n.targetCityId;this.gameState={...this.gameState,players:this.gameState.players.map((h,y)=>y===s?{...h,position:{...h.position,cityId:c}}:h)},this.teleportPawn(s,c,()=>{this.onPlayerArrived(s,c)});return}const a=r.effect.value??3;if(a>0)this.movePawnStepByStep(s,a,()=>{const c=this.gameState.players[s];this.onPlayerArrived(s,c.position.cityId)});else{const c=Math.abs(a);this.movePawnBackward(s,c,()=>{const h=this.gameState.players[s];this.onPlayerArrived(s,h.position.cityId)})}return}if((r==null?void 0:r.type)==="plus_dice"){this.extraDiceBonus=r.effect.value??1,this.overlayScene.events.emit("show_event",{title:r.name,description:`次のサイコロに +${this.extraDiceBonus} が加算されます！`,onClose:()=>this.updateCardInfo()});return}this.overlayScene.events.emit("show_event",{title:`${(r==null?void 0:r.name)??"カード"} 使用`,description:i.message??`${(r==null?void 0:r.name)??"カード"} を使いました`,onClose:()=>this.updateCardInfo()})}teleportPawn(e,n,s){const t=this.boardManager.getCityCanvasPos(n,E);if(!t){s();return}const r=this.getPawnOffset(e),i=this.pawnContainers[e];if(!i){s();return}this.tweens.add({targets:i,x:t.x+r.x,y:t.y+r.y,duration:400,ease:"Power3",onComplete:()=>{const l=this.gameState.players.map((a,c)=>c===e?{...a,position:{...a.position,cityId:n}}:a);this.gameState={...this.gameState,players:l},s()}})}onDiceButtonClick(){this.gameState.players[this.gameState.currentPlayerIndex].type!=="cpu"&&this.gameState.phase==="dice_roll"&&this.rollAndMove()}rollAndMove(){this.cardDrawnThisMove=!1;const e=this.extraDiceBonus;this.extraDiceBonus=0;const s=this.gameState.players[this.gameState.currentPlayerIndex].diceMultiplier??1;s!==1&&(this.gameState={...this.gameState,players:this.gameState.players.map((a,c)=>c===this.gameState.currentPlayerIndex?{...a,diceMultiplier:1}:a)});const t=Math.floor((q()+e)*s);this.diceResultText.setText(`🎲 ${t}`),this.setDiceButtonEnabled(!1),this.gameState={...this.gameState,phase:"moving"};const r=X.DICE_ROLL_DURATION,i=Date.now(),l=this.time.addEvent({delay:80,repeat:8,callback:()=>{const a=q();this.diceResultText.setText(`🎲 ${a}`),Date.now()-i>=r&&l.remove()}});this.time.delayedCall(r,()=>{this.diceResultText.setText(`🎲 ${t}`),this.movePawnStepByStep(this.gameState.currentPlayerIndex,t,()=>{const a=this.gameState.players[this.gameState.currentPlayerIndex];this.onPlayerArrived(this.gameState.currentPlayerIndex,a.position.cityId)})})}movePawnStepByStep(e,n,s){if(n===0){s();return}const t=this.gameState.players[e],i=this.boardManager.getRoutesFromCity(t.position.cityId).map(a=>{const c=this.boardManager.getOtherCityId(a,t.position.cityId),h=this.boardManager.getCityById(c);return h?{route:a,nextCity:h}:null}).filter(a=>a!==null);if(i.length===0){s();return}const l=a=>{this.moveOneStep(e,a.nextCity,a.route,()=>{this.movePawnStepByStep(e,n-1,s)})};if(i.length>1&&t.type==="human")this.showJunctionChoice(i,l);else{const a=t.type==="cpu"&&i.length>1?this.cpuManager.chooseRoute(this.gameState,t,i):i[0];l(a)}}moveOneStep(e,n,s,t){const r=this.boardManager.getCityCanvasPos(n.id,E);if(!r){t();return}const i=this.getPawnOffset(e),l=this.pawnContainers[e];if(!l){t();return}this.tweens.add({targets:l,x:r.x+i.x,y:r.y+i.y,duration:X.MOVE_PER_SQUARE,ease:"Power2",onComplete:()=>{const a=this.gameState.players[e].position.cityId,c=this.gameState.players.map((h,y)=>y===e?{...h,position:{cityId:n.id,routeId:null,squareIndex:0,previousCityId:a}}:h);if(this.gameState={...this.gameState,players:c},!this.cardDrawnThisMove&&s.squares.includes("card")){const h=this.gameState.players[e];if(this.cardManager.canDrawCard(this.gameState,h.id)){const y=this.cardManager.gainCard(this.gameState,h.id);y.card&&(this.gameState=y.newState,this.cardDrawnThisMove=!0,this.updateCardInfo(),this.showCardDrawToast(y.card.name))}else h.type==="human"&&this.showHandFullToast()}t()}})}movePawnBackward(e,n,s){if(n===0){s();return}const t=this.gameState.players[e],i=this.boardManager.getRoutesFromCity(t.position.cityId).map(c=>{const h=this.boardManager.getOtherCityId(c,t.position.cityId),y=this.boardManager.getCityById(h);return y?{route:c,nextCity:y}:null}).filter(c=>c!==null);if(i.length===0){s();return}const l=t.position.previousCityId,a=i.find(c=>c.nextCity.id===l)??i[0];this.moveOneStep(e,a.nextCity,a.route,()=>{this.movePawnBackward(e,n-1,s)})}showJunctionChoice(e,n){this.destroyJunctionUI();const s=450,t=50+e.length*50,r=360-t/2,i=[];i.push(this.add.rectangle(s,r+t/2,300,t,2236962,.92).setOrigin(.5)),i.push(this.add.text(s,r+16,"どの路線を選びますか？",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5)),e.forEach((l,a)=>{const c=r+42+a*50,h=ve[l.route.routeType]??l.route.routeType,y=this.add.rectangle(s,c,260,36,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,c,`${l.nextCity.name}（${h}）`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5);y.on("pointerover",()=>y.setFillStyle(15096362)),y.on("pointerout",()=>y.setFillStyle(m.PRIMARY)),y.on("pointerdown",()=>{this.destroyJunctionUI(),n(l)}),i.push(y,u)}),this.junctionUI=this.add.container(0,0,i),this.junctionUI.setDepth(50)}destroyJunctionUI(){this.junctionUI&&(this.junctionUI.destroy(!0),this.junctionUI=null)}onPlayerArrived(e,n){const s=this.gameState.players[e];if(n===this.gameState.destinationCityId){const t=this.destinationManager.processArrival(this.gameState,s.id);this.gameState=t.newState;const r=this.boardManager.getCityById(n);this.overlayScene.events.emit("show_destination_bonus",{player:this.gameState.players[e],bonus:t.bonus,destinationName:(r==null?void 0:r.name)??n,onClose:()=>{this.updateTopBar(),this.updatePlayerPanel(),this.checkShopAndProperty(e,n)}});return}this.checkShopAndProperty(e,n)}checkShopAndProperty(e,n){const s=this.gameState.players[e];if(ne.includes(n)){if(s.type==="human"){this.openCardShop(e,n);return}this.cpuVisitShop(e,n);return}this.checkPropertyAndEndTurn(e,n)}cpuVisitShop(e,n){const s=this.cardManager.getShopLineup(5);let t=0;const r=[];for(const i of s){if(t>=2)break;const l=this.gameState.players[e];if(!this.cardManager.canDrawCard(this.gameState,l.id))break;const a=this.cardManager.getCardShopPrice(i);if(l.money>=a*3){const c=this.cardManager.buyCard(this.gameState,l.id,i.id);c.success&&(this.gameState=c.newState,t++,r.push(i.name))}}if(t>0){this.updatePlayerPanel();const i=this.gameState.players[e],l=r.length===1?`${i.name} が「${r[0]}」を購入！`:`${i.name} がカードを${t}枚購入！`;this.showActionToast(l)}this.checkPropertyAndEndTurn(e,n)}openCardShop(e,n){const s=this.gameState.players[e],t=this.cardManager.getShopLineup(5);this.overlayScene.events.emit("show_card_shop",{player:s,lineup:t,getPrice:i=>this.cardManager.getCardShopPrice(i),onBuy:i=>{const l=this.cardManager.buyCard(this.gameState,s.id,i);l.success&&(this.gameState=l.newState,this.updatePlayerPanel()),this.cardManager.canDrawCard(this.gameState,this.gameState.players[e].id)?this.openCardShop(e,n):this.checkPropertyAndEndTurn(e,n)},onClose:()=>this.checkPropertyAndEndTurn(e,n)})}checkPropertyAndEndTurn(e,n){var a;const s=this.gameState.players[e],t=this.propertyManager.getPropertiesByCity(this.gameState.properties,n);if(t.length===0){this.endTurn();return}const r=t.find(c=>c.ownerId===null);if(r&&s.money>=this.propertyManager.getCurrentPrice(r)){if(s.type==="cpu"){if(this.cpuManager.decidePurchase(this.gameState,s,r).type==="buy_property"){const y=this.propertyManager.buyProperty(this.gameState,s.id,r.id);if(y.success&&y.newState&&(this.gameState=y.newState,this.updatePlayerPanel(),this.propertyManager.hasMonopoly(this.gameState.properties,n,s.id))){const u=((a=this.boardManager.getCityById(n))==null?void 0:a.name)??n;this.showActionToast(`${s.name} が ${u} を独占！`)}}this.endTurn();return}this.overlayScene.events.emit("show_property_purchase",{property:r,player:s,onBuy:()=>{var y;const h=this.propertyManager.buyProperty(this.gameState,s.id,r.id);if(h.success&&h.newState&&(this.gameState=h.newState,this.updatePlayerPanel(),this.propertyManager.hasMonopoly(this.gameState.properties,n,s.id))){const u=((y=this.boardManager.getCityById(n))==null?void 0:y.name)??n;this.showMonopolyToast(u)}this.endTurn()},onSkip:()=>this.endTurn()});return}const i=t.find(c=>c.ownerId!==null&&c.ownerId!==s.id);if(i){const c=this.propertyManager.getLandFee(i),h=i.ownerId,y=()=>{this.gameState={...this.gameState,players:this.gameState.players.map(f=>f.id===s.id?{...f,money:f.money-c}:f.id===h?{...f,money:f.money+c}:f)},this.gameState=this.propertyManager.recalcTotalAssets(this.gameState);const u=this.gameState.players.find(f=>f.id===h);this.overlayScene.events.emit("show_event",{title:"地代支払い",description:`${s.name} が ${(u==null?void 0:u.name)??"?"} に
${O(c)} 支払いました`,onClose:()=>{this.updatePlayerPanel(),this.endTurn()}})};s.money<c?this.handleBankruptcy(s.id,c,y):y();return}const l=t.find(c=>c.ownerId===s.id&&c.upgradeLevel<c.upgradePrices.length&&s.money>=c.upgradePrices[c.upgradeLevel]);if(l){if(s.type==="cpu"){const h=this.propertyManager.upgradeProperty(this.gameState,s.id,l.id);if(h.success&&h.newState){this.gameState=h.newState,this.updatePlayerPanel();const y=l.upgradeLevel+1;this.showActionToast(`${s.name} が「${l.name}」をLv${y}にアップグレード！`)}this.endTurn();return}this.overlayScene.events.emit("show_property_upgrade",{property:l,player:s,onUpgrade:()=>{const h=this.propertyManager.upgradeProperty(this.gameState,s.id,l.id);h.success&&h.newState&&(this.gameState=h.newState,this.updatePlayerPanel()),this.endTurn()},onSkip:()=>this.endTurn()});return}this.endTurn()}handleBankruptcy(e,n,s){const t=this.gameState.players.find(a=>a.id===e),r=this.propertyManager.getOwnedProperties(this.gameState.properties,e);if(t.type==="cpu"){let a=t;for(;a.money<n;){const c=this.propertyManager.getOwnedProperties(this.gameState.properties,e);if(c.length===0)break;const h=c.reduce((y,u)=>u.price<y.price?u:y);this.gameState=this.propertyManager.sellPropertyForcibly(this.gameState,e,h.id),a=this.gameState.players.find(y=>y.id===e)??a}this.updatePlayerPanel(),s();return}const i=this.overlayScene,l={player:t,debtAmount:n,properties:r,onSell:a=>{this.gameState=this.propertyManager.sellPropertyForcibly(this.gameState,e,a),this.updatePlayerPanel(),this.gameState.players.find(h=>h.id===e).money>=n?s():this.handleBankruptcy(e,n,s)},onConfirm:()=>s()};i.events.emit("show_bankruptcy",l)}endTurn(){const e=this.bombeeManager.processBombeeAction(this.gameState);if(this.gameState=e.newState,e.message){this.updatePlayerPanel(),this.overlayScene.events.emit("show_event",{title:"ボンビー行動！",description:e.message,onClose:()=>this.advanceMonth()});return}this.advanceMonth()}advanceMonth(){const e=this.gameState.currentMonth+1;if(e>12){this.gameState={...this.gameState,currentMonth:1,currentYear:this.gameState.currentYear+1},this.triggerYearEnd();return}this.gameState={...this.gameState,currentMonth:e};const n=this.eventManager.drawMonthlyEvents(e);if(n.length>0){this.applyEventsSequentially(n,0,()=>this.nextPlayer());return}this.nextPlayer()}applyEventsSequentially(e,n,s){if(n>=e.length){s();return}const t=e[n],r=this.gameState.players[this.gameState.currentPlayerIndex],i=this.eventManager.applyEvent(this.gameState,t,r.id);this.gameState=i.newState,this.updatePlayerPanel(),this.overlayScene.events.emit("show_event",{title:t.name,description:t.description,onClose:()=>this.applyEventsSequentially(e,n+1,s)})}triggerYearEnd(){if(this.gameState.currentYear>this.gameState.totalYears){this.scene.start(A.RESULT,{gameState:this.gameState});return}const{newState:e,results:n}=this.propertyManager.calcYearEndIncome(this.gameState);this.gameState=this.bombeeManager.decrementBombeeImmunity(e),this.overlayScene.events.emit("show_year_end",{year:this.gameState.currentYear-1,results:n,players:this.gameState.players,onClose:()=>{this.updatePlayerPanel(),this.nextPlayer()}})}nextPlayer(){const e=(this.gameState.currentPlayerIndex+1)%this.gameState.players.length;this.gameState={...this.gameState,currentPlayerIndex:e,phase:"dice_roll",turnCount:this.gameState.turnCount+1},this.updateTopBar(),this.updatePhaseText(),this.updatePlayerPanel(),this.setDiceButtonEnabled(!1);const n=this.gameState.players[e];this.showTurnBanner(n.name,()=>{if(n.type==="cpu"){const s=this.cpuManager.getThinkingDelay(n.difficulty);this.time.delayedCall(s,()=>this.cpuTakeTurn(e))}else this.setDiceButtonEnabled(!0)})}startFirstTurn(){const e=this.gameState.players[this.gameState.currentPlayerIndex],n=()=>{this.showTurnBanner(e.name,()=>{if(e.type==="cpu"){const s=this.cpuManager.getThinkingDelay(e.difficulty);this.time.delayedCall(s,()=>this.cpuTakeTurn(this.gameState.currentPlayerIndex))}else this.setDiceButtonEnabled(!0)})};this.isNewGame?this.showStartBanner(n):n()}showStartBanner(e){const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=this.gameState.totalYears,l=this.add.rectangle(t,r,n,140,9109504,.92).setOrigin(.5).setDepth(100).setAlpha(0),a=this.add.text(t,r-28,"ゲームスタート！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffe066",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(101).setAlpha(0),c=this.add.text(t,r+22,`目標：${i}年後に総資産トップを目指せ！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(101).setAlpha(0),h=[l,a,c];this.tweens.add({targets:h,alpha:{from:0,to:1},duration:400,ease:"Power2",onComplete:()=>{this.time.delayedCall(1400,()=>{this.tweens.add({targets:h,alpha:0,duration:350,ease:"Power2",onComplete:()=>{l.destroy(),a.destroy(),c.destroy(),e()}})})}})}showTurnBanner(e,n){const{width:s,height:t}=this.scale,r=s/2,i=t/2,l=this.add.rectangle(r,i,s,100,1714762,.88).setOrigin(.5).setDepth(100).setAlpha(0),a=this.add.text(r,i,`${e} のターン`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(101).setAlpha(0);this.tweens.add({targets:[l,a],alpha:{from:0,to:1},duration:300,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:[l,a],alpha:0,duration:300,ease:"Power2",onComplete:()=>{l.destroy(),a.destroy(),n()}})})}})}cpuTakeTurn(e){const n=this.gameState.players[e],s=this.cpuManager.decideCardUse(this.gameState,n);if(s.type==="use_card"&&s.cardId){const t=s.cardId,r=this.cardManager.getCardById(t);if(r){this.showActionToast(`${n.name} が「${r.name}」を使用！`);const i=r.type==="bombee_transfer"||r.type==="card_steal",l=r.type==="bombee_transfer"&&r.effect.targetType==="last_to_second";this.time.delayedCall(600,()=>{if(i&&!l){const h=this.gameState.players.filter(y=>y.id!==n.id).reduce((y,u)=>u.totalAssets>y.totalAssets?u:y);this.applyCardEffect(t,{targetPlayerId:h.id,targetCityId:n.position.cityId})}else this.applyCardEffect(t,{targetCityId:n.position.cityId});if(!(r.type==="move_to_destination"||r.type==="move_to_city"||r.type==="move_steps")){const h=this.cpuManager.getThinkingDelay(n.difficulty);this.time.delayedCall(h,()=>this.rollAndMove())}});return}}this.rollAndMove()}updateTopBar(){const{currentYear:e,currentMonth:n}=this.gameState;this.yearMonthText.setText(`${e}年目 ${n}月`);const s=this.boardManager.getCityById(this.gameState.destinationCityId);this.destinationText.setText(`★ 目的地：${(s==null?void 0:s.name)??"???"}`),this.updateMapMarkers()}updateMapMarkers(){const e=this.boardManager.getCityCanvasPos(this.gameState.destinationCityId,E);if(this.destinationMarker&&this.destinationMarker.destroy(),this.destinationMarker=null,e){const t=this.add.container(e.x,e.y-18),r=this.add.circle(0,0,10,15844367,.9),i=this.add.text(0,0,"★",{fontFamily:d.PRIMARY,fontSize:10,color:"#ffffff"}).setOrigin(.5);t.add([r,i]),this.destinationMarker=t}this.bombeeMarker&&this.bombeeMarker.destroy(),this.bombeeMarker=null;const n=this.gameState.players.find(t=>t.bombeeType!=="none");if(n){const t=this.boardManager.getCityCanvasPos(n.position.cityId,E);if(t){const r=this.add.container(t.x+14,t.y-14),i=this.add.circle(0,0,8,15158332,.85),l={mini:"😈",normal:"👿",king:"🔴"},a=this.add.text(0,0,l[n.bombeeType]??"😈",{fontFamily:d.PRIMARY,fontSize:8}).setOrigin(.5);r.add([i,a]),this.bombeeMarker=r}}this.propertyDotContainers.forEach(t=>t.destroy()),this.propertyDotContainers=[];const s=new Map;for(const t of this.gameState.properties)t.ownerId&&(s.has(t.cityId)||s.set(t.cityId,new Set),s.get(t.cityId).add(t.ownerId));s.forEach((t,r)=>{const i=this.boardManager.getCityCanvasPos(r,E);if(!i)return;const l=[...t];l.forEach((a,c)=>{const h=this.gameState.players.find(b=>b.id===a);if(!h)return;const y=i.x+(c-(l.length-1)/2)*7,u=i.y+12,g=this.add.container(y,u),f=this.add.circle(0,0,4,h.color,.9);g.add(f),this.propertyDotContainers.push(g)})})}updatePhaseText(){const e=this.gameState.players[this.gameState.currentPlayerIndex];this.phaseText.setText(`${e.name}のターン`),this.diceButtonLabel.setText(e.type==="cpu"?`${e.name}（CPU）が考え中...`:"サイコロを振る")}updatePlayerPanel(){const e=new Map;[...this.gameState.players].sort((s,t)=>t.totalAssets-s.totalAssets).forEach((s,t)=>e.set(s.id,t+1));const n=[m.GOLD,m.SILVER,m.BRONZE,8947848];this.gameState.players.forEach((s,t)=>{const r=t*j+0,i=t*j+1,l=t*j+2,a=t*j+3,c=t*j+4,h=t===this.gameState.currentPlayerIndex,y=e.get(s.id)??t+1;if(t<this.hudPlayerBgs.length&&(h?(this.hudPlayerBgs[t].setFillStyle(2767450),this.hudPlayerBgs[t].setStrokeStyle(2,$[t])):(this.hudPlayerBgs[t].setFillStyle(m.PANEL_DARK),this.hudPlayerBgs[t].setStrokeStyle(0))),r<this.statusTexts.length){const u=h?"▶ ":"",g="#"+(n[y-1]??11184810).toString(16).padStart(6,"0");this.statusTexts[r].setText(`${u}${y}位 ${s.name}`),this.statusTexts[r].setColor(g)}i<this.statusTexts.length&&(this.statusTexts[i].setText(`所持金 ${O(s.money)}`),this.statusTexts[i].setColor(s.money<0?"#ff4444":"#ffffff")),l<this.statusTexts.length&&this.statusTexts[l].setText(`総資産 ${O(s.totalAssets)}`),a<this.statusTexts.length&&this.statusTexts[a].setText(this.getBombeeLabel(s)),c<this.statusTexts.length&&this.statusTexts[c].setText(`🃏 ${s.hand.length}枚`)}),this.updateMapMarkers()}updateCardInfo(){this.updatePlayerPanel()}showCardDrawToast(e){const{width:n}=this.scale,s=this.add.text(n/2,340,`🃏 カード入手！
「${e}」`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:14,y:8},align:"center"}).setOrigin(.5).setDepth(100).setAlpha(0);this.tweens.add({targets:s,alpha:{from:0,to:1},y:{from:360,to:320},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:s,alpha:0,y:300,duration:300,ease:"Power2",onComplete:()=>s.destroy()})})}})}showMonopolyToast(e){const{width:n}=this.scale,s=this.add.text(n/2,340,`★ ${e} を独占！
収益が2倍になります！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffe066",fontStyle:"bold",backgroundColor:"#8b0000",padding:{x:16,y:10},align:"center",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(110).setAlpha(0);this.tweens.add({targets:s,alpha:{from:0,to:1},y:{from:360,to:310},duration:250,ease:"Power2",onComplete:()=>{this.time.delayedCall(1200,()=>{this.tweens.add({targets:s,alpha:0,y:280,duration:350,ease:"Power2",onComplete:()=>s.destroy()})})}})}showHandFullToast(){const{width:e}=this.scale,n=D.MAX_CARD_COUNT,s=this.add.text(e/2,340,`手札が一杯！（${n}/${n}枚）
カードマスを通過しました`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold",backgroundColor:"#7f8c8d",padding:{x:14,y:8},align:"center"}).setOrigin(.5).setDepth(100).setAlpha(0);this.tweens.add({targets:s,alpha:{from:0,to:1},y:{from:360,to:320},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:s,alpha:0,y:300,duration:300,ease:"Power2",onComplete:()=>s.destroy()})})}})}showActionToast(e){const{width:n}=this.scale,s=this.add.text(n/2,300,e,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",backgroundColor:"#2c3e50",padding:{x:14,y:8},align:"center",wordWrap:{width:320}}).setOrigin(.5).setDepth(200).setAlpha(0);this.tweens.add({targets:s,alpha:{from:0,to:1},y:{from:320,to:280},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(1200,()=>{this.tweens.add({targets:s,alpha:0,y:260,duration:300,ease:"Power2",onComplete:()=>s.destroy()})})}})}setDiceButtonEnabled(e){this.diceButton.setInteractive(e),this.diceButton.setFillStyle(e?m.PRIMARY:11184810),this.diceButton.setAlpha(e?1:.6)}createInitialState(e){const n="tokyo",s=this.boardManager.getRandomDestination(n),t=e.players.map((r,i)=>({id:`player_${i}`,name:r.name,type:r.type,difficulty:r.difficulty,money:1e4,totalAssets:1e4,position:{cityId:n,routeId:null,squareIndex:0},hand:[],bombeeType:"none",bombeeElapsedTurns:0,color:$[i],pawIndex:i,incomeMultiplier:1,diceMultiplier:1,bombeeImmuneYears:0}));return{id:`game_${Date.now()}`,currentYear:1,currentMonth:4,totalYears:e.totalYears,currentPlayerIndex:0,phase:"dice_roll",players:t,properties:this.cache.json.get("properties")??[],destinationCityId:(s==null?void 0:s.id)??"osaka",turnCount:0}}}class Re extends T.Scene{constructor(){super({key:A.OVERLAY});M(this,"overlayObjects",[])}create(){this.events.removeAllListeners(),this.events.on("show_property_purchase",e=>{this.showPropertyPurchase(e)}),this.events.on("show_year_end",e=>{this.showYearEnd(e)}),this.events.on("show_destination_bonus",e=>{this.showDestinationBonus(e)}),this.events.on("show_event",e=>{this.showEvent(e)}),this.events.on("show_card_hand",e=>{this.showCardHand(e)}),this.events.on("show_property_upgrade",e=>{this.showPropertyUpgrade(e)}),this.events.on("show_card_shop",e=>{this.showCardShop(e)}),this.events.on("show_player_select",e=>{this.showPlayerSelect(e)}),this.events.on("show_property_select",e=>{this.showPropertySelect(e)}),this.events.on("show_city_select",e=>{this.showCitySelect(e)}),this.events.on("show_card_select",e=>{this.showCardSelect(e)}),this.events.on("show_bankruptcy",e=>{this.showBankruptcy(e)}),this.events.on("show_city_info",e=>{this.showCityInfo(e)})}showPropertyPurchase(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(t,r,500,340,16777215).setOrigin(.5);l.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(l);const a=this.add.text(t,r-140,"物件購入",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.PRIMARY.toString(16).padStart(6,"0"),padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(t,r-80,e.property.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(c),[`購入価格：${O(e.property.price)}`,`年間収益：${O(e.property.income)}`,`所持金：${O(e.player.money)}`].forEach((w,p)=>{const I=this.add.text(t,r-30+p*28,w,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555"}).setOrigin(.5);this.overlayObjects.push(I)});const y=e.player.money-e.property.price,u=this.add.text(t,r+60,`購入後：${O(y)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:y>=0?"#27ae60":"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(u);const g=this.add.rectangle(t-90,r+120,160,48,m.SUCCESS).setOrigin(.5).setInteractive({useHandCursor:!0}),f=this.add.text(t-90,r+120,"購入する",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);g.on("pointerover",()=>g.setFillStyle(2267476)),g.on("pointerout",()=>g.setFillStyle(m.SUCCESS)),g.on("pointerdown",()=>{this.hideOverlay(),e.onBuy()}),this.overlayObjects.push(g,f);const b=this.add.rectangle(t+90,r+120,160,48,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),S=this.add.text(t+90,r+120,"スキップ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);b.on("pointerover",()=>b.setFillStyle(6710886)),b.on("pointerout",()=>b.setFillStyle(8947848)),b.on("pointerdown",()=>{this.hideOverlay(),e.onSkip()}),this.overlayObjects.push(b,S)}showYearEnd(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=Math.min(120+e.results.length*80,500),l=this.add.rectangle(0,0,n,s,0,.6).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,560,i,16775664).setOrigin(.5);a.setStrokeStyle(3,15965202),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+30,`${e.year}年目 年末決算`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#f39c12",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.results.forEach((u,g)=>{const f=e.players.find(p=>p.id===u.playerId);if(!f)return;const b=r-i/2+90+g*80,S=this.add.text(t-220,b,f.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=[`物件収益：${O(u.propertyIncome)}`,u.monopolyBonus>0?`独占ボーナス：+${O(u.monopolyBonus)}`:null,`合計：${O(u.totalIncome)}`].filter(Boolean);w.forEach((p,I)=>{const v=I===w.length-1,C=this.add.text(t+20,b-18+I*22,p,{fontFamily:d.PRIMARY,fontSize:12,color:v?"#e74c3c":"#555555",fontStyle:v?"bold":"normal"}).setOrigin(0,.5);this.overlayObjects.push(C)})});const h=this.add.rectangle(t,r+i/2-30,180,44,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(t,r+i/2-30,"次のターンへ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(15096362)),h.on("pointerout",()=>h.setFillStyle(m.PRIMARY)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,y)}showDestinationBonus(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(t,r,460,280,16775664).setOrigin(.5);l.setStrokeStyle(3,15844367),this.overlayObjects.push(l);const a=this.add.text(t,r-100,"🎉",{fontSize:48}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(t,r-40,`${e.player.name} が
「${e.destinationName}」に到着！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold",align:"center"}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.text(t,r+30,`ボーナス：${O(e.bonus)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(h);const y=this.add.rectangle(t,r+100,160,44,15844367).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(t,r+100,"続ける",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(.5).setDepth(1);y.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(y,u)}showEvent(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(t,r,480,240,16777215).setOrigin(.5);l.setStrokeStyle(3,m.SECONDARY),this.overlayObjects.push(l);const a=this.add.text(t,r-80,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.SECONDARY.toString(16).padStart(6,"0"),padding:{x:16,y:6}}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(t,r-10,e.description,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",align:"center",wordWrap:{width:400}}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.rectangle(t,r+80,140,44,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(t,r+80,"OK",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(15096362)),h.on("pointerout",()=>h.setFillStyle(m.PRIMARY)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,y)}showCardHand(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=e.cards.length===0?200:Math.min(140+e.cards.length*58,520),l=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,520,i,16777215).setOrigin(.5);a.setStrokeStyle(3,9323693),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+26,`${e.player.name}の手札`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:20,y:6}}).setOrigin(.5);if(this.overlayObjects.push(c),e.cards.length===0){const u=this.add.text(t,r-10,`手札がありません
移動中にカードマスを通ると引けます`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555",align:"center"}).setOrigin(.5);this.overlayObjects.push(u)}else e.cards.forEach((u,g)=>{const f=r-i/2+70+g*58,b=this.add.rectangle(t-20,f,440,50,16314623).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(t-220,f-6,u.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(t-220,f+11,u.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(t+155,f,70,34,m.SUCCESS).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(t+155,f,"使う",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(2267476)),p.on("pointerout",()=>p.setFillStyle(m.SUCCESS)),p.on("pointerdown",()=>{this.hideOverlay(),e.onUseCard(u.id)}),this.overlayObjects.push(p,I);const v=this.add.rectangle(t+230,f,56,34,9807270).setOrigin(.5).setInteractive({useHandCursor:!0}),C=this.add.text(t+230,f,"捨",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);v.on("pointerover",()=>v.setFillStyle(8359053)),v.on("pointerout",()=>v.setFillStyle(9807270)),v.on("pointerdown",()=>{this.hideOverlay(),e.onDiscardCard(u.id)}),this.overlayObjects.push(v,C)});const h=this.add.rectangle(t,r+i/2-26,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(t,r+i/2-26,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,y)}showCardShop(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=Math.min(160+e.lineup.length*62,540),l=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,540,i,16777215).setOrigin(.5);a.setStrokeStyle(3,1482885),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+26,"🏪 カード売り場",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#16a085",padding:{x:20,y:6}}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.text(t,r-i/2+58,`所持金：${O(e.player.money)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333"}).setOrigin(.5);this.overlayObjects.push(h),e.lineup.forEach((g,f)=>{const b=r-i/2+90+f*62,S=e.getPrice(g),w=e.player.money>=S,p=this.add.rectangle(t-10,b,480,54,w?15794168:16316664).setOrigin(.5);this.overlayObjects.push(p);const I={common:"#888888",uncommon:"#3498db",rare:"#e74c3c"},v={common:"普通",uncommon:"珍しい",rare:"レア"},C=this.add.text(t-240,b-8,v[g.rarity]??g.rarity,{fontFamily:d.PRIMARY,fontSize:10,color:I[g.rarity]??"#888888",fontStyle:"bold",backgroundColor:"#eeeeee",padding:{x:4,y:2}}).setOrigin(0,.5);this.overlayObjects.push(C);const F=this.add.text(t-185,b-8,g.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(F);const B=this.add.text(t-240,b+11,g.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666",wordWrap:{width:300}}).setOrigin(0,.5);this.overlayObjects.push(B);const x=this.add.rectangle(t+200,b,90,36,w?1482885:11184810).setOrigin(.5).setInteractive({useHandCursor:w}),_=this.add.text(t+200,b,`${S}万`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);w&&(x.on("pointerover",()=>x.setFillStyle(950384)),x.on("pointerout",()=>x.setFillStyle(1482885)),x.on("pointerdown",()=>{this.hideOverlay(),e.onBuy(g.id)})),this.overlayObjects.push(x,_)});const y=this.add.rectangle(t,r+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(t,r+i/2-28,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);y.on("pointerover",()=>y.setFillStyle(6710886)),y.on("pointerout",()=>y.setFillStyle(8947848)),y.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(y,u)}showPropertyUpgrade(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=e.property,l=i.upgradePrices[i.upgradeLevel],a=i.upgradeLevel===0?i.income:i.upgradeIncomes[i.upgradeLevel-1]??i.income,c=i.upgradeIncomes[i.upgradeLevel]??a,h=this.add.rectangle(0,0,n,s,0,.5).setOrigin(0);this.overlayObjects.push(h);const y=this.add.rectangle(t,r,500,360,16777215).setOrigin(.5);y.setStrokeStyle(3,15105570),this.overlayObjects.push(y);const u=this.add.text(t,r-150,"物件アップグレード",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#e67e22",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(u);const g=this.add.text(t,r-90,i.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(g);const f=this.add.text(t,r-55,`現在 Lv.${i.upgradeLevel} → Lv.${i.upgradeLevel+1}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#e67e22",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(f),[`アップグレード費用：${O(l)}`,`現在の年収：${O(a)} → ${O(c)}`,`所持金：${O(e.player.money)}`].forEach((F,B)=>{const x=this.add.text(t,r-10+B*28,F,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555"}).setOrigin(.5);this.overlayObjects.push(x)});const S=e.player.money-l,w=this.add.text(t,r+80,`購入後：${O(S)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:S>=0?"#27ae60":"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(w);const p=this.add.rectangle(t-90,r+135,160,48,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(t-90,r+135,"アップグレード",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(13266718)),p.on("pointerout",()=>p.setFillStyle(15105570)),p.on("pointerdown",()=>{this.hideOverlay(),e.onUpgrade()}),this.overlayObjects.push(p,I);const v=this.add.rectangle(t+90,r+135,160,48,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),C=this.add.text(t+90,r+135,"スキップ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);v.on("pointerover",()=>v.setFillStyle(6710886)),v.on("pointerout",()=>v.setFillStyle(8947848)),v.on("pointerdown",()=>{this.hideOverlay(),e.onSkip()}),this.overlayObjects.push(v,C)}showPropertySelect(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=Math.min(180+e.properties.length*62,500),l=this.add.rectangle(0,0,n,s,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,500,i,16777215).setOrigin(.5);a.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.PRIMARY.toString(16).padStart(6,"0"),padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.properties.forEach((u,g)=>{const f=r-i/2+86+g*62,b=this.add.rectangle(t,f,450,52,16774638).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(t-200,f-8,u.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(t-200,f+12,`価格：${O(u.price)}  収益：${O(u.income)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#777777"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(t+180,f,90,36,m.DANGER).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(t+180,f,"売却",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(12597547)),p.on("pointerout",()=>p.setFillStyle(m.DANGER)),p.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(u.id)}),this.overlayObjects.push(p,I)});const h=this.add.rectangle(t,r+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(t,r+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(h,y)}showPlayerSelect(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=Math.min(180+e.players.length*66,480),l=this.add.rectangle(0,0,n,s,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,480,i,16777215).setOrigin(.5);a.setStrokeStyle(3,9323693),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.players.forEach((u,g)=>{const f=r-i/2+90+g*66,b=this.add.rectangle(t,f,420,54,16314623).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(t-170,f-8,u.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(t-170,f+12,`総資産：${O(u.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#777777"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(t+160,f,90,36,9323693).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(t+160,f,"選択",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(8207512)),p.on("pointerout",()=>p.setFillStyle(9323693)),p.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(u.id)}),this.overlayObjects.push(p,I)});const h=this.add.rectangle(t,r+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(t,r+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(h,y)}showCardSelect(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=Math.min(180+e.cards.length*70,500),l=this.add.rectangle(0,0,n,s,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(t,r,520,i,16777215).setOrigin(.5);a.setStrokeStyle(3,15158332),this.overlayObjects.push(a);const c=this.add.text(t,r-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#e74c3c",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c);const h={common:"普通",uncommon:"珍しい",rare:"レア"},y={common:"#888888",uncommon:"#3498db",rare:"#e74c3c"};e.cards.forEach((f,b)=>{const S=r-i/2+82+b*70,w=this.add.rectangle(t,S,470,58,16773360).setOrigin(.5);this.overlayObjects.push(w);const p=this.add.text(t-215,S-10,h[f.rarity]??f.rarity,{fontFamily:d.PRIMARY,fontSize:10,color:y[f.rarity]??"#888888",fontStyle:"bold",backgroundColor:"#eeeeee",padding:{x:4,y:2}}).setOrigin(0,.5);this.overlayObjects.push(p);const I=this.add.text(t-155,S-10,f.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(I);const v=this.add.text(t-215,S+12,f.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666",wordWrap:{width:310}}).setOrigin(0,.5);this.overlayObjects.push(v);const C=this.add.rectangle(t+190,S,90,38,15158332).setOrigin(.5).setInteractive({useHandCursor:!0}),F=this.add.text(t+190,S,"奪う",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);C.on("pointerover",()=>C.setFillStyle(12597547)),C.on("pointerout",()=>C.setFillStyle(15158332)),C.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(f.id)}),this.overlayObjects.push(C,F)});const u=this.add.rectangle(t,r+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),g=this.add.text(t,r+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);u.on("pointerover",()=>u.setFillStyle(6710886)),u.on("pointerout",()=>u.setFillStyle(8947848)),u.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(u,g)}showCitySelect(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=640,l=480,a=3,c=180,h=38,y=15,u=10,g=this.add.rectangle(0,0,n,s,0,.6).setOrigin(0);this.overlayObjects.push(g);const f=this.add.rectangle(t,r,i,l,16777215).setOrigin(.5);f.setStrokeStyle(3,1752220),this.overlayObjects.push(f);const b=this.add.text(t,r-l/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#1abc9c",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(b);const S=t-i/2+40+c/2,w=r-l/2+80;e.cities.forEach((v,C)=>{const F=C%a,B=Math.floor(C/a),x=S+F*(c+y),_=w+B*(h+u),L=this.add.rectangle(x,_,c,h,1752220).setOrigin(.5).setInteractive({useHandCursor:!0}),H=this.add.text(x,_,v.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);L.on("pointerover",()=>L.setFillStyle(1482885)),L.on("pointerout",()=>L.setFillStyle(1752220)),L.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(v.id)}),this.overlayObjects.push(L,H)});const p=this.add.rectangle(t,r+l/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(t,r+l/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(6710886)),p.on("pointerout",()=>p.setFillStyle(8947848)),p.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(p,I)}showBankruptcy(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=e.properties.length,l=i>0?Math.min(240+i*62,520):240,a=this.add.rectangle(0,0,n,s,0,.65).setOrigin(0);this.overlayObjects.push(a);const c=this.add.rectangle(t,r,520,l,16777215).setOrigin(.5);c.setStrokeStyle(4,15105570),this.overlayObjects.push(c);const h=this.add.rectangle(t,r-l/2+28,520,56,15105570).setOrigin(.5);this.overlayObjects.push(h);const y=this.add.text(t,r-l/2+28,"⚠ 所持金不足",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(y);const u=Math.max(0,e.debtAmount-e.player.money),g=r-l/2+80,f=this.add.text(t,g,`${e.player.name} の所持金が不足しています
必要額：${O(e.debtAmount)}  所持：${O(e.player.money)}
不足額：${O(u)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#c0392b",fontStyle:"bold",align:"center"}).setOrigin(.5,0);if(this.overlayObjects.push(f),i===0){const p=this.add.text(t,r,`売却できる物件がありません
このまま続けます（負債確定）`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#777777",align:"center"}).setOrigin(.5);this.overlayObjects.push(p);const I=this.add.rectangle(t,r+l/2-36,180,42,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),v=this.add.text(t,r+l/2-36,"続ける",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);I.on("pointerover",()=>I.setFillStyle(13849600)),I.on("pointerout",()=>I.setFillStyle(15105570)),I.on("pointerdown",()=>{this.hideOverlay(),e.onConfirm()}),this.overlayObjects.push(I,v);return}const b=r-l/2+148;e.properties.forEach((p,I)=>{const v=b+I*62,C=this.add.rectangle(t,v,480,52,16774112).setOrigin(.5);this.overlayObjects.push(C);const F=this.add.text(t-215,v-8,p.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(F);const B=Math.floor(p.price*.5),x=this.add.text(t-215,v+12,`価格 ${O(p.price)} → 売却額 ${O(B)}（半額）`,{fontFamily:d.PRIMARY,fontSize:11,color:"#888888"}).setOrigin(0,.5);this.overlayObjects.push(x);const _=this.add.rectangle(t+195,v,100,38,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),L=this.add.text(t+195,v,"売る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);_.on("pointerover",()=>_.setFillStyle(13849600)),_.on("pointerout",()=>_.setFillStyle(15105570)),_.on("pointerdown",()=>{this.hideOverlay(),e.onSell(p.id)}),this.overlayObjects.push(_,L)});const S=this.add.rectangle(t,r+l/2-28,200,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),w=this.add.text(t,r+l/2-28,"このまま続ける（負債）",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(1);S.on("pointerover",()=>S.setFillStyle(6710886)),S.on("pointerout",()=>S.setFillStyle(8947848)),S.on("pointerdown",()=>{this.hideOverlay(),e.onConfirm()}),this.overlayObjects.push(S,w)}showCityInfo(e){this.hideOverlay();const{width:n,height:s}=this.scale,t=n/2,r=s/2,i=e.properties.length,l=i===0?200:Math.min(180+i*52,500),a=this.add.rectangle(0,0,n,s,0,.4).setOrigin(0).setInteractive();a.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(a);const c=this.add.rectangle(t,r,480,l,16777215).setOrigin(.5);c.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(c);const h=this.add.rectangle(t,r-l/2+26,480,52,m.PRIMARY).setOrigin(.5);this.overlayObjects.push(h);const y=this.add.text(t,r-l/2+22,e.cityName,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5,.5);this.overlayObjects.push(y);const u=this.add.text(t,r-l/2+40,e.regionName,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffe0cc"}).setOrigin(.5,.5);if(this.overlayObjects.push(u),i===0){const b=this.add.text(t,r,"この都市に物件はありません",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#888888"}).setOrigin(.5);this.overlayObjects.push(b)}else{const b=r-l/2+76;e.properties.forEach((S,w)=>{const p=b+w*52,I=S.property,v=this.add.rectangle(t,p,450,44,w%2===0?16775408:16773344).setOrigin(.5);this.overlayObjects.push(v);const C=S.ownerColor??13421772,F=this.add.circle(t-205,p,8,C,S.ownerColor?1:.3);this.overlayObjects.push(F);const B=this.add.text(t-190,p-7,I.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(B);const x=S.ownerName?`所有: ${S.ownerName}`:"未所有",_=S.ownerName?"#"+(S.ownerColor??8947848).toString(16).padStart(6,"0"):"#999999",L=this.add.text(t-190,p+8,x,{fontFamily:d.PRIMARY,fontSize:11,color:_}).setOrigin(0,.5);this.overlayObjects.push(L);const H=I.upgradeLevel>0?` Lv${I.upgradeLevel}`:"",Q=I.upgradeLevel>0?I.upgradeIncomes[I.upgradeLevel-1]??I.income:I.income,ee=this.add.text(t+220,p,`${O(I.price)}${H} / 収益${O(Q)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#555555"}).setOrigin(1,.5);this.overlayObjects.push(ee)})}const g=this.add.rectangle(t,r+l/2-26,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),f=this.add.text(t,r+l/2-26,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);g.on("pointerover",()=>g.setFillStyle(6710886)),g.on("pointerout",()=>g.setFillStyle(8947848)),g.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(g,f)}hideOverlay(){this.overlayObjects.forEach(e=>e.destroy()),this.overlayObjects=[]}}const Ce=[15158332,3447003,3066993,15965202],Ae=["#f1c40f","#aaaaaa","#cd7f32","#888888"];class Te extends T.Scene{constructor(){super({key:A.RESULT});M(this,"gameState")}init(e){this.gameState=e.gameState}create(){const{width:e,height:n}=this.scale,s=e/2;if(this.add.rectangle(0,0,e,n,m.HUD_BG).setOrigin(0),this.add.rectangle(0,n*.6,e,n*.4,853536,.8).setOrigin(0),this.add.rectangle(s,60,e,80,m.PRIMARY,.9).setOrigin(.5),this.add.text(s,60,"ゲーム終了！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),!this.gameState||this.gameState.players.length===0){this.showNoDataFallback(s,n);return}const t=this.getRankedPlayers(this.gameState.players);this.showWinner(s,t[0]),this.showRankings(s,t),this.showGameInfo(s,n),this.createReturnButton(s,n-50),this.spawnConfetti(e,n),this.animateEntrance()}getRankedPlayers(e){return[...e].sort((n,s)=>s.totalAssets-n.totalAssets)}showWinner(e,n){this.add.text(e,130,"🏆 優勝者 🏆",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#f1c40f",fontStyle:"bold"}).setOrigin(.5),this.add.text(e,175,n.name,{fontFamily:d.PRIMARY,fontSize:48,color:"#ffffff",fontStyle:"bold",stroke:"#cc0000",strokeThickness:3}).setOrigin(.5),this.add.text(e,215,`総資産 ${O(n.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#f1c40f",fontStyle:"bold"}).setOrigin(.5)}showRankings(e,n){this.add.text(e,265,"--- 最終順位 ---",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#aaaaaa"}).setOrigin(.5),n.forEach((s,t)=>{const r=310+t*80,i="#"+Ce[s.pawIndex].toString(16).padStart(6,"0"),l=t===0?2889744:1710638,a=t===0?.9:.6;this.add.rectangle(e,r,560,68,l,a).setOrigin(.5),t===0&&this.add.rectangle(e,r,560,68).setOrigin(.5).setStrokeStyle(2,15844367);const c=t+1;this.add.text(e-250,r,`${c}位`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:Ae[t]??"#888888",fontStyle:"bold"}).setOrigin(0,.5),this.add.text(e-160,r-14,s.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:i,fontStyle:"bold"}).setOrigin(0,.5);const h=this.gameState.properties.filter(y=>y.ownerId===s.id).length;this.add.text(e-160,r+12,`所持金 ${O(s.money)}  物件${h}件`,{fontFamily:d.PRIMARY,fontSize:12,color:"#aaaaaa"}).setOrigin(0,.5),this.add.text(e+240,r,O(s.totalAssets),{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(1,.5)})}showGameInfo(e,n){this.gameState&&this.add.text(e,n-110,`${this.gameState.totalYears}年間のゲームが終了しました`,{fontFamily:d.PRIMARY,fontSize:13,color:"#666666"}).setOrigin(.5)}createReturnButton(e,n){const s=this.add.rectangle(e,n,240,48,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,n,"タイトルへ戻る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),s.on("pointerover",()=>s.setFillStyle(15096362)),s.on("pointerout",()=>s.setFillStyle(m.PRIMARY)),s.on("pointerdown",()=>this.scene.start(A.TITLE))}showNoDataFallback(e,n){this.add.text(e,n/2,"ゲーム終了",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.createReturnButton(e,n/2+80)}spawnConfetti(e,n){const s=[16711680,16776960,65280,65535,16711935,16746496,16777215];for(let t=0;t<60;t++){const r=T.Math.Between(0,e),i=this.add.rectangle(r,-20,8,12,T.Utils.Array.GetRandom(s)).setDepth(200).setRotation(T.Math.FloatBetween(0,Math.PI*2));this.tweens.add({targets:i,y:n+30,x:r+T.Math.Between(-80,80),rotation:i.rotation+T.Math.FloatBetween(-3,3),alpha:{from:1,to:.4},duration:T.Math.Between(1800,3500),delay:T.Math.Between(0,1200),ease:"Sine.easeIn",onComplete:()=>i.destroy()})}}animateEntrance(){this.cameras.main.fadeIn(600,0,0,0)}}const xe={type:T.AUTO,width:D.WIDTH,height:D.HEIGHT,backgroundColor:"#fff9f0",scene:[oe,re,ie,le,Oe,Re,Te],scale:{mode:T.Scale.FIT,autoCenter:T.Scale.CENTER_BOTH},parent:"game-container"};new T.Game(xe);
