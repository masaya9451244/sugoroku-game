var te=Object.defineProperty;var se=(P,r,e)=>r in P?te(P,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):P[r]=e;var M=(P,r,e)=>se(P,typeof r!="symbol"?r+"":r,e);import{P as T}from"./phaser-0RJB29YE.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();const D={WIDTH:1280,HEIGHT:720,MAX_PLAYERS:4,MAX_CARD_COUNT:8},A={BOOT:"SCENE_BOOT",PRELOAD:"SCENE_PRELOAD",TITLE:"SCENE_TITLE",PLAYER_SETUP:"SCENE_PLAYER_SETUP",GAME:"SCENE_GAME",OVERLAY:"SCENE_OVERLAY",RESULT:"SCENE_RESULT"},m={PRIMARY:15601937,SECONDARY:16769024,OCEAN:1402304,LAND:14478792,HUD_BG:858942,PANEL_DARK:1714762,TEXT_PRIMARY:3355443,GOLD:16766720,SILVER:12632256,BRONZE:13467442,DANGER:15158332,SUCCESS:2600544},d={PRIMARY:"Arial",SIZE:{SM:14,MD:18,LG:24,XL:32}},X={DICE_ROLL_DURATION:1e3,MOVE_PER_SQUARE:200},K={MINI_TO_NORMAL_TURNS:5,NORMAL_TO_KING_TURNS:10},z={SLOT_PREFIX:"sugoroku_save_slot_",METADATA:"sugoroku_save_metadata",VERSION:"1.0.0"},Y={TOPBAR_H:40,HUD_Y:580,HUD_H:140,ACTION_X:960},ne=["sapporo","sendai","tokyo","nagoya","osaka","hiroshima","fukuoka","naha","kanazawa","niigata"];class oe extends T.Scene{constructor(){super({key:A.BOOT})}preload(){}create(){this.scene.start(A.PRELOAD)}}class re extends T.Scene{constructor(){super({key:A.PRELOAD})}preload(){this.showLoadingBar(),this.load.json("cities","assets/data/cities.json"),this.load.json("routes","assets/data/routes.json"),this.load.json("properties","assets/data/properties.json"),this.load.json("cards","assets/data/cards.json"),this.load.json("events","assets/data/events.json")}create(){this.scene.start(A.TITLE)}showLoadingBar(){const{width:r,height:e}=this.scale,t=r/2,n=e/2;this.add.text(t,n-60,"読み込み中...",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:`#${m.TEXT_PRIMARY.toString(16).padStart(6,"0")}`}).setOrigin(.5),this.add.rectangle(t,n,400,20,14540253).setOrigin(.5);const s=this.add.rectangle(t-200,n,0,20,m.PRIMARY).setOrigin(0,.5);this.load.on("progress",o=>{s.width=400*o})}}class J{constructor(){M(this,"slotIndexKey",`${z.SLOT_PREFIX}index`)}save(r,e){try{const t={version:z.VERSION,savedAt:new Date().toISOString(),gameState:e},n=this.getSlotKey(r);return localStorage.setItem(n,JSON.stringify(t)),this.updateSlotIndex(r,e),!0}catch{return console.error(`[SaveManager] Failed to save slot ${r}`),!1}}load(r){var e;try{const t=this.getSlotKey(r),n=localStorage.getItem(t);if(!n)return null;const s=JSON.parse(n);return(e=s.version)!=null&&e.startsWith(z.VERSION.split(".")[0])||console.warn(`[SaveManager] Version mismatch: ${s.version}`),s}catch{return console.error(`[SaveManager] Failed to load slot ${r}`),null}}listSlots(){try{const r=localStorage.getItem(this.slotIndexKey);return r?JSON.parse(r):[]}catch{return[]}}deleteSlot(r){try{const e=this.getSlotKey(r);localStorage.removeItem(e);const t=this.listSlots().filter(n=>n.slotId!==r);return localStorage.setItem(this.slotIndexKey,JSON.stringify(t)),!0}catch{return console.error(`[SaveManager] Failed to delete slot ${r}`),!1}}hasSlot(r){return localStorage.getItem(this.getSlotKey(r))!==null}getSlotKey(r){return`${z.SLOT_PREFIX}${r}`}updateSlotIndex(r,e){const t=this.listSlots(),n=t.findIndex(o=>o.slotId===r),s={slotId:r,savedAt:new Date().toISOString(),currentYear:e.currentYear,totalYears:e.totalYears,playerNames:e.players.map(o=>o.name)};n>=0?t[n]=s:t.push(s),localStorage.setItem(this.slotIndexKey,JSON.stringify(t))}}const W=3;class ie extends T.Scene{constructor(){super({key:A.TITLE});M(this,"saveManager",new J);M(this,"loadPanelObjects",[]);M(this,"isLoadPanelVisible",!1)}create(){const{width:e,height:t}=this.scale,n=e/2,s=t/2;this.add.rectangle(0,0,e,t,m.HUD_BG).setOrigin(0),this.add.rectangle(0,t*.6,e,t*.4,1713022,.6).setOrigin(0),this.add.rectangle(0,0,e,6,m.PRIMARY).setOrigin(0),this.add.rectangle(0,t-6,e,6,m.PRIMARY).setOrigin(0),this.add.text(n,s-130,"双六ゲーム",{fontFamily:d.PRIMARY,fontSize:64,color:"#ffffff",fontStyle:"bold",stroke:"#cc0000",strokeThickness:5}).setOrigin(.5),this.add.text(n,s-55,"〜 桃鉄風 日本一周 〜",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(.5);const o=this.add.graphics();o.lineStyle(1,m.GOLD,.5),o.beginPath(),o.moveTo(n-160,s-25),o.lineTo(n+160,s-25),o.strokePath(),this.createButton(n,s+20,"はじめから",m.PRIMARY,()=>{this.scene.start(A.PLAYER_SETUP)});const l=this.saveManager.listSlots().length>0;this.createButton(n,s+90,"つづきから",l?1402304:3355477,()=>{l&&this.toggleLoadPanel()}),this.add.text(10,t-10,"v1.0.0",{fontFamily:d.PRIMARY,fontSize:10,color:"#555577"}).setOrigin(0,1)}toggleLoadPanel(){this.isLoadPanelVisible?this.hideLoadPanel():this.showLoadPanel()}showLoadPanel(){this.hideLoadPanel(),this.isLoadPanelVisible=!0;const{width:e,height:t}=this.scale,n=e/2,s=this.saveManager.listSlots(),o=100+W*80+50,i=t/2-o/2,l=this.add.rectangle(0,0,e,t,0,.6).setOrigin(0).setInteractive().on("pointerdown",y=>{(y.x<n-250||y.x>n+250||y.y<i||y.y>i+o)&&this.hideLoadPanel()});this.loadPanelObjects.push(l);const a=this.add.rectangle(n,t/2,500,o,m.PANEL_DARK).setOrigin(.5);a.setStrokeStyle(2,m.GOLD),this.loadPanelObjects.push(a);const c=this.add.rectangle(n,i,500,44,m.PRIMARY).setOrigin(.5,0);this.loadPanelObjects.push(c);const h=this.add.text(n,i+22,"セーブデータを選択",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);this.loadPanelObjects.push(h);for(let y=0;y<W;y++){const g=i+64+y*76,f=s.find(b=>b.slotId===`slot_${y+1}`);f?this.createSlotRow(n,g,f):this.createEmptySlotRow(n,g,`slot_${y+1}`)}const u=this.add.text(n,i+o-22,"✕ 閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#aaaaaa"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.hideLoadPanel());this.loadPanelObjects.push(u)}createSlotRow(e,t,n){const s=new Date(n.savedAt).toLocaleDateString("ja-JP"),o=n.playerNames.join("・"),i=this.add.rectangle(e,t,460,68,1981023).setOrigin(.5).setStrokeStyle(1,3359880).setInteractive({useHandCursor:!0});i.on("pointerover",()=>i.setFillStyle(2771568)),i.on("pointerout",()=>i.setFillStyle(1981023)),i.on("pointerdown",()=>this.loadGame(n.slotId)),this.loadPanelObjects.push(i);const l=this.add.text(e-210,t-14,`${n.currentYear}年目 / ${n.totalYears}年間`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(0,.5);this.loadPanelObjects.push(l);const a=this.add.text(e-210,t+10,o,{fontFamily:d.PRIMARY,fontSize:12,color:"#aabbcc"}).setOrigin(0,.5);this.loadPanelObjects.push(a);const c=this.add.text(e+210,t,s,{fontFamily:d.PRIMARY,fontSize:11,color:"#778899"}).setOrigin(1,.5);this.loadPanelObjects.push(c);const h=this.add.text(e+175,t-20,"×",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#e74c3c"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",u=>{u.event.stopPropagation(),this.saveManager.deleteSlot(n.slotId),this.showLoadPanel()});this.loadPanelObjects.push(h)}createEmptySlotRow(e,t,n){const s=this.add.rectangle(e,t,460,68,1318448).setOrigin(.5).setStrokeStyle(1,2241365);this.loadPanelObjects.push(s);const o=this.add.text(e,t,"--- 空きスロット ---",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#445566"}).setOrigin(.5);this.loadPanelObjects.push(o)}hideLoadPanel(){this.loadPanelObjects.forEach(e=>e.destroy()),this.loadPanelObjects=[],this.isLoadPanelVisible=!1}loadGame(e){const t=this.saveManager.load(e);t&&(this.hideLoadPanel(),this.scene.start(A.GAME,{gameState:t.gameState,saveSlotId:e}))}createButton(e,t,n,s,o){const i=this.add.rectangle(e,t,280,56,s).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,t,n,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(1);const l=Math.max(0,s-2236962);i.on("pointerover",()=>{i.setFillStyle(l),i.setScale(1.03)}),i.on("pointerout",()=>{i.setFillStyle(s),i.setScale(1)}),i.on("pointerdown",o)}}const Z=[15158332,3447003,3066993,15965202],ae=["赤","青","緑","黄"];class le extends T.Scene{constructor(){super({key:A.PLAYER_SETUP});M(this,"totalYears",10);M(this,"playerConfigs",[{name:"プレイヤー1",type:"human",difficulty:"normal"},{name:"CPU2",type:"cpu",difficulty:"normal"},{name:"CPU3",type:"cpu",difficulty:"normal"},{name:"CPU4",type:"cpu",difficulty:"normal"}]);M(this,"playerCount",2);M(this,"yearText");M(this,"playerRows",[])}create(){const{width:e,height:t}=this.scale;this.add.rectangle(0,0,e,t,m.HUD_BG).setOrigin(0),this.add.rectangle(0,0,e,56,m.PRIMARY).setOrigin(0),this.add.text(e/2,28,"プレイヤー設定",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5),this.add.text(20,28,"← 戻る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffdddd"}).setOrigin(0,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.scene.start(A.TITLE)),this.createYearSelector(e/2,100);for(let n=0;n<D.MAX_PLAYERS;n++)this.createPlayerRow(n,160+n*118);this.createStartButton(e/2,t-50)}createYearSelector(e,t){this.add.text(e-130,t,"年数：",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(0,.5),this.createSmallButton(e-20,t,"-",()=>{this.totalYears>1&&(this.totalYears--,this.yearText.setText(`${this.totalYears}年`))}),this.yearText=this.add.text(e+40,t,`${this.totalYears}年`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}).setOrigin(.5),this.createSmallButton(e+100,t,"+",()=>{this.totalYears<99&&(this.totalYears++,this.yearText.setText(`${this.totalYears}年`))})}createPlayerRow(e,t){const{width:n}=this.scale,s=e<this.playerCount,o=this.playerConfigs[e],i={index:e,y:t,objects:[]},l=this.add.rectangle(n/2,t+50,n-40,108,s?m.PANEL_DARK:857381).setOrigin(.5).setStrokeStyle(s?2:0,Z[e]);i.objects.push(l);const a=this.add.rectangle(20,t+6,4,100,Z[e],s?1:.3).setOrigin(0);i.objects.push(a);const c=this.add.circle(52,t+50,14,Z[e],s?1:.3);i.objects.push(c);const h=this.add.text(76,t+50,`P${e+1} ${ae[e]}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:s?"#ffffff":"#445566",fontStyle:"bold"}).setOrigin(0,.5);if(i.objects.push(h),e>=2){const w=this.add.text(n-24,t+24,s?"✕ 外す":"＋ 追加",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:s?"#ff6666":"#44cc88"}).setOrigin(1,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.togglePlayer(e));i.objects.push(w)}const u=this.add.text(76,t+76,(o==null?void 0:o.name)??`P${e+1}`,{fontFamily:d.PRIMARY,fontSize:12,color:s?"#aabbcc":"#334455"}).setOrigin(0,.5);i.objects.push(u);const y=(o==null?void 0:o.type)==="human"?2600544:2719929,g=this.add.text(260,t+50,(o==null?void 0:o.type)==="human"?"人間":"CPU",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:s?"#ffffff":"#445566",backgroundColor:s?"#"+y.toString(16).padStart(6,"0"):"#223344",padding:{x:12,y:5}}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.toggleType(e));i.objects.push(g);const f=["やさしい","ふつう","むずかしい"],b=["easy","normal","hard"];f.map((w,p)=>{const I=s&&(o==null?void 0:o.type)==="cpu"&&o.difficulty===b[p];return this.add.text(420+p*118,t+50,w,{fontFamily:d.PRIMARY,fontSize:12,color:s&&(o==null?void 0:o.type)==="cpu"?I?"#000000":"#aabbcc":"#334455",backgroundColor:I?"#"+m.SECONDARY.toString(16).padStart(6,"0"):"#1a2a3a",padding:{x:8,y:5}}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.setDifficulty(e,b[p]))}).forEach(w=>i.objects.push(w)),s||c.setAlpha(.3),this.playerRows.push(i)}togglePlayer(e){e<2||(this.playerCount>e?this.playerCount=e:this.playerCount=e+1,this.rebuildRows())}toggleType(e){if(e>=this.playerCount)return;const t=this.playerConfigs[e];t.type=t.type==="human"?"cpu":"human",this.rebuildRows()}setDifficulty(e,t){e>=this.playerCount||(this.playerConfigs[e].difficulty=t,this.rebuildRows())}rebuildRows(){this.playerRows.forEach(e=>e.objects.forEach(t=>t.destroy())),this.playerRows=[];for(let e=0;e<D.MAX_PLAYERS;e++)this.createPlayerRow(e,160+e*118)}createStartButton(e,t){const n=this.add.rectangle(e,t,300,56,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),s=this.add.text(e,t,"ゲームスタート！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5);n.on("pointerover",()=>{n.setFillStyle(13369344),n.setScale(1.03)}),n.on("pointerout",()=>{n.setFillStyle(m.PRIMARY),n.setScale(1)}),n.on("pointerdown",()=>{const o={totalYears:this.totalYears,players:this.playerConfigs.slice(0,this.playerCount)};this.scene.start(A.GAME,{gameConfig:o})}),s.setDepth(1)}createSmallButton(e,t,n,s){const o=this.add.rectangle(e,t,38,38,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,t,n,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),o.on("pointerover",()=>o.setFillStyle(13369344)),o.on("pointerout",()=>o.setFillStyle(m.PRIMARY)),o.on("pointerdown",s)}}const ce={minLat:24,maxLat:46,minLng:122,maxLng:147};function U(P,r,e){const{minLat:t,maxLat:n,minLng:s,maxLng:o}=ce,i=e.x+(r-s)/(o-s)*e.width,l=e.y+(1-(P-t)/(n-t))*e.height;return{x:i,y:l}}function de(P,r,e){return{x:P.x+(r.x-P.x)*e,y:P.y+(r.y-P.y)*e}}function he(P,r,e){const t=[];for(let n=0;n<e;n++){const s=(n+1)/(e+1);t.push(de(P,r,s))}return t}class ye{constructor(){M(this,"cities",new Map);M(this,"routes",[]);M(this,"cityRoutes",new Map)}loadData(r){var e,t;this.cities.clear(),this.routes=r.routes,this.cityRoutes.clear();for(const n of r.cities)this.cities.set(n.id,n),this.cityRoutes.set(n.id,[]);for(const n of r.routes)(e=this.cityRoutes.get(n.fromCityId))==null||e.push(n),(t=this.cityRoutes.get(n.toCityId))==null||t.push(n)}getCityById(r){return this.cities.get(r)}getAllCities(){return Array.from(this.cities.values())}getAllRoutes(){return this.routes}getRoutesFromCity(r){return this.cityRoutes.get(r)??[]}getAdjacentCities(r){return this.getRoutesFromCity(r).map(n=>n.fromCityId===r?n.toCityId:n.fromCityId).map(n=>this.cities.get(n)).filter(n=>n!==void 0)}getOtherCityId(r,e){return r.fromCityId===e?r.toCityId:r.fromCityId}getCityCanvasPos(r,e){const t=this.cities.get(r);if(t)return U(t.lat,t.lng,e)}getAllSquarePositions(r){const e=[];for(const t of this.routes){const n=this.cities.get(t.fromCityId),s=this.cities.get(t.toCityId);if(!n||!s)continue;const o=U(n.lat,n.lng,r),i=U(s.lat,s.lng,r),l=he(o,i,t.squares.length);for(let a=0;a<t.squares.length;a++)e.push({routeId:t.id,squareIndex:a,x:l[a].x,y:l[a].y,type:t.squares[a]})}return e}getRandomDestination(r){const e=Array.from(this.cities.values()).filter(t=>t.id!==r);if(e.length!==0)return e[Math.floor(Math.random()*e.length)]}}class ue{getPropertiesByCity(r,e){return r.filter(t=>t.cityId===e)}getOwnedProperties(r,e){return r.filter(t=>t.ownerId===e)}hasMonopoly(r,e,t){const n=r.filter(s=>s.cityId===e);return n.length>0&&n.every(s=>s.ownerId===t)}buyProperty(r,e,t){const n=r.players.find(c=>c.id===e),s=r.properties.find(c=>c.id===t);if(!n||!s)return{success:!1,reason:"not_enough_money"};if(s.ownerId!==null)return{success:!1,reason:"already_owned"};const o=this.getCurrentPrice(s);if(n.money<o)return{success:!1,reason:"not_enough_money"};const i=r.players.map(c=>c.id===e?{...c,money:c.money-o}:c),l=r.properties.map(c=>c.id===t?{...c,ownerId:e}:c),a={...r,players:i,properties:l};return{success:!0,newState:this.recalcTotalAssets(a)}}upgradeProperty(r,e,t){const n=r.players.find(c=>c.id===e),s=r.properties.find(c=>c.id===t);if(!n||!s||s.ownerId!==e)return{success:!1};if(s.upgradeLevel>=s.upgradePrices.length)return{success:!1};const o=s.upgradePrices[s.upgradeLevel];if(n.money<o)return{success:!1,reason:"not_enough_money"};const i=r.players.map(c=>c.id===e?{...c,money:c.money-o}:c),l=r.properties.map(c=>c.id===t?{...c,upgradeLevel:c.upgradeLevel+1}:c),a={...r,players:i,properties:l};return{success:!0,newState:this.recalcTotalAssets(a)}}payLandFee(r,e,t){const n=r.players.find(a=>a.id===e),s=r.properties.find(a=>a.id===t);if(!n||!s||!s.ownerId||s.ownerId===e)return r;const o=this.getLandFee(s),i=Math.min(o,n.money),l=r.players.map(a=>a.id===e?{...a,money:a.money-i}:a.id===s.ownerId?{...a,money:a.money+i}:a);return this.recalcTotalAssets({...r,players:l})}calcYearEndIncome(r){const e=[];let t=[...r.players];for(const s of r.players){const o=this.calcPlayerAnnualIncome(r.properties,s.id),i=s.incomeMultiplier??1,l={...o,totalIncome:Math.floor(o.totalIncome*i)};e.push(l),t=t.map(a=>a.id===s.id?{...a,money:a.money+l.totalIncome,incomeMultiplier:1}:a)}return{newState:this.recalcTotalAssets({...r,players:t}),results:e}}calcPlayerAnnualIncome(r,e){const t=this.getOwnedProperties(r,e);if(t.length===0)return{playerId:e,propertyIncome:0,monopolyBonus:0,totalIncome:0};const n=new Map;for(const i of t){const l=n.get(i.cityId)??[];l.push(i),n.set(i.cityId,l)}let s=0,o=0;for(const[i,l]of n){const a=l.reduce((u,y)=>u+this.getCurrentIncome(y),0);s+=a;const c=r.filter(u=>u.cityId===i);c.length>0&&c.every(u=>u.ownerId===e)&&(o+=a)}return{playerId:e,propertyIncome:s,monopolyBonus:o,totalIncome:s+o}}getCurrentPrice(r){return r.price}getCurrentIncome(r){return r.upgradeLevel===0?r.income:r.upgradeIncomes[r.upgradeLevel-1]??r.income}getLandFee(r){return Math.floor(this.getCurrentIncome(r)*.5)}sellPropertyForcibly(r,e,t){const n=r.players.find(a=>a.id===e),s=r.properties.find(a=>a.id===t);if(!n||!s||s.ownerId!==e)return r;const o=Math.floor(s.price*.5),i=r.players.map(a=>a.id===e?{...a,money:a.money+o}:a),l=r.properties.map(a=>a.id===t?{...a,ownerId:null,upgradeLevel:0}:a);return this.recalcTotalAssets({...r,players:i,properties:l})}recalcTotalAssets(r){const e=r.players.map(t=>{const n=r.properties.filter(s=>s.ownerId===t.id).reduce((s,o)=>s+o.price,0);return{...t,totalAssets:t.money+n}});return{...r,players:e}}getLastPlacePlayerId(r){return r.reduce((e,t)=>t.totalAssets<e.totalAssets?t:e).id}}function V(P,r){return Math.floor(Math.random()*(r-P+1))+P}function q(){return V(1,6)}function k(P){return P[V(0,P.length-1)]}function fe(P,r){const e=[...P],t=[],n=Math.min(r,e.length);for(let s=0;s<n;s++){const o=V(0,e.length-1);t.push(e[o]),e.splice(o,1)}return t}function pe(P,r){const e=r.reduce((n,s)=>n+s,0);let t=Math.random()*e;for(let n=0;n<P.length;n++)if(t-=r[n],t<=0)return P[n];return P[P.length-1]}const ge={common:60,uncommon:30,rare:10};class me{constructor(){M(this,"allCards",[])}loadCards(r){this.allCards=r}getCardById(r){return this.allCards.find(e=>e.id===r)}getAllCards(){return this.allCards}getCardsByType(r){return this.allCards.filter(e=>e.type===r)}canDrawCard(r,e){const t=r.players.find(n=>n.id===e);return t?t.hand.length<D.MAX_CARD_COUNT:!1}drawRandomCard(){if(this.allCards.length===0)return;const r=this.allCards.map(e=>ge[e.rarity]??10);return pe(this.allCards,r)}gainCard(r,e){if(!this.canDrawCard(r,e))return{newState:r,card:null};const t=this.drawRandomCard();if(!t)return{newState:r,card:null};const n=r.players.map(s=>s.id===e?{...s,hand:[...s.hand,t.id]}:s);return{newState:{...r,players:n},card:t}}buyCard(r,e,t){const n=r.players.find(l=>l.id===e),s=this.getCardById(t);if(!n||!s)return{newState:r,success:!1,reason:"not_found"};if(!this.canDrawCard(r,e))return{newState:r,success:!1,reason:"hand_full"};const o=this.getCardShopPrice(s);if(n.money<o)return{newState:r,success:!1,reason:"not_enough_money"};const i=r.players.map(l=>l.id===e?{...l,money:l.money-o,hand:[...l.hand,s.id]}:l);return{newState:{...r,players:i},success:!0}}getCardShopPrice(r){return{common:500,uncommon:1500,rare:5e3}[r.rarity]??1e3}useCard(r,e,t,n={}){const s=r.players.find(l=>l.id===e),o=this.getCardById(t);if(!s||!o)return{success:!1,reason:"not_found"};if(!s.hand.includes(t))return{success:!1,reason:"not_owner"};const i=l=>({...l,players:l.players.map(a=>a.id===e?{...a,hand:a.hand.filter(c=>c!==t)}:a)});switch(o.type){case"move_to_destination":return this.useMoveToDest(i(r),e,o);case"get_money":return this.useGetMoney(i(r),e,o);case"pay_money":return this.usePayMoney(i(r),e,o);case"bombee_transfer":return o.effect.targetType==="last_to_second"?this.useBombeeTransferLastToSecond(i(r)):n.targetPlayerId?this.useBombeeTransfer(i(r),e,n.targetPlayerId):{success:!1,reason:"no_target"};case"card_steal":return n.targetPlayerId?this.useCardSteal(i(r),e,n.targetPlayerId,n.targetCardId):{success:!1,reason:"no_target"};case"move_to_city":return this.useMoveToCity(i(r),e,o);case"bombee_away":return this.useBombeeAway(i(r),e,o);case"sell_property":return this.useSellProperty(i(r),e,o,n.targetPropertyId,n.targetPlayerId,n.targetCityId);case"steal_property":return this.useStealProperty(i(r),e,o,n.targetCityId);case"monopoly_break":return this.useMonopolyBreak(i(r),e,o);case"buy_property":return this.useBuyProperty(i(r),e,o,n.targetCityId);case"double_income":return this.useDoubleIncome(i(r),e,o);case"move_steps":case"plus_dice":return{success:!0,newState:i(r),message:`${o.name} を使用しました`};default:return{success:!0,newState:i(r),message:`${o.name} を使用しました`}}}useMoveToDest(r,e,t){if(t.effect.targetType==="double_move_next_turn"){const s=t.effect.value??2;return{success:!0,newState:{...r,players:r.players.map(i=>i.id===e?{...i,diceMultiplier:s}:i)},message:`${t.name}！次のターンのサイコロが${s}倍になります！`}}return{success:!0,newState:{...r,players:r.players.map(s=>s.id===e?{...s,position:{...s.position,cityId:r.destinationCityId}}:s)},message:`${t.name}！目的地へ向かいます`}}useGetMoney(r,e,t){const n=t.effect.value??1e3,s=t.effect.targetType;if(s==="property_value_percent"){const i=r.properties.filter(a=>a.ownerId===e).reduce((a,c)=>a+c.price,0),l=Math.floor(i*n/100);return{success:!0,newState:{...r,players:r.players.map(a=>a.id===e?{...a,money:a.money+l,totalAssets:a.totalAssets+l}:a)},message:`${t.name}！${l}万円を獲得しました`}}if(s==="all_players_each"){let i=0,l=[...r.players];for(const a of r.players.filter(c=>c.id!==e)){const c=Math.min(n,a.money);i+=c,l=l.map(h=>h.id===a.id?{...h,money:h.money-c,totalAssets:h.totalAssets-c}:h)}return l=l.map(a=>a.id===e?{...a,money:a.money+i,totalAssets:a.totalAssets+i}:a),{success:!0,newState:{...r,players:l},message:`${t.name}！全員から合計${i}万円受け取りました！`}}return{success:!0,newState:{...r,players:r.players.map(i=>i.id===e?{...i,money:i.money+n,totalAssets:i.totalAssets+n}:i)},message:`${t.name}！${n}万円を獲得しました`}}usePayMoney(r,e,t){const n=t.effect.value??1e3,s=r.players.find(a=>a.id===e),o=t.effect.targetType;if(o==="property_value_percent"){const a=r.properties.filter(h=>h.ownerId===e).reduce((h,u)=>h+u.price,0),c=Math.min(Math.floor(a*n/100),s.money);return{success:!0,newState:{...r,players:r.players.map(h=>h.id===e?{...h,money:h.money-c,totalAssets:h.totalAssets-c}:h)},message:`${t.name}！修繕費${c}万円を支払いました`}}if(o==="total_assets_percent"){const a=Math.min(Math.floor(s.totalAssets*n/100),s.money);return{success:!0,newState:{...r,players:r.players.map(c=>c.id===e?{...c,money:c.money-a,totalAssets:c.totalAssets-a}:c)},message:`${t.name}！税金${a}万円を支払いました`}}if(o==="all_players_each"){const a=r.players.filter(y=>y.id!==e);let c=0,h=s.money,u=[...r.players];for(const y of a){if(h<=0)break;const g=Math.min(n,h);c+=g,h-=g,u=u.map(f=>f.id===y.id?{...f,money:f.money+g,totalAssets:f.totalAssets+g}:f)}return u=u.map(y=>y.id===e?{...y,money:y.money-c,totalAssets:y.totalAssets-c}:y),{success:!0,newState:{...r,players:u},message:`${t.name}！全員に合計${c}万円支払いました`}}const i=Math.min(n,s.money);return{success:!0,newState:{...r,players:r.players.map(a=>a.id===e?{...a,money:a.money-i,totalAssets:a.totalAssets-i}:a)},message:`${t.name}！${i}万円を支払いました`}}useBombeeTransfer(r,e,t){const n=r.players.find(i=>i.id===e),s=r.players.find(i=>i.id===t);return!n||!s?{success:!1,reason:"no_target"}:n.bombeeType==="none"?{success:!1,reason:"no_target"}:{success:!0,newState:{...r,players:r.players.map(i=>i.id===e?{...i,bombeeType:"none",bombeeElapsedTurns:0}:i.id===t?{...i,bombeeType:n.bombeeType,bombeeElapsedTurns:0}:i)},message:`ボンビーを ${s.name} へ移しました！`}}useCardSteal(r,e,t,n){const s=r.players.find(c=>c.id===e),o=r.players.find(c=>c.id===t);if(!o||o.hand.length===0)return{success:!1,reason:"no_target"};if(s&&s.hand.length>=D.MAX_CARD_COUNT)return{success:!1,reason:"hand_full"};const i=n&&o.hand.includes(n)?n:k(o.hand),l={...r,players:r.players.map(c=>c.id===e?{...c,hand:[...c.hand,i]}:c.id===t?{...c,hand:c.hand.filter(h=>h!==i)}:c)},a=this.getCardById(i);return{success:!0,newState:l,message:`${o.name} から「${(a==null?void 0:a.name)??"???"}」を奪いました！`}}useMoveToCity(r,e,t){const n=t.effect.targetType??"tokyo";return{success:!0,newState:{...r,players:r.players.map(o=>o.id===e?{...o,position:{...o.position,cityId:n}}:o)},message:`${t.name}！移動します`}}useBombeeAway(r,e,t){const n=r.players.find(a=>a.id===e);if(!n||n.bombeeType==="none")return{success:!0,newState:r,message:"ボンビーがついていません"};const s=t.effect.targetType==="self_permanent",o=s?t.effect.value??1:0,i={...r,players:r.players.map(a=>a.id===e?{...a,bombeeType:"none",bombeeElapsedTurns:0,bombeeImmuneYears:o}:a)},l=s?`${t.name}！ボンビーを追い払い、${o}年間寄せつけません！`:`${t.name}！ボンビーを追い払いました！`;return{success:!0,newState:i,message:l}}useBombeeTransferLastToSecond(r){const e=[...r.players].sort((o,i)=>o.totalAssets-i.totalAssets);if(e.length<2)return{success:!1,reason:"no_target"};const t=e[0],n=e[1];return t.bombeeType==="none"?{success:!1,reason:"no_target"}:{success:!0,newState:{...r,players:r.players.map(o=>o.id===t.id?{...o,bombeeType:"none",bombeeElapsedTurns:0}:o.id===n.id?{...o,bombeeType:t.bombeeType,bombeeElapsedTurns:0}:o)},message:`ボンビーが${t.name}から${n.name}へ強制移動しました！`}}useSellProperty(r,e,t,n,s,o){const i=(t.effect.value??100)/100;if(t.effect.targetType==="current_city_all"&&o){const y=r.properties.filter(S=>S.cityId===o&&S.ownerId===e);if(y.length===0)return{success:!1,reason:"no_target"};let g=0,f=[...r.properties];for(const S of y)g+=Math.floor(S.price*i),f=f.map(w=>w.id===S.id?{...w,ownerId:null,upgradeLevel:0}:w);const b=r.players.map(S=>S.id===e?{...S,money:S.money+g}:S);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:b,properties:f}),message:`現在地の物件${y.length}件を${g}万円で売却しました！`}}if(t.effect.targetType==="opponent_forced"&&s){const y=r.properties.filter(p=>p.ownerId===s);if(y.length===0)return{success:!1,reason:"no_target"};const g=y.reduce((p,I)=>I.price<p.price?I:p),f=Math.floor(g.price*i),b=r.players.map(p=>p.id===s?{...p,money:p.money+f}:p),S=r.properties.map(p=>p.id===g.id?{...p,ownerId:null,upgradeLevel:0}:p),w=r.players.find(p=>p.id===s);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:b,properties:S}),message:`${w==null?void 0:w.name}の「${g.name}」を強制売却させました！`}}const l=r.properties.filter(y=>y.ownerId===e);if(l.length===0)return{success:!1,reason:"no_target"};const a=(n?l.find(y=>y.id===n):null)??l[0],c=Math.floor(a.price*i),h=r.players.map(y=>y.id===e?{...y,money:y.money+c}:y),u=r.properties.map(y=>y.id===a.id?{...y,ownerId:null,upgradeLevel:0}:y);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:h,properties:u}),message:`「${a.name}」を${c}万円で売却しました`}}useStealProperty(r,e,t,n){if(t.effect.targetType==="current_city_all"&&n){const c=r.properties.filter(u=>u.cityId===n&&u.ownerId!==null&&u.ownerId!==e);if(c.length===0)return{success:!1,reason:"no_target"};const h=r.properties.map(u=>c.find(y=>y.id===u.id)?{...u,ownerId:e}:u);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,properties:h}),message:`現在地の物件${c.length}件を奪い取りました！`}}const s=r.players.filter(c=>c.id!==e);if(s.length===0)return{success:!1,reason:"no_target"};const o=s.reduce((c,h)=>h.totalAssets>c.totalAssets?h:c),i=r.properties.filter(c=>c.ownerId===o.id);if(i.length===0)return{success:!1,reason:"no_target"};const l=i.reduce((c,h)=>h.price<c.price?h:c),a=r.properties.map(c=>c.id===l.id?{...c,ownerId:e}:c);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,properties:a}),message:`「${l.name}」を${o.name}から奪い取りました！`}}useMonopolyBreak(r,e,t){const n=r.players.filter(i=>i.id!==e).map(i=>i.id),s=[...new Set(r.properties.map(i=>i.cityId))];for(const i of s){const l=r.properties.filter(a=>a.cityId===i);if(l.length!==0){for(const a of n)if(l.every(c=>c.ownerId===a)){const c=l.reduce((f,b)=>b.price<f.price?b:f),h=Math.floor(c.price*.8),u=r.players.map(f=>f.id===a?{...f,money:f.money+h}:f),y=r.properties.map(f=>f.id===c.id?{...f,ownerId:null,upgradeLevel:0}:f),g=r.players.find(f=>f.id===a);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:u,properties:y}),message:`${g==null?void 0:g.name}の「${c.name}」の独占を崩しました！(${h}万円返却)`}}}}let o=null;for(const i of s){const l=r.properties.filter(a=>a.cityId===i);if(!(l.length<=1))for(const a of n){const h=l.filter(u=>u.ownerId===a).length/l.length;if(h>0&&h<1&&(!o||h>o.ratio)){const u=l.find(y=>y.ownerId===a);o={oppId:a,prop:u,ratio:h}}}}if(o){const i=Math.floor(o.prop.price*.8),l=r.players.map(h=>h.id===o.oppId?{...h,money:h.money+i}:h),a=r.properties.map(h=>h.id===o.prop.id?{...h,ownerId:null,upgradeLevel:0}:h),c=r.players.find(h=>h.id===o.oppId);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:l,properties:a}),message:`${c==null?void 0:c.name}の「${o.prop.name}」を市場に戻しました！`}}return{success:!1,reason:"no_target"}}useBuyProperty(r,e,t,n){const s=r.players.find(i=>i.id===e);if(!s)return{success:!1,reason:"not_found"};const o=t.effect.targetType;if(o==="current_city_free_one"&&n){const i=r.properties.find(a=>a.cityId===n&&a.ownerId===null);if(!i)return{success:!1,reason:"no_target"};const l=r.properties.map(a=>a.id===i.id?{...a,ownerId:e}:a);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,properties:l}),message:`「${i.name}」を無料で入手しました！`}}if(o==="any_location"){const i=r.properties.filter(c=>c.ownerId===null&&s.money>=c.price).sort((c,h)=>c.price-h.price)[0];if(!i)return{success:!1,reason:"no_target"};const l=r.players.map(c=>c.id===e?{...c,money:c.money-i.price}:c),a=r.properties.map(c=>c.id===i.id?{...c,ownerId:e}:c);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:l,properties:a}),message:`「${i.name}」を購入しました！(${i.price}万円)`}}if(n){const i=t.effect.value??0,l=i/100,a=r.properties.filter(y=>y.cityId===n&&y.ownerId===null).sort((y,g)=>y.price-g.price)[0];if(!a)return{success:!1,reason:"no_target"};const c=Math.floor(a.price*(1-l));if(s.money<c)return{success:!1,reason:"no_target"};const h=r.players.map(y=>y.id===e?{...y,money:y.money-c}:y),u=r.properties.map(y=>y.id===a.id?{...y,ownerId:e}:y);return{success:!0,newState:this.recalcTotalAssetsLocal({...r,players:h,properties:u}),message:`「${a.name}」を${i}%割引で購入しました！(${c}万円)`}}return{success:!1,reason:"no_target"}}useDoubleIncome(r,e,t){const n=t.effect.value??2;if(t.effect.targetType==="one_month"){const i=r.properties.filter(c=>c.ownerId===e).reduce((c,h)=>{const u=h.upgradeLevel===0?h.income:h.upgradeIncomes[h.upgradeLevel-1]??h.income;return c+Math.floor(u/12)},0),l=Math.floor(i*n);return{success:!0,newState:{...r,players:r.players.map(c=>c.id===e?{...c,money:c.money+l,totalAssets:c.totalAssets+l}:c)},message:`今月の収益が${n}倍！${l}万円を即座に獲得しました！`}}return{success:!0,newState:{...r,players:r.players.map(o=>o.id===e?{...o,incomeMultiplier:n}:o)},message:`次の年末決算まで収益が${n}倍になります！`}}recalcTotalAssetsLocal(r){const e=r.players.map(t=>{const n=r.properties.filter(s=>s.ownerId===t.id).reduce((s,o)=>s+o.price,0);return{...t,totalAssets:t.money+n}});return{...r,players:e}}getShopLineup(r=5){return this.allCards.length<=r?[...this.allCards]:fe(this.allCards,r)}getPlayerHand(r,e){const t=r.players.find(n=>n.id===e);return t?t.hand.map(n=>this.getCardById(n)).filter(n=>n!==void 0):[]}discardCard(r,e,t){return{...r,players:r.players.map(n=>n.id===e?{...n,hand:n.hand.filter(s=>s!==t)}:n)}}}class Se{attachBombeeToLastPlace(r){if(r.players.some(o=>o.bombeeType!=="none")||r.players.length<2)return r;const t=this.getLastPlacePlayer(r.players);if(!t)return r;const s=this.getLastPlacePlayer(r.players.filter(o=>!(o.bombeeImmuneYears&&o.bombeeImmuneYears>0)))??t;return{...r,players:r.players.map(o=>o.id===s.id?{...o,bombeeType:"mini",bombeeElapsedTurns:0}:o)}}decrementBombeeImmunity(r){return{...r,players:r.players.map(e=>(e.bombeeImmuneYears??0)>0?{...e,bombeeImmuneYears:e.bombeeImmuneYears-1}:e)}}processBombeeAction(r){const e=r.players.find(l=>l.bombeeType!=="none");if(!e)return{newState:r,message:""};const t=e.bombeeElapsedTurns+1,n=this.checkEvolution(e.bombeeType,t);let s={...r,players:r.players.map(l=>l.id===e.id?{...l,bombeeType:n,bombeeElapsedTurns:t}:l)};const o=this.executeBombeeEffect(s,e.id,n);s=o.newState,s=this.maybeMoveToLastPlace(s,e.id);let i=o.message;return n!==e.bombeeType&&(i=`ボンビーが ${this.getBombeeName(n)} に進化！
`+i),{newState:s,message:i}}checkEvolution(r,e){return r==="mini"&&e>=K.MINI_TO_NORMAL_TURNS?"normal":r==="normal"&&e>=K.NORMAL_TO_KING_TURNS?"king":r}executeBombeeEffect(r,e,t){const n=r.players.find(s=>s.id===e);if(!n)return{newState:r,message:""};switch(t){case"mini":return this.miniAction(r,n);case"normal":return this.normalAction(r,n);case"king":return this.kingAction(r,n);default:return{newState:r,message:""}}}miniAction(r,e){const t=Math.random()*.1+.05,n=Math.max(100,Math.floor(e.money*t)),s=Math.min(n,e.money);return s<=0?{newState:r,message:"ミニボンビーが現れたが、お金がなかった！"}:{newState:{...r,players:r.players.map(i=>i.id===e.id?{...i,money:i.money-s,totalAssets:i.totalAssets-s}:i)},message:`ミニボンビー：${e.name} から ${s}万円を奪った！`}}normalAction(r,e){const t=r.properties.filter(l=>l.ownerId===e.id);if(t.length>0&&Math.random()<.5){const l=k(t),a=Math.floor(l.price*.7);return{newState:{...r,players:r.players.map(h=>h.id!==e.id?h:{...h,money:h.money+a,totalAssets:h.totalAssets-(l.price-a)}),properties:r.properties.map(h=>h.id===l.id?{...h,ownerId:null}:h)},message:`ボンビー：${e.name} の「${l.name}」を売却した！（${a}万円）`}}const n=Math.random()*.2+.2,s=Math.max(500,Math.floor(e.money*n)),o=Math.min(s,e.money);return o<=0?{newState:r,message:"ボンビーが現れたが、お金がなかった！"}:{newState:{...r,players:r.players.map(l=>l.id!==e.id?l:{...l,money:l.money-o,totalAssets:l.totalAssets-o})},message:`ボンビー：${e.name} から ${o}万円を奪った！`}}kingAction(r,e){const n=k([...["sell_all","steal_big","affect_all"]]);if(n==="sell_all"){const s=r.properties.filter(l=>l.ownerId===e.id).slice(0,3);if(s.length===0)return this.kingStealBig(r,e);let o=0,i={...r};for(const l of s)o+=Math.floor(l.price*.3),i={...i,properties:i.properties.map(a=>a.id===l.id?{...a,ownerId:null}:a)};return i={...i,players:i.players.map(l=>l.id!==e.id?l:{...l,money:Math.max(0,l.money-o),totalAssets:Math.max(0,l.totalAssets-o*2)})},{newState:i,message:`キングボンビー：${e.name} の物件 ${s.length} 件を強制売却！`}}if(n==="affect_all"){let s={...r};return s={...s,players:s.players.map(o=>{const i=Math.max(100,Math.floor(o.money*.1)),l=Math.min(i,o.money);return{...o,money:o.money-l,totalAssets:o.totalAssets-l}})},{newState:s,message:"キングボンビー：全員から10%ずつ奪った！"}}return this.kingStealBig(r,e)}kingStealBig(r,e){const t=Math.random()*.2+.4,n=Math.max(2e3,Math.floor(e.money*t)),s=Math.min(n,e.money);return s<=0?{newState:r,message:"キングボンビーが現れたが、お金がなかった！"}:{newState:{...r,players:r.players.map(i=>i.id!==e.id?i:{...i,money:i.money-s,totalAssets:i.totalAssets-s})},message:`キングボンビー：${e.name} から ${s}万円を強奪！`}}maybeMoveToLastPlace(r,e){const t=r.players.filter(o=>o.id!==e&&!(o.bombeeImmuneYears&&o.bombeeImmuneYears>0)),n=this.getLastPlacePlayer(t);if(!n)return r;const s=r.players.find(o=>o.id===e);return!s||s.totalAssets<=n.totalAssets?r:Math.random()<.75?{...r,players:r.players.map(o=>o.id===e?{...o,bombeeType:"none",bombeeElapsedTurns:0}:o.id===n.id?{...o,bombeeType:(s==null?void 0:s.bombeeType)??"mini",bombeeElapsedTurns:0}:o)}:r}getLastPlacePlayer(r){if(r.length!==0)return r.reduce((e,t)=>t.totalAssets<e.totalAssets?t:e)}removeBombee(r,e){return{...r,players:r.players.map(t=>t.id===e?{...t,bombeeType:"none",bombeeElapsedTurns:0}:t)}}getBombeeName(r){return{none:"なし",mini:"ミニボンビー",normal:"ボンビー",king:"キングボンビー"}[r]}getBombeePlayer(r){return r.players.find(e=>e.bombeeType!=="none")}}class be{constructor(){M(this,"allEvents",[])}loadEvents(r){this.allEvents=r}drawMonthlyEvents(r){const e=[];for(const t of this.allEvents){const{trigger:n}=t;if(t.type==="monthly"&&n.month===r){e.push(t);continue}t.type!=="monthly"&&Math.random()<n.probability&&e.push(t)}return e}applyEvent(r,e,t){const{effect:n}=e,s=[];let o={...r};switch(n.type){case"money_percent":o=this.applyMoneyPercent(r,n,t,s);break;case"money_fixed":o=this.applyMoneyFixed(r,n,t,s);break;case"property_income_bonus":o=this.applyPropertyIncomeBonus(r,n,s);break;case"all_money_equalizer":o=this.applyAllMoneyEqualizer(r,n,s);break;case"random_teleport":o=this.applyRandomTeleport(r,t);break}return{event:e,newState:o,affectedPlayers:s}}applyMoneyPercent(r,e,t,n){const s=(e.value??0)/100,o=this.resolveTargets(r,e.targetType,t),i=r.players.map(l=>{if(!o.includes(l.id))return l;const a=Math.floor(l.totalAssets*s),c=a<0?l.money>0?Math.max(-l.money,a):0:a;return n.push({playerId:l.id,delta:c}),{...l,money:l.money+c,totalAssets:l.totalAssets+c}});return{...r,players:i}}applyMoneyFixed(r,e,t,n){const s=e.value??0,o=this.resolveTargets(r,e.targetType,t),i=r.players.map(l=>{if(!o.includes(l.id))return l;const a=s<0?Math.max(s,-Math.max(0,l.money)):s;return n.push({playerId:l.id,delta:a}),{...l,money:l.money+a,totalAssets:l.totalAssets+a}});return{...r,players:i}}applyPropertyIncomeBonus(r,e,t){const n=(e.value??0)/100,s=r.players.map(o=>{const i=r.properties.filter(a=>a.ownerId===o.id);if(i.length===0)return o;const l=Math.floor(i.reduce((a,c)=>a+c.income,0)*n);return l===0?o:(t.push({playerId:o.id,delta:l}),{...o,money:o.money+l,totalAssets:o.totalAssets+l})});return{...r,players:s}}applyAllMoneyEqualizer(r,e,t){const n=e.value??0,s=r.players.map(o=>{const i=n<0?Math.max(n,-Math.max(0,o.money)):n;return t.push({playerId:o.id,delta:i}),{...o,money:o.money+i,totalAssets:o.totalAssets+i}});return{...r,players:s}}applyRandomTeleport(r,e){if(!e)return r;const t=[...new Set(r.properties.map(s=>s.cityId))];if(t.length===0)return r;const n=t[Math.floor(Math.random()*t.length)];return{...r,players:r.players.map(s=>s.id===e?{...s,position:{...s.position,cityId:n}}:s)}}resolveTargets(r,e,t){switch(e){case"all":return r.players.map(n=>n.id);case"self":return t?[t]:[];case"first_place":{const n=this.getFirstPlacePlayer(r.players);return n?[n.id]:[]}case"last_place":{const n=this.getLastPlacePlayer(r.players);return n?[n.id]:[]}default:return r.players.map(n=>n.id)}}getFirstPlacePlayer(r){if(r.length!==0)return r.reduce((e,t)=>t.totalAssets>e.totalAssets?t:e)}getLastPlacePlayer(r){if(r.length!==0)return r.reduce((e,t)=>t.totalAssets<e.totalAssets?t:e)}getAllEvents(){return this.allEvents}getEventById(r){return this.allEvents.find(e=>e.id===r)}}class Pe{constructor(r,e,t){M(this,"boardManager");M(this,"propertyManager");M(this,"cardManager");this.boardManager=r,this.propertyManager=e,this.cardManager=t}chooseRoute(r,e,t){if(t.length===1)return t[0];switch(e.difficulty){case"easy":return this.chooseRouteEasy(t);case"normal":return this.chooseRouteNormal(r,e,t);case"hard":return this.chooseRouteHard(r,e,t);default:return k(t)}}chooseRouteEasy(r){return k(r)}chooseRouteNormal(r,e,t){if(!this.boardManager.getCityById(r.destinationCityId))return k(t);const s=t.map(o=>({choice:o,score:this.estimateDistanceToDestination(o.nextCity.id,r.destinationCityId)}));return s.sort((o,i)=>o.score-i.score),s[0].choice}chooseRouteHard(r,e,t){const n=t.map(s=>{const o=this.estimateDistanceToDestination(s.nextCity.id,r.destinationCityId),i=this.calcCityPropertyValue(r,e.id,s.nextCity.id);return{choice:s,score:-o+i*.01}});return n.sort((s,o)=>o.score-s.score),n[0].choice}decidePurchase(r,e,t){switch(e.difficulty){case"easy":return this.decidePurchaseEasy(e,t);case"normal":return this.decidePurchaseNormal(r,e,t);case"hard":return this.decidePurchaseHard(r,e,t);default:return{type:"skip_property"}}}decidePurchaseEasy(r,e){const t=r.money>=e.price,n=e.price<=r.money*.5;return t&&n&&Math.random()<.5?{type:"buy_property",propertyId:e.id}:{type:"skip_property"}}decidePurchaseNormal(r,e,t){const n=this.propertyManager.getCurrentPrice(t);if(e.money<n)return{type:"skip_property"};const s=this.propertyManager.getCurrentIncome(t);if(s<=0)return{type:"skip_property"};const o=n/s,i=r.totalYears-r.currentYear;return o<=i*.8?{type:"buy_property",propertyId:t.id}:this.canMonopolize(r,e.id,t.cityId)?{type:"buy_property",propertyId:t.id}:{type:"skip_property"}}decidePurchaseHard(r,e,t){const n=this.propertyManager.getCurrentPrice(t);if(e.money<n)return{type:"skip_property"};if(this.canMonopolize(r,e.id,t.cityId))return{type:"buy_property",propertyId:t.id};const s=this.propertyManager.getCurrentIncome(t);if(s/n>=.15)return{type:"buy_property",propertyId:t.id};const i=r.totalYears-r.currentYear;return s>0&&n/s<=i?{type:"buy_property",propertyId:t.id}:{type:"skip_property"}}decideCardUse(r,e){if(e.hand.length===0)return{type:"skip_card"};switch(e.difficulty){case"easy":return this.decideCardEasy(e);case"normal":return this.decideCardNormal(r,e);case"hard":return this.decideCardHard(r,e);default:return{type:"skip_card"}}}decideCardEasy(r){return Math.random()<.3&&r.hand.length>0?{type:"use_card",cardId:k(r.hand)}:{type:"skip_card"}}decideCardNormal(r,e){if(r.totalYears-r.currentYear<=3){const n=e.hand.find(s=>{const o=this.cardManager.getCardById(s);return(o==null?void 0:o.type)==="move_to_destination"});if(n)return{type:"use_card",cardId:n}}if(e.bombeeType!=="none"){const n=e.hand.find(s=>{const o=this.cardManager.getCardById(s);return(o==null?void 0:o.type)==="bombee_away"});if(n)return{type:"use_card",cardId:n}}return{type:"skip_card"}}decideCardHard(r,e){const t=this.cardManager.getPlayerHand(r,e.id);if(t.length===0)return{type:"skip_card"};const n=t.map(s=>({card:s,score:this.scoreCard(r,e,s.id)}));return n.sort((s,o)=>o.score-s.score),n[0].score>=50?{type:"use_card",cardId:n[0].card.id}:{type:"skip_card"}}scoreCard(r,e,t){const n=this.cardManager.getCardById(t);if(!n)return 0;switch(n.type){case"move_to_destination":return this.estimateDistanceToDestination(e.position.cityId,r.destinationCityId)*10;case"bombee_away":return e.bombeeType!=="none"?100:0;case"bombee_transfer":return e.bombeeType==="none"?0:80;case"get_money":return 40;case"steal_property":return 60;default:return 20}}estimateDistanceToDestination(r,e){if(r===e)return 0;const t=new Set,n=[{cityId:r,depth:0}];for(;n.length>0;){const s=n.shift();if(t.has(s.cityId))continue;if(t.add(s.cityId),s.cityId===e)return s.depth;if(s.depth>=10)continue;const o=this.boardManager.getAdjacentCities(s.cityId);for(const i of o)t.has(i.id)||n.push({cityId:i.id,depth:s.depth+1})}return 99}canMonopolize(r,e,t){const n=this.propertyManager.getPropertiesByCity(r.properties,t);return n.length===0?!1:n.every(s=>s.ownerId===e||s.ownerId===null)}calcCityPropertyValue(r,e,t){return this.propertyManager.getPropertiesByCity(r.properties,t).filter(s=>s.ownerId===null||s.ownerId===e).reduce((s,o)=>s+this.propertyManager.getCurrentIncome(o),0)}getStrongestOpponent(r,e){const t=r.players.filter(n=>n.id!==e);if(t.length!==0)return t.reduce((n,s)=>s.totalAssets>n.totalAssets?s:n)}getThinkingDelay(r){return{easy:800,normal:1200,hard:1800}[r]}}class Me{constructor(r){M(this,"boardManager");this.boardManager=r}calcArrivalBonus(r,e){if(!r.players.find(o=>o.id===e))return 0;const n=r.players.filter(o=>o.id!==e).reduce((o,i)=>o+i.totalAssets,0);if(n===0)return 1e3;const s=n/(r.players.length-1);return Math.max(1e3,Math.floor(s*r.players.length*.1))}processArrival(r,e){const t=this.calcArrivalBonus(r,e),n=r.players.map(l=>l.id!==e?l:{...l,money:l.money+t,totalAssets:l.totalAssets+t}),s=this.boardManager.getRandomDestination(r.destinationCityId),o=(s==null?void 0:s.id)??r.destinationCityId,i={...r,players:n,destinationCityId:o};return{bonus:t,newDestinationCityId:o,newState:i}}getDestinationCandidates(r,e,t=3){return r.filter(s=>s.id!==e).sort(()=>Math.random()-.5).slice(0,t)}getDestinationCity(r){return this.boardManager.getCityById(r.destinationCityId)}isAtDestination(r,e){return r.position.cityId===e.destinationCityId}}function O(P){const r=Math.abs(P),e=P<0?"-":"";if(r>=1e4){const t=(r/1e4).toFixed(1);return`${e}${t}億円`}return`${e}${r.toLocaleString()}万円`}const E={x:0,y:Y.TOPBAR_H,width:1280,height:540},R=Y.HUD_Y,N=Y.ACTION_X,G=7,Ie=11,we={shinkansen:4431943,local:9479342,ferry:2733814},ve={shinkansen:"新幹線",local:"在来線",ferry:"フェリー"},$=[15158332,3447003,3066993,15965202],j=5;class Oe extends T.Scene{constructor(){super({key:A.GAME});M(this,"boardManager");M(this,"propertyManager");M(this,"cardManager");M(this,"bombeeManager");M(this,"eventManager");M(this,"cpuManager");M(this,"destinationManager");M(this,"saveManager");M(this,"gameState");M(this,"pawnContainers",[]);M(this,"statusTexts",[]);M(this,"phaseText");M(this,"diceResultText");M(this,"diceButton");M(this,"diceButtonLabel");M(this,"destinationText");M(this,"yearMonthText");M(this,"destinationMarker",null);M(this,"bombeeMarker",null);M(this,"propertyDotContainers",[]);M(this,"hudPlayerBgs",[]);M(this,"junctionUI",null);M(this,"cardDrawnThisMove",!1);M(this,"extraDiceBonus",0);M(this,"isNewGame",!0)}get overlayScene(){return this.scene.get(A.OVERLAY)}init(e){this.boardManager=new ye,this.propertyManager=new ue,this.cardManager=new me,this.bombeeManager=new Se,this.eventManager=new be,this.saveManager=new J;const t=this.cache.json.get("cities"),n=this.cache.json.get("routes");if(this.boardManager.loadData({cities:t,routes:n}),this.cardManager.loadCards(this.cache.json.get("cards")??[]),this.eventManager.loadEvents(this.cache.json.get("events")??[]),this.cpuManager=new Pe(this.boardManager,this.propertyManager,this.cardManager),this.destinationManager=new Me(this.boardManager),this.isNewGame=!e.gameState,e.gameState)this.gameState=e.gameState;else{const s=e.gameConfig??{totalYears:10,players:[{name:"プレイヤー1",type:"human",difficulty:"normal"},{name:"CPU",type:"cpu",difficulty:"normal"}]};this.gameState=this.createInitialState(s)}this.gameState=this.bombeeManager.attachBombeeToLastPlace(this.gameState)}create(){const{width:e,height:t}=this.scale;this.add.rectangle(0,0,e,t,m.OCEAN).setOrigin(0),this.drawMap(),this.createTopBar(),this.createBottomHUD(),this.createPawns(),this.updateMapMarkers(),this.scene.isActive(A.OVERLAY)||this.scene.launch(A.OVERLAY),this.setDiceButtonEnabled(!1),this.time.delayedCall(400,()=>this.startFirstTurn())}drawMap(){const e=this.add.graphics();e.fillStyle(m.LAND,1);const t=(o,i)=>({x:E.x+(i-122)/25*E.width,y:E.y+(1-(o-24)/22)*E.height}),n=o=>{e.beginPath(),e.moveTo(o[0].x,o[0].y);for(let i=1;i<o.length;i++)e.lineTo(o[i].x,o[i].y);e.closePath(),e.fillPath()};n([t(41.8,140.7),t(42.3,140.3),t(43,140.5),t(44.2,141.7),t(45.4,141.5),t(45.2,143.5),t(44.3,145),t(43.4,145.3),t(43,144.4),t(42.3,143.3),t(41.8,141.3)]),n([t(41.8,141),t(41.5,141.5),t(40.5,141.8),t(39,141.8),t(38.3,141.3),t(36.5,141),t(35.6,140.8),t(35,139.5),t(34.7,138.5),t(34.6,137.5),t(34.4,136.5),t(33.5,135.8),t(34.2,135),t(34.5,135.3),t(34.4,134),t(34.3,131.5),t(33.9,130.9),t(34.2,130.7),t(34.5,131.5),t(35.5,133.5),t(35.7,134.5),t(36.3,136.3),t(36.9,137.2),t(37.5,138),t(38,139.3),t(39.5,140),t(40.5,140.3),t(41.3,140.5)]),n([t(34.2,132.5),t(34,132.8),t(33.6,133.5),t(33,133.8),t(32.9,133.3),t(32.9,132.5),t(33.3,132.1)]),n([t(33.9,130.9),t(33.5,131.4),t(33,131.7),t(32,131.4),t(31.5,130.6),t(31.1,130.5),t(31.2,130.2),t(31.8,129.8),t(32.5,129.5),t(33,129.7),t(33.5,130),t(33.7,130.5)]);const s=t(26.2,127.7);e.fillCircle(s.x,s.y,15);for(const o of this.boardManager.getAllRoutes()){const i=this.boardManager.getCityCanvasPos(o.fromCityId,E),l=this.boardManager.getCityCanvasPos(o.toCityId,E);if(!i||!l)continue;const a=we[o.routeType]??8947848,c=o.routeType==="shinkansen"?3.5:1.8,h=o.routeType==="shinkansen"?1:.7;e.lineStyle(c,a,h),e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(l.x,l.y),e.strokePath()}for(const o of this.boardManager.getAllCities()){const i=this.boardManager.getCityCanvasPos(o.id,E);if(!i)continue;e.fillStyle(16777215,1),e.fillCircle(i.x,i.y,G+2),e.fillStyle(m.PRIMARY,1),e.fillCircle(i.x,i.y,G),this.add.text(i.x+G+3,i.y,o.name,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(0,.5);const l=o;this.add.rectangle(i.x,i.y,26,26,0,0).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.showCityInfoPopup(l.id))}}showCityInfoPopup(e){const t=this.boardManager.getCityById(e);if(!t)return;const n={hokkaido:"北海道",tohoku:"東北",kanto:"関東",chubu:"中部",kinki:"近畿",chugoku:"中国",shikoku:"四国",kyushu_okinawa:"九州・沖縄"},o=this.propertyManager.getPropertiesByCity(this.gameState.properties,e).map(a=>{const c=a.ownerId?this.gameState.players.find(h=>h.id===a.ownerId):null;return{property:a,ownerName:(c==null?void 0:c.name)??null,ownerColor:(c==null?void 0:c.color)??null}}),i=this.overlayScene,l={cityName:t.name,regionName:n[t.region]??t.region,properties:o,onClose:()=>{}};i.events.emit("show_city_info",l)}createTopBar(){const{width:e}=this.scale,t=Y.TOPBAR_H,n=t/2;this.add.rectangle(0,0,e,t,m.HUD_BG).setOrigin(0),this.add.rectangle(0,t-2,e,2,m.GOLD).setOrigin(0),this.yearMonthText=this.add.text(15,n,"",{fontFamily:d.PRIMARY,fontSize:16,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(0,.5),this.destinationText=this.add.text(e/2,n,"",{fontFamily:d.PRIMARY,fontSize:17,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setOrigin(.5),this.add.text(e-12,n,"タイトルへ",{fontFamily:d.PRIMARY,fontSize:11,color:"#aaaaaa"}).setOrigin(1,.5).setInteractive({useHandCursor:!0}).on("pointerdown",()=>this.scene.start(A.TITLE)),this.updateTopBar()}createBottomHUD(){const{width:e}=this.scale;this.add.rectangle(0,R,e,Y.HUD_H,m.HUD_BG).setOrigin(0),this.add.rectangle(0,R,e,2,m.GOLD).setOrigin(0);const t=240;this.gameState.players.forEach((l,a)=>{const c=a*t,h=this.add.rectangle(c,R,t-2,Y.HUD_H,m.PANEL_DARK).setOrigin(0);this.hudPlayerBgs.push(h),this.add.rectangle(c,R,4,Y.HUD_H,$[a]).setOrigin(0),this.add.circle(c+t-18,R+18,14,m.GOLD).setDepth(1),this.add.text(c+t-18,R+18,"1",{fontFamily:d.PRIMARY,fontSize:12,color:"#000000",fontStyle:"bold"}).setOrigin(.5).setDepth(2);const u=this.add.text(c+10,R+8,l.name,{fontFamily:d.PRIMARY,fontSize:13,color:"#"+$[a].toString(16).padStart(6,"0"),fontStyle:"bold",stroke:"#000000",strokeThickness:1}),y=this.add.text(c+10,R+34,`所持金 ${O(l.money)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff"}),g=this.add.text(c+10,R+54,`総資産 ${O(l.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:13,color:"#"+m.GOLD.toString(16).padStart(6,"0"),fontStyle:"bold"}),f=this.add.text(c+10,R+78,this.getBombeeLabel(l),{fontFamily:d.PRIMARY,fontSize:10,color:"#ff4444"}),b=this.add.text(c+t-10,R+Y.HUD_H-14,`🃏 ${l.hand.length}枚`,{fontFamily:d.PRIMARY,fontSize:10,color:"#aaaaaa"}).setOrigin(1,1);if(a<this.gameState.players.length-1){const S=this.add.graphics();S.lineStyle(1,3359846,.8),S.beginPath(),S.moveTo((a+1)*t-1,R+8),S.lineTo((a+1)*t-1,R+Y.HUD_H-8),S.strokePath()}this.statusTexts.push(u,y,g,f,b)});const n=N+(e-N)/2,s=this.add.graphics();s.lineStyle(1,3359846,.8),s.beginPath(),s.moveTo(N,R+8),s.lineTo(N,R+Y.HUD_H-8),s.strokePath(),this.phaseText=this.add.text(n,R+14,"",{fontFamily:d.PRIMARY,fontSize:12,color:"#cccccc",align:"center"}).setOrigin(.5,0),this.diceResultText=this.add.text(n,R+32,"",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#"+m.SECONDARY.toString(16).padStart(6,"0"),fontStyle:"bold",align:"center"}).setOrigin(.5,0);const o=this.add.rectangle(n,R+76,200,30,9323693).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(n,R+76,"🃏 カードを見る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(1),o.on("pointerover",()=>o.setFillStyle(8207512)),o.on("pointerout",()=>o.setFillStyle(9323693)),o.on("pointerdown",()=>this.onCardButtonClick()),this.diceButton=this.add.rectangle(n,R+112,240,46,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),this.diceButtonLabel=this.add.text(n,R+112,"🎲 サイコロを振る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),this.diceButton.on("pointerover",()=>this.diceButton.setFillStyle(13369344)),this.diceButton.on("pointerout",()=>this.diceButton.setFillStyle(m.PRIMARY)),this.diceButton.on("pointerdown",()=>this.onDiceButtonClick());const i=this.add.rectangle(e-8,R+Y.HUD_H-8,80,20,2600544).setOrigin(1,1).setInteractive({useHandCursor:!0});this.add.text(e-8,R+Y.HUD_H-8,"セーブ",{fontFamily:d.PRIMARY,fontSize:11,color:"#ffffff"}).setOrigin(1,1).setDepth(1),i.on("pointerover",()=>i.setFillStyle(2202194)),i.on("pointerout",()=>i.setFillStyle(2600544)),i.on("pointerdown",()=>this.saveGame()),this.updatePhaseText()}getBombeeLabel(e){return e.bombeeType==="none"?"":`👺 ${this.bombeeManager.getBombeeName(e.bombeeType)}`}saveGame(){const e=this.saveManager.save("slot_1",this.gameState);this.overlayScene.events.emit("show_event",{title:e?"セーブ完了":"セーブ失敗",description:e?"スロット1にセーブしました":"セーブに失敗しました",onClose:()=>{}})}createPawns(){this.gameState.players.forEach((e,t)=>{const n=this.boardManager.getCityCanvasPos(e.position.cityId,E);if(!n)return;const s=this.getPawnOffset(t),o=this.add.circle(0,0,Ie,$[t]);o.setStrokeStyle(2,16777215);const i=this.add.text(0,0,`${t+1}`,{fontFamily:d.PRIMARY,fontSize:9,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),l=this.add.container(n.x+s.x,n.y+s.y,[o,i]);l.setDepth(10),this.pawnContainers.push(l)})}getPawnOffset(e){return[{x:-8,y:-8},{x:8,y:-8},{x:-8,y:8},{x:8,y:8}][e]??{x:0,y:0}}onCardButtonClick(){const e=this.gameState.players[this.gameState.currentPlayerIndex],t=this.cardManager.getPlayerHand(this.gameState,e.id);this.overlayScene.events.emit("show_card_hand",{player:e,cards:t,onUseCard:s=>this.handleCardUse(s),onDiscardCard:s=>{const o=this.cardManager.getCardById(s);this.gameState=this.cardManager.discardCard(this.gameState,e.id,s),this.updatePlayerPanel(),o&&this.showActionToast(`「${o.name}」を捨てました`)},onClose:()=>{}})}handleCardUse(e){const t=this.gameState.currentPlayerIndex,n=this.gameState.players[t],s=this.cardManager.getCardById(e);if(s){if(s.type==="sell_property"){const o=s.effect.targetType;if(o==="self_choice"){const i=this.gameState.properties.filter(c=>c.ownerId===n.id);if(i.length===0)return;const l=this.overlayScene,a={title:"売却する物件を選んでください",properties:i,onSelect:c=>{this.applyCardEffect(e,{targetCityId:n.position.cityId,targetPropertyId:c})},onCancel:()=>{}};l.events.emit("show_property_select",a);return}if(o==="opponent_forced"){const i=this.gameState.players.filter(a=>a.id!==n.id);if(i.length===0)return;this.overlayScene.events.emit("show_player_select",{title:"強制売却させるプレイヤーを選んでください",players:i,onSelect:a=>{this.applyCardEffect(e,{targetCityId:n.position.cityId,targetPlayerId:a})},onCancel:()=>{}});return}}if(s.type==="move_steps"&&s.effect.targetType==="any_station"){const o=this.boardManager.getAllCities().map(l=>({id:l.id,name:l.name}));this.overlayScene.events.emit("show_city_select",{title:"テレポート先を選んでください",cities:o,onSelect:l=>{this.applyCardEffect(e,{targetCityId:l})},onCancel:()=>{}});return}if(s.type==="bombee_transfer"&&s.effect.targetType==="last_to_second"){this.applyCardEffect(e,{});return}if(s.type==="bombee_transfer"||s.type==="card_steal"){const o=this.gameState.players.filter(a=>a.id!==n.id);if(o.length===0)return;const i=s.type==="bombee_transfer"?"ボンビーを誰に移しますか？":"カードを誰から奪いますか？",l=this.overlayScene;l.events.emit("show_player_select",{title:i,players:o,onSelect:a=>{if(s.type==="card_steal"&&s.effect.targetType==="selected_card"){const c=this.gameState.players.find(u=>u.id===a),h=this.cardManager.getPlayerHand(this.gameState,a);if(!c||h.length===0){this.applyCardEffect(e,{targetPlayerId:a});return}l.events.emit("show_card_select",{title:`${c.name} のカードを選んでください`,cards:h,onSelect:u=>{this.applyCardEffect(e,{targetPlayerId:a,targetCardId:u})},onCancel:()=>{}});return}this.applyCardEffect(e,{targetPlayerId:a})},onCancel:()=>{}});return}this.applyCardEffect(e,{targetCityId:n.position.cityId})}}applyCardEffect(e,t={}){const n=this.gameState.currentPlayerIndex,s=this.gameState.players[n],o=this.cardManager.getCardById(e),i=this.cardManager.useCard(this.gameState,s.id,e,{targetCityId:t.targetCityId??s.position.cityId,targetPlayerId:t.targetPlayerId,targetPropertyId:t.targetPropertyId,targetCardId:t.targetCardId});if(!i.success||!i.newState)return;if(this.gameState=i.newState,this.updatePlayerPanel(),(o==null?void 0:o.type)==="move_to_destination"||(o==null?void 0:o.type)==="move_to_city"){const a=this.gameState.players[n].position.cityId;this.setDiceButtonEnabled(!1),this.teleportPawn(n,a,()=>{this.onPlayerArrived(n,a)});return}if((o==null?void 0:o.type)==="move_steps"){if(this.setDiceButtonEnabled(!1),o.effect.targetType==="any_station"&&t.targetCityId){const c=t.targetCityId;this.gameState={...this.gameState,players:this.gameState.players.map((h,u)=>u===n?{...h,position:{...h.position,cityId:c}}:h)},this.teleportPawn(n,c,()=>{this.onPlayerArrived(n,c)});return}const a=o.effect.value??3;if(a>0)this.movePawnStepByStep(n,a,()=>{const c=this.gameState.players[n];this.onPlayerArrived(n,c.position.cityId)});else{const c=Math.abs(a);this.movePawnBackward(n,c,()=>{const h=this.gameState.players[n];this.onPlayerArrived(n,h.position.cityId)})}return}if((o==null?void 0:o.type)==="plus_dice"){this.extraDiceBonus=o.effect.value??1,this.overlayScene.events.emit("show_event",{title:o.name,description:`次のサイコロに +${this.extraDiceBonus} が加算されます！`,onClose:()=>this.updateCardInfo()});return}this.overlayScene.events.emit("show_event",{title:`${(o==null?void 0:o.name)??"カード"} 使用`,description:i.message??`${(o==null?void 0:o.name)??"カード"} を使いました`,onClose:()=>this.updateCardInfo()})}teleportPawn(e,t,n){const s=this.boardManager.getCityCanvasPos(t,E);if(!s){n();return}const o=this.getPawnOffset(e),i=this.pawnContainers[e];if(!i){n();return}this.tweens.add({targets:i,x:s.x+o.x,y:s.y+o.y,duration:400,ease:"Power3",onComplete:()=>{const l=this.gameState.players.map((a,c)=>c===e?{...a,position:{...a.position,cityId:t}}:a);this.gameState={...this.gameState,players:l},n()}})}onDiceButtonClick(){this.gameState.players[this.gameState.currentPlayerIndex].type!=="cpu"&&this.gameState.phase==="dice_roll"&&this.rollAndMove()}rollAndMove(){this.cardDrawnThisMove=!1;const e=this.extraDiceBonus;this.extraDiceBonus=0;const n=this.gameState.players[this.gameState.currentPlayerIndex].diceMultiplier??1;n!==1&&(this.gameState={...this.gameState,players:this.gameState.players.map((a,c)=>c===this.gameState.currentPlayerIndex?{...a,diceMultiplier:1}:a)});const s=Math.floor((q()+e)*n);this.diceResultText.setText(`🎲 ${s}`),this.setDiceButtonEnabled(!1),this.gameState={...this.gameState,phase:"moving"};const o=X.DICE_ROLL_DURATION,i=Date.now(),l=this.time.addEvent({delay:80,repeat:8,callback:()=>{const a=q();this.diceResultText.setText(`🎲 ${a}`),Date.now()-i>=o&&l.remove()}});this.time.delayedCall(o,()=>{this.diceResultText.setText(`🎲 ${s}`),this.movePawnStepByStep(this.gameState.currentPlayerIndex,s,()=>{const a=this.gameState.players[this.gameState.currentPlayerIndex];this.onPlayerArrived(this.gameState.currentPlayerIndex,a.position.cityId)})})}movePawnStepByStep(e,t,n){if(t===0){n();return}const s=this.gameState.players[e],i=this.boardManager.getRoutesFromCity(s.position.cityId).map(a=>{const c=this.boardManager.getOtherCityId(a,s.position.cityId),h=this.boardManager.getCityById(c);return h?{route:a,nextCity:h}:null}).filter(a=>a!==null);if(i.length===0){n();return}const l=a=>{this.moveOneStep(e,a.nextCity,a.route,()=>{this.movePawnStepByStep(e,t-1,n)})};if(i.length>1&&s.type==="human")this.showJunctionChoice(i,l);else{const a=s.type==="cpu"&&i.length>1?this.cpuManager.chooseRoute(this.gameState,s,i):i[0];l(a)}}moveOneStep(e,t,n,s){const o=this.boardManager.getCityCanvasPos(t.id,E);if(!o){s();return}const i=this.getPawnOffset(e),l=this.pawnContainers[e];if(!l){s();return}this.tweens.add({targets:l,x:o.x+i.x,y:o.y+i.y,duration:X.MOVE_PER_SQUARE,ease:"Power2",onComplete:()=>{const a=this.gameState.players[e].position.cityId,c=this.gameState.players.map((h,u)=>u===e?{...h,position:{cityId:t.id,routeId:null,squareIndex:0,previousCityId:a}}:h);if(this.gameState={...this.gameState,players:c},!this.cardDrawnThisMove&&n.squares.includes("card")){const h=this.gameState.players[e];if(this.cardManager.canDrawCard(this.gameState,h.id)){const u=this.cardManager.gainCard(this.gameState,h.id);u.card&&(this.gameState=u.newState,this.cardDrawnThisMove=!0,this.updateCardInfo(),this.showCardDrawToast(u.card.name))}else h.type==="human"&&this.showHandFullToast()}s()}})}movePawnBackward(e,t,n){if(t===0){n();return}const s=this.gameState.players[e],i=this.boardManager.getRoutesFromCity(s.position.cityId).map(c=>{const h=this.boardManager.getOtherCityId(c,s.position.cityId),u=this.boardManager.getCityById(h);return u?{route:c,nextCity:u}:null}).filter(c=>c!==null);if(i.length===0){n();return}const l=s.position.previousCityId,a=i.find(c=>c.nextCity.id===l)??i[0];this.moveOneStep(e,a.nextCity,a.route,()=>{this.movePawnBackward(e,t-1,n)})}showJunctionChoice(e,t){this.destroyJunctionUI();const n=450,s=50+e.length*50,o=360-s/2,i=[];i.push(this.add.rectangle(n,o+s/2,300,s,2236962,.92).setOrigin(.5)),i.push(this.add.text(n,o+16,"どの路線を選びますか？",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5)),e.forEach((l,a)=>{const c=o+42+a*50,h=ve[l.route.routeType]??l.route.routeType,u=this.add.rectangle(n,c,260,36,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(n,c,`${l.nextCity.name}（${h}）`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5);u.on("pointerover",()=>u.setFillStyle(15096362)),u.on("pointerout",()=>u.setFillStyle(m.PRIMARY)),u.on("pointerdown",()=>{this.destroyJunctionUI(),t(l)}),i.push(u,y)}),this.junctionUI=this.add.container(0,0,i),this.junctionUI.setDepth(50)}destroyJunctionUI(){this.junctionUI&&(this.junctionUI.destroy(!0),this.junctionUI=null)}onPlayerArrived(e,t){const n=this.gameState.players[e];if(t===this.gameState.destinationCityId){const s=this.destinationManager.processArrival(this.gameState,n.id);this.gameState=s.newState;const o=this.boardManager.getCityById(t);this.overlayScene.events.emit("show_destination_bonus",{player:this.gameState.players[e],bonus:s.bonus,destinationName:(o==null?void 0:o.name)??t,onClose:()=>{this.updateTopBar(),this.updatePlayerPanel(),this.checkShopAndProperty(e,t)}});return}this.checkShopAndProperty(e,t)}checkShopAndProperty(e,t){const n=this.gameState.players[e];if(ne.includes(t)){if(n.type==="human"){this.openCardShop(e,t);return}this.cpuVisitShop(e,t);return}this.checkPropertyAndEndTurn(e,t)}cpuVisitShop(e,t){const n=this.cardManager.getShopLineup(5);let s=0;const o=[];for(const i of n){if(s>=2)break;const l=this.gameState.players[e];if(!this.cardManager.canDrawCard(this.gameState,l.id))break;const a=this.cardManager.getCardShopPrice(i);if(l.money>=a*3){const c=this.cardManager.buyCard(this.gameState,l.id,i.id);c.success&&(this.gameState=c.newState,s++,o.push(i.name))}}if(s>0){this.updatePlayerPanel();const i=this.gameState.players[e],l=o.length===1?`${i.name} が「${o[0]}」を購入！`:`${i.name} がカードを${s}枚購入！`;this.showActionToast(l)}this.checkPropertyAndEndTurn(e,t)}openCardShop(e,t){const n=this.gameState.players[e],s=this.cardManager.getShopLineup(5);this.overlayScene.events.emit("show_card_shop",{player:n,lineup:s,getPrice:i=>this.cardManager.getCardShopPrice(i),onBuy:i=>{const l=this.cardManager.buyCard(this.gameState,n.id,i);l.success&&(this.gameState=l.newState,this.updatePlayerPanel()),this.cardManager.canDrawCard(this.gameState,this.gameState.players[e].id)?this.openCardShop(e,t):this.checkPropertyAndEndTurn(e,t)},onClose:()=>this.checkPropertyAndEndTurn(e,t)})}checkPropertyAndEndTurn(e,t){var a;const n=this.gameState.players[e],s=this.propertyManager.getPropertiesByCity(this.gameState.properties,t);if(s.length===0){this.endTurn();return}const o=s.find(c=>c.ownerId===null);if(o&&n.money>=this.propertyManager.getCurrentPrice(o)){if(n.type==="cpu"){if(this.cpuManager.decidePurchase(this.gameState,n,o).type==="buy_property"){const u=this.propertyManager.buyProperty(this.gameState,n.id,o.id);if(u.success&&u.newState&&(this.gameState=u.newState,this.updatePlayerPanel(),this.propertyManager.hasMonopoly(this.gameState.properties,t,n.id))){const y=((a=this.boardManager.getCityById(t))==null?void 0:a.name)??t;this.showActionToast(`${n.name} が ${y} を独占！`)}}this.endTurn();return}this.overlayScene.events.emit("show_property_purchase",{property:o,player:n,onBuy:()=>{var u;const h=this.propertyManager.buyProperty(this.gameState,n.id,o.id);if(h.success&&h.newState&&(this.gameState=h.newState,this.updatePlayerPanel(),this.propertyManager.hasMonopoly(this.gameState.properties,t,n.id))){const y=((u=this.boardManager.getCityById(t))==null?void 0:u.name)??t;this.showMonopolyToast(y)}this.endTurn()},onSkip:()=>this.endTurn()});return}const i=s.find(c=>c.ownerId!==null&&c.ownerId!==n.id);if(i){const c=this.propertyManager.getLandFee(i),h=i.ownerId,u=()=>{this.gameState={...this.gameState,players:this.gameState.players.map(f=>f.id===n.id?{...f,money:f.money-c}:f.id===h?{...f,money:f.money+c}:f)},this.gameState=this.propertyManager.recalcTotalAssets(this.gameState);const y=this.gameState.players.find(f=>f.id===h);this.overlayScene.events.emit("show_event",{title:"地代支払い",description:`${n.name} が ${(y==null?void 0:y.name)??"?"} に
${O(c)} 支払いました`,onClose:()=>{this.updatePlayerPanel(),this.endTurn()}})};n.money<c?this.handleBankruptcy(n.id,c,u):u();return}const l=s.find(c=>c.ownerId===n.id&&c.upgradeLevel<c.upgradePrices.length&&n.money>=c.upgradePrices[c.upgradeLevel]);if(l){if(n.type==="cpu"){const h=this.propertyManager.upgradeProperty(this.gameState,n.id,l.id);if(h.success&&h.newState){this.gameState=h.newState,this.updatePlayerPanel();const u=l.upgradeLevel+1;this.showActionToast(`${n.name} が「${l.name}」をLv${u}にアップグレード！`)}this.endTurn();return}this.overlayScene.events.emit("show_property_upgrade",{property:l,player:n,onUpgrade:()=>{const h=this.propertyManager.upgradeProperty(this.gameState,n.id,l.id);h.success&&h.newState&&(this.gameState=h.newState,this.updatePlayerPanel()),this.endTurn()},onSkip:()=>this.endTurn()});return}this.endTurn()}handleBankruptcy(e,t,n){const s=this.gameState.players.find(a=>a.id===e),o=this.propertyManager.getOwnedProperties(this.gameState.properties,e);if(s.type==="cpu"){let a=s;for(;a.money<t;){const c=this.propertyManager.getOwnedProperties(this.gameState.properties,e);if(c.length===0)break;const h=c.reduce((u,y)=>y.price<u.price?y:u);this.gameState=this.propertyManager.sellPropertyForcibly(this.gameState,e,h.id),a=this.gameState.players.find(u=>u.id===e)??a}this.updatePlayerPanel(),n();return}const i=this.overlayScene,l={player:s,debtAmount:t,properties:o,onSell:a=>{this.gameState=this.propertyManager.sellPropertyForcibly(this.gameState,e,a),this.updatePlayerPanel(),this.gameState.players.find(h=>h.id===e).money>=t?n():this.handleBankruptcy(e,t,n)},onConfirm:()=>n()};i.events.emit("show_bankruptcy",l)}endTurn(){const e=this.bombeeManager.processBombeeAction(this.gameState);if(this.gameState=e.newState,e.message){this.updatePlayerPanel(),this.overlayScene.events.emit("show_event",{title:"ボンビー行動！",description:e.message,onClose:()=>this.advanceMonth()});return}this.advanceMonth()}advanceMonth(){const e=this.gameState.currentMonth+1;if(e>12){this.gameState={...this.gameState,currentMonth:1,currentYear:this.gameState.currentYear+1},this.triggerYearEnd();return}this.gameState={...this.gameState,currentMonth:e};const t=this.eventManager.drawMonthlyEvents(e);if(t.length>0){this.applyEventsSequentially(t,0,()=>this.nextPlayer());return}this.nextPlayer()}applyEventsSequentially(e,t,n){if(t>=e.length){n();return}const s=e[t],o=this.gameState.players[this.gameState.currentPlayerIndex],i=this.eventManager.applyEvent(this.gameState,s,o.id);this.gameState=i.newState,this.updatePlayerPanel(),this.overlayScene.events.emit("show_event",{title:s.name,description:s.description,onClose:()=>this.applyEventsSequentially(e,t+1,n)})}triggerYearEnd(){if(this.gameState.currentYear>this.gameState.totalYears){this.scene.start(A.RESULT,{gameState:this.gameState});return}const{newState:e,results:t}=this.propertyManager.calcYearEndIncome(this.gameState);this.gameState=this.bombeeManager.decrementBombeeImmunity(e),this.overlayScene.events.emit("show_year_end",{year:this.gameState.currentYear-1,results:t,players:this.gameState.players,onClose:()=>{this.updatePlayerPanel(),this.nextPlayer()}})}nextPlayer(){const e=(this.gameState.currentPlayerIndex+1)%this.gameState.players.length;this.gameState={...this.gameState,currentPlayerIndex:e,phase:"dice_roll",turnCount:this.gameState.turnCount+1},this.updateTopBar(),this.updatePhaseText(),this.updatePlayerPanel(),this.setDiceButtonEnabled(!1);const t=this.gameState.players[e];this.showTurnBanner(t.name,()=>{if(t.type==="cpu"){const n=this.cpuManager.getThinkingDelay(t.difficulty);this.time.delayedCall(n,()=>this.cpuTakeTurn(e))}else this.setDiceButtonEnabled(!0)})}startFirstTurn(){const e=this.gameState.players[this.gameState.currentPlayerIndex],t=()=>{this.showTurnBanner(e.name,()=>{if(e.type==="cpu"){const n=this.cpuManager.getThinkingDelay(e.difficulty);this.time.delayedCall(n,()=>this.cpuTakeTurn(this.gameState.currentPlayerIndex))}else this.setDiceButtonEnabled(!0)})};this.isNewGame?this.showStartBanner(t):t()}showStartBanner(e){const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=this.gameState.totalYears,l=this.add.rectangle(s,o,t,140,9109504,.92).setOrigin(.5).setDepth(100).setAlpha(0),a=this.add.text(s,o-28,"ゲームスタート！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffe066",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(101).setAlpha(0),c=this.add.text(s,o+22,`目標：${i}年後に総資産トップを目指せ！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(101).setAlpha(0),h=[l,a,c];this.tweens.add({targets:h,alpha:{from:0,to:1},duration:400,ease:"Power2",onComplete:()=>{this.time.delayedCall(1400,()=>{this.tweens.add({targets:h,alpha:0,duration:350,ease:"Power2",onComplete:()=>{l.destroy(),a.destroy(),c.destroy(),e()}})})}})}showTurnBanner(e,t){const{width:n,height:s}=this.scale,o=n/2,i=s/2,l=this.add.rectangle(o,i,n,100,1714762,.88).setOrigin(.5).setDepth(100).setAlpha(0),a=this.add.text(o,i,`${e} のターン`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(101).setAlpha(0);this.tweens.add({targets:[l,a],alpha:{from:0,to:1},duration:300,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:[l,a],alpha:0,duration:300,ease:"Power2",onComplete:()=>{l.destroy(),a.destroy(),t()}})})}})}cpuTakeTurn(e){const t=this.gameState.players[e],n=this.cpuManager.decideCardUse(this.gameState,t);if(n.type==="use_card"&&n.cardId){const s=n.cardId,o=this.cardManager.getCardById(s);if(o){this.showActionToast(`${t.name} が「${o.name}」を使用！`);const i=o.type==="bombee_transfer"||o.type==="card_steal",l=o.type==="bombee_transfer"&&o.effect.targetType==="last_to_second";this.time.delayedCall(600,()=>{if(i&&!l){const h=this.gameState.players.filter(u=>u.id!==t.id).reduce((u,y)=>y.totalAssets>u.totalAssets?y:u);this.applyCardEffect(s,{targetPlayerId:h.id,targetCityId:t.position.cityId})}else this.applyCardEffect(s,{targetCityId:t.position.cityId});if(!(o.type==="move_to_destination"||o.type==="move_to_city"||o.type==="move_steps")){const h=this.cpuManager.getThinkingDelay(t.difficulty);this.time.delayedCall(h,()=>this.rollAndMove())}});return}}this.rollAndMove()}updateTopBar(){const{currentYear:e,currentMonth:t}=this.gameState;this.yearMonthText.setText(`${e}年目 ${t}月`);const n=this.boardManager.getCityById(this.gameState.destinationCityId);this.destinationText.setText(`★ 目的地：${(n==null?void 0:n.name)??"???"}`),this.updateMapMarkers()}updateMapMarkers(){const e=this.boardManager.getCityCanvasPos(this.gameState.destinationCityId,E);if(this.destinationMarker&&this.destinationMarker.destroy(),this.destinationMarker=null,e){const s=this.add.container(e.x,e.y-18),o=this.add.circle(0,0,10,15844367,.9),i=this.add.text(0,0,"★",{fontFamily:d.PRIMARY,fontSize:10,color:"#ffffff"}).setOrigin(.5);s.add([o,i]),this.destinationMarker=s}this.bombeeMarker&&this.bombeeMarker.destroy(),this.bombeeMarker=null;const t=this.gameState.players.find(s=>s.bombeeType!=="none");if(t){const s=this.boardManager.getCityCanvasPos(t.position.cityId,E);if(s){const o=this.add.container(s.x+14,s.y-14),i=this.add.circle(0,0,8,15158332,.85),l={mini:"😈",normal:"👿",king:"🔴"},a=this.add.text(0,0,l[t.bombeeType]??"😈",{fontFamily:d.PRIMARY,fontSize:8}).setOrigin(.5);o.add([i,a]),this.bombeeMarker=o}}this.propertyDotContainers.forEach(s=>s.destroy()),this.propertyDotContainers=[];const n=new Map;for(const s of this.gameState.properties)s.ownerId&&(n.has(s.cityId)||n.set(s.cityId,new Set),n.get(s.cityId).add(s.ownerId));n.forEach((s,o)=>{const i=this.boardManager.getCityCanvasPos(o,E);if(!i)return;const l=[...s];l.forEach((a,c)=>{const h=this.gameState.players.find(b=>b.id===a);if(!h)return;const u=i.x+(c-(l.length-1)/2)*7,y=i.y+12,g=this.add.container(u,y),f=this.add.circle(0,0,4,h.color,.9);g.add(f),this.propertyDotContainers.push(g)})})}updatePhaseText(){const e=this.gameState.players[this.gameState.currentPlayerIndex];this.phaseText.setText(`${e.name}のターン`),this.diceButtonLabel.setText(e.type==="cpu"?`${e.name}（CPU）が考え中...`:"サイコロを振る")}updatePlayerPanel(){const e=new Map;[...this.gameState.players].sort((n,s)=>s.totalAssets-n.totalAssets).forEach((n,s)=>e.set(n.id,s+1));const t=[m.GOLD,m.SILVER,m.BRONZE,8947848];this.gameState.players.forEach((n,s)=>{const o=s*j+0,i=s*j+1,l=s*j+2,a=s*j+3,c=s*j+4,h=s===this.gameState.currentPlayerIndex,u=e.get(n.id)??s+1;if(s<this.hudPlayerBgs.length&&(h?(this.hudPlayerBgs[s].setFillStyle(2767450),this.hudPlayerBgs[s].setStrokeStyle(2,$[s])):(this.hudPlayerBgs[s].setFillStyle(m.PANEL_DARK),this.hudPlayerBgs[s].setStrokeStyle(0))),o<this.statusTexts.length){const y=h?"▶ ":"",g="#"+(t[u-1]??11184810).toString(16).padStart(6,"0");this.statusTexts[o].setText(`${y}${u}位 ${n.name}`),this.statusTexts[o].setColor(g)}i<this.statusTexts.length&&(this.statusTexts[i].setText(`所持金 ${O(n.money)}`),this.statusTexts[i].setColor(n.money<0?"#ff4444":"#ffffff")),l<this.statusTexts.length&&this.statusTexts[l].setText(`総資産 ${O(n.totalAssets)}`),a<this.statusTexts.length&&this.statusTexts[a].setText(this.getBombeeLabel(n)),c<this.statusTexts.length&&this.statusTexts[c].setText(`🃏 ${n.hand.length}枚`)}),this.updateMapMarkers()}updateCardInfo(){this.updatePlayerPanel()}showCardDrawToast(e){const{width:t}=this.scale,n=this.add.text(t/2,340,`🃏 カード入手！
「${e}」`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:14,y:8},align:"center"}).setOrigin(.5).setDepth(100).setAlpha(0);this.tweens.add({targets:n,alpha:{from:0,to:1},y:{from:360,to:320},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:n,alpha:0,y:300,duration:300,ease:"Power2",onComplete:()=>n.destroy()})})}})}showMonopolyToast(e){const{width:t}=this.scale,n=this.add.text(t/2,340,`★ ${e} を独占！
収益が2倍になります！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffe066",fontStyle:"bold",backgroundColor:"#8b0000",padding:{x:16,y:10},align:"center",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(110).setAlpha(0);this.tweens.add({targets:n,alpha:{from:0,to:1},y:{from:360,to:310},duration:250,ease:"Power2",onComplete:()=>{this.time.delayedCall(1200,()=>{this.tweens.add({targets:n,alpha:0,y:280,duration:350,ease:"Power2",onComplete:()=>n.destroy()})})}})}showHandFullToast(){const{width:e}=this.scale,t=D.MAX_CARD_COUNT,n=this.add.text(e/2,340,`手札が一杯！（${t}/${t}枚）
カードマスを通過しました`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold",backgroundColor:"#7f8c8d",padding:{x:14,y:8},align:"center"}).setOrigin(.5).setDepth(100).setAlpha(0);this.tweens.add({targets:n,alpha:{from:0,to:1},y:{from:360,to:320},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(900,()=>{this.tweens.add({targets:n,alpha:0,y:300,duration:300,ease:"Power2",onComplete:()=>n.destroy()})})}})}showActionToast(e){const{width:t}=this.scale,n=this.add.text(t/2,300,e,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",backgroundColor:"#2c3e50",padding:{x:14,y:8},align:"center",wordWrap:{width:320}}).setOrigin(.5).setDepth(200).setAlpha(0);this.tweens.add({targets:n,alpha:{from:0,to:1},y:{from:320,to:280},duration:200,ease:"Power2",onComplete:()=>{this.time.delayedCall(1200,()=>{this.tweens.add({targets:n,alpha:0,y:260,duration:300,ease:"Power2",onComplete:()=>n.destroy()})})}})}setDiceButtonEnabled(e){this.diceButton.setInteractive(e),this.diceButton.setFillStyle(e?m.PRIMARY:11184810),this.diceButton.setAlpha(e?1:.6)}createInitialState(e){const t="tokyo",n=this.boardManager.getRandomDestination(t),s=e.players.map((o,i)=>({id:`player_${i}`,name:o.name,type:o.type,difficulty:o.difficulty,money:1e4,totalAssets:1e4,position:{cityId:t,routeId:null,squareIndex:0},hand:[],bombeeType:"none",bombeeElapsedTurns:0,color:$[i],pawIndex:i,incomeMultiplier:1,diceMultiplier:1,bombeeImmuneYears:0}));return{id:`game_${Date.now()}`,currentYear:1,currentMonth:4,totalYears:e.totalYears,currentPlayerIndex:0,phase:"dice_roll",players:s,properties:this.cache.json.get("properties")??[],destinationCityId:(n==null?void 0:n.id)??"osaka",turnCount:0}}}class Re extends T.Scene{constructor(){super({key:A.OVERLAY});M(this,"overlayObjects",[])}create(){this.events.removeAllListeners(),this.events.on("show_property_purchase",e=>{this.showPropertyPurchase(e)}),this.events.on("show_year_end",e=>{this.showYearEnd(e)}),this.events.on("show_destination_bonus",e=>{this.showDestinationBonus(e)}),this.events.on("show_event",e=>{this.showEvent(e)}),this.events.on("show_card_hand",e=>{this.showCardHand(e)}),this.events.on("show_property_upgrade",e=>{this.showPropertyUpgrade(e)}),this.events.on("show_card_shop",e=>{this.showCardShop(e)}),this.events.on("show_player_select",e=>{this.showPlayerSelect(e)}),this.events.on("show_property_select",e=>{this.showPropertySelect(e)}),this.events.on("show_city_select",e=>{this.showCitySelect(e)}),this.events.on("show_card_select",e=>{this.showCardSelect(e)}),this.events.on("show_bankruptcy",e=>{this.showBankruptcy(e)}),this.events.on("show_city_info",e=>{this.showCityInfo(e)})}showPropertyPurchase(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(s,o,500,340,16777215).setOrigin(.5);l.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(l);const a=this.add.text(s,o-140,"物件購入",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.PRIMARY.toString(16).padStart(6,"0"),padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(s,o-80,e.property.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(c),[`購入価格：${O(e.property.price)}`,`年間収益：${O(e.property.income)}`,`所持金：${O(e.player.money)}`].forEach((w,p)=>{const I=this.add.text(s,o-30+p*28,w,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555"}).setOrigin(.5);this.overlayObjects.push(I)});const u=e.player.money-e.property.price,y=this.add.text(s,o+60,`購入後：${O(u)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:u>=0?"#27ae60":"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(y);const g=this.add.rectangle(s-90,o+120,160,48,m.SUCCESS).setOrigin(.5).setInteractive({useHandCursor:!0}),f=this.add.text(s-90,o+120,"購入する",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);g.on("pointerover",()=>g.setFillStyle(2267476)),g.on("pointerout",()=>g.setFillStyle(m.SUCCESS)),g.on("pointerdown",()=>{this.hideOverlay(),e.onBuy()}),this.overlayObjects.push(g,f);const b=this.add.rectangle(s+90,o+120,160,48,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),S=this.add.text(s+90,o+120,"スキップ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);b.on("pointerover",()=>b.setFillStyle(6710886)),b.on("pointerout",()=>b.setFillStyle(8947848)),b.on("pointerdown",()=>{this.hideOverlay(),e.onSkip()}),this.overlayObjects.push(b,S)}showYearEnd(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=Math.min(120+e.results.length*80,500),l=this.add.rectangle(0,0,t,n,0,.6).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,560,i,16775664).setOrigin(.5);a.setStrokeStyle(3,15965202),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+30,`${e.year}年目 年末決算`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#f39c12",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.results.forEach((y,g)=>{const f=e.players.find(p=>p.id===y.playerId);if(!f)return;const b=o-i/2+90+g*80,S=this.add.text(s-220,b,f.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=[`物件収益：${O(y.propertyIncome)}`,y.monopolyBonus>0?`独占ボーナス：+${O(y.monopolyBonus)}`:null,`合計：${O(y.totalIncome)}`].filter(Boolean);w.forEach((p,I)=>{const v=I===w.length-1,C=this.add.text(s+20,b-18+I*22,p,{fontFamily:d.PRIMARY,fontSize:12,color:v?"#e74c3c":"#555555",fontStyle:v?"bold":"normal"}).setOrigin(0,.5);this.overlayObjects.push(C)})});const h=this.add.rectangle(s,o+i/2-30,180,44,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,o+i/2-30,"次のターンへ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(15096362)),h.on("pointerout",()=>h.setFillStyle(m.PRIMARY)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,u)}showDestinationBonus(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(s,o,460,280,16775664).setOrigin(.5);l.setStrokeStyle(3,15844367),this.overlayObjects.push(l);const a=this.add.text(s,o-100,"🎉",{fontSize:48}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(s,o-40,`${e.player.name} が
「${e.destinationName}」に到着！`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold",align:"center"}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.text(s,o+30,`ボーナス：${O(e.bonus)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(h);const u=this.add.rectangle(s,o+100,160,44,15844367).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(s,o+100,"続ける",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(.5).setDepth(1);u.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(u,y)}showEvent(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(i);const l=this.add.rectangle(s,o,480,240,16777215).setOrigin(.5);l.setStrokeStyle(3,m.SECONDARY),this.overlayObjects.push(l);const a=this.add.text(s,o-80,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.SECONDARY.toString(16).padStart(6,"0"),padding:{x:16,y:6}}).setOrigin(.5);this.overlayObjects.push(a);const c=this.add.text(s,o-10,e.description,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",align:"center",wordWrap:{width:400}}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.rectangle(s,o+80,140,44,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,o+80,"OK",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(15096362)),h.on("pointerout",()=>h.setFillStyle(m.PRIMARY)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,u)}showCardHand(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=e.cards.length===0?200:Math.min(140+e.cards.length*58,520),l=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,520,i,16777215).setOrigin(.5);a.setStrokeStyle(3,9323693),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+26,`${e.player.name}の手札`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:20,y:6}}).setOrigin(.5);if(this.overlayObjects.push(c),e.cards.length===0){const y=this.add.text(s,o-10,`手札がありません
移動中にカードマスを通ると引けます`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555",align:"center"}).setOrigin(.5);this.overlayObjects.push(y)}else e.cards.forEach((y,g)=>{const f=o-i/2+70+g*58,b=this.add.rectangle(s-20,f,440,50,16314623).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(s-220,f-6,y.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(s-220,f+11,y.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(s+155,f,70,34,m.SUCCESS).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(s+155,f,"使う",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(2267476)),p.on("pointerout",()=>p.setFillStyle(m.SUCCESS)),p.on("pointerdown",()=>{this.hideOverlay(),e.onUseCard(y.id)}),this.overlayObjects.push(p,I);const v=this.add.rectangle(s+230,f,56,34,9807270).setOrigin(.5).setInteractive({useHandCursor:!0}),C=this.add.text(s+230,f,"捨",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);v.on("pointerover",()=>v.setFillStyle(8359053)),v.on("pointerout",()=>v.setFillStyle(9807270)),v.on("pointerdown",()=>{this.hideOverlay(),e.onDiscardCard(y.id)}),this.overlayObjects.push(v,C)});const h=this.add.rectangle(s,o+i/2-26,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,o+i/2-26,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(h,u)}showCardShop(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=Math.min(160+e.lineup.length*62,540),l=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,540,i,16777215).setOrigin(.5);a.setStrokeStyle(3,1482885),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+26,"🏪 カード売り場",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#16a085",padding:{x:20,y:6}}).setOrigin(.5);this.overlayObjects.push(c);const h=this.add.text(s,o-i/2+58,`所持金：${O(e.player.money)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333"}).setOrigin(.5);this.overlayObjects.push(h),e.lineup.forEach((g,f)=>{const b=o-i/2+90+f*62,S=e.getPrice(g),w=e.player.money>=S,p=this.add.rectangle(s-10,b,480,54,w?15794168:16316664).setOrigin(.5);this.overlayObjects.push(p);const I={common:"#888888",uncommon:"#3498db",rare:"#e74c3c"},v={common:"普通",uncommon:"珍しい",rare:"レア"},C=this.add.text(s-240,b-8,v[g.rarity]??g.rarity,{fontFamily:d.PRIMARY,fontSize:10,color:I[g.rarity]??"#888888",fontStyle:"bold",backgroundColor:"#eeeeee",padding:{x:4,y:2}}).setOrigin(0,.5);this.overlayObjects.push(C);const F=this.add.text(s-185,b-8,g.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(F);const B=this.add.text(s-240,b+11,g.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666",wordWrap:{width:300}}).setOrigin(0,.5);this.overlayObjects.push(B);const x=this.add.rectangle(s+200,b,90,36,w?1482885:11184810).setOrigin(.5).setInteractive({useHandCursor:w}),_=this.add.text(s+200,b,`${S}万`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);w&&(x.on("pointerover",()=>x.setFillStyle(950384)),x.on("pointerout",()=>x.setFillStyle(1482885)),x.on("pointerdown",()=>{this.hideOverlay(),e.onBuy(g.id)})),this.overlayObjects.push(x,_)});const u=this.add.rectangle(s,o+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),y=this.add.text(s,o+i/2-28,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);u.on("pointerover",()=>u.setFillStyle(6710886)),u.on("pointerout",()=>u.setFillStyle(8947848)),u.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(u,y)}showPropertyUpgrade(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=e.property,l=i.upgradePrices[i.upgradeLevel],a=i.upgradeLevel===0?i.income:i.upgradeIncomes[i.upgradeLevel-1]??i.income,c=i.upgradeIncomes[i.upgradeLevel]??a,h=this.add.rectangle(0,0,t,n,0,.5).setOrigin(0);this.overlayObjects.push(h);const u=this.add.rectangle(s,o,500,360,16777215).setOrigin(.5);u.setStrokeStyle(3,15105570),this.overlayObjects.push(u);const y=this.add.text(s,o-150,"物件アップグレード",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#e67e22",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(y);const g=this.add.text(s,o-90,i.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#333333",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(g);const f=this.add.text(s,o-55,`現在 Lv.${i.upgradeLevel} → Lv.${i.upgradeLevel+1}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#e67e22",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(f),[`アップグレード費用：${O(l)}`,`現在の年収：${O(a)} → ${O(c)}`,`所持金：${O(e.player.money)}`].forEach((F,B)=>{const x=this.add.text(s,o-10+B*28,F,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#555555"}).setOrigin(.5);this.overlayObjects.push(x)});const S=e.player.money-l,w=this.add.text(s,o+80,`購入後：${O(S)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:S>=0?"#27ae60":"#e74c3c",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(w);const p=this.add.rectangle(s-90,o+135,160,48,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(s-90,o+135,"アップグレード",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(13266718)),p.on("pointerout",()=>p.setFillStyle(15105570)),p.on("pointerdown",()=>{this.hideOverlay(),e.onUpgrade()}),this.overlayObjects.push(p,I);const v=this.add.rectangle(s+90,o+135,160,48,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),C=this.add.text(s+90,o+135,"スキップ",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);v.on("pointerover",()=>v.setFillStyle(6710886)),v.on("pointerout",()=>v.setFillStyle(8947848)),v.on("pointerdown",()=>{this.hideOverlay(),e.onSkip()}),this.overlayObjects.push(v,C)}showPropertySelect(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=Math.min(180+e.properties.length*62,500),l=this.add.rectangle(0,0,t,n,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,500,i,16777215).setOrigin(.5);a.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#"+m.PRIMARY.toString(16).padStart(6,"0"),padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.properties.forEach((y,g)=>{const f=o-i/2+86+g*62,b=this.add.rectangle(s,f,450,52,16774638).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(s-200,f-8,y.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(s-200,f+12,`価格：${O(y.price)}  収益：${O(y.income)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#777777"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(s+180,f,90,36,m.DANGER).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(s+180,f,"売却",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(12597547)),p.on("pointerout",()=>p.setFillStyle(m.DANGER)),p.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(y.id)}),this.overlayObjects.push(p,I)});const h=this.add.rectangle(s,o+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,o+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(h,u)}showPlayerSelect(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=Math.min(180+e.players.length*66,480),l=this.add.rectangle(0,0,t,n,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,480,i,16777215).setOrigin(.5);a.setStrokeStyle(3,9323693),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#8e44ad",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c),e.players.forEach((y,g)=>{const f=o-i/2+90+g*66,b=this.add.rectangle(s,f,420,54,16314623).setOrigin(.5);this.overlayObjects.push(b);const S=this.add.text(s-170,f-8,y.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(S);const w=this.add.text(s-170,f+12,`総資産：${O(y.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#777777"}).setOrigin(0,.5);this.overlayObjects.push(w);const p=this.add.rectangle(s+160,f,90,36,9323693).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(s+160,f,"選択",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(8207512)),p.on("pointerout",()=>p.setFillStyle(9323693)),p.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(y.id)}),this.overlayObjects.push(p,I)});const h=this.add.rectangle(s,o+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),u=this.add.text(s,o+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);h.on("pointerover",()=>h.setFillStyle(6710886)),h.on("pointerout",()=>h.setFillStyle(8947848)),h.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(h,u)}showCardSelect(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=Math.min(180+e.cards.length*70,500),l=this.add.rectangle(0,0,t,n,0,.55).setOrigin(0);this.overlayObjects.push(l);const a=this.add.rectangle(s,o,520,i,16777215).setOrigin(.5);a.setStrokeStyle(3,15158332),this.overlayObjects.push(a);const c=this.add.text(s,o-i/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#e74c3c",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(c);const h={common:"普通",uncommon:"珍しい",rare:"レア"},u={common:"#888888",uncommon:"#3498db",rare:"#e74c3c"};e.cards.forEach((f,b)=>{const S=o-i/2+82+b*70,w=this.add.rectangle(s,S,470,58,16773360).setOrigin(.5);this.overlayObjects.push(w);const p=this.add.text(s-215,S-10,h[f.rarity]??f.rarity,{fontFamily:d.PRIMARY,fontSize:10,color:u[f.rarity]??"#888888",fontStyle:"bold",backgroundColor:"#eeeeee",padding:{x:4,y:2}}).setOrigin(0,.5);this.overlayObjects.push(p);const I=this.add.text(s-155,S-10,f.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(I);const v=this.add.text(s-215,S+12,f.description,{fontFamily:d.PRIMARY,fontSize:10,color:"#666666",wordWrap:{width:310}}).setOrigin(0,.5);this.overlayObjects.push(v);const C=this.add.rectangle(s+190,S,90,38,15158332).setOrigin(.5).setInteractive({useHandCursor:!0}),F=this.add.text(s+190,S,"奪う",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);C.on("pointerover",()=>C.setFillStyle(12597547)),C.on("pointerout",()=>C.setFillStyle(15158332)),C.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(f.id)}),this.overlayObjects.push(C,F)});const y=this.add.rectangle(s,o+i/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),g=this.add.text(s,o+i/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);y.on("pointerover",()=>y.setFillStyle(6710886)),y.on("pointerout",()=>y.setFillStyle(8947848)),y.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(y,g)}showCitySelect(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=640,l=480,a=3,c=180,h=38,u=15,y=10,g=this.add.rectangle(0,0,t,n,0,.6).setOrigin(0);this.overlayObjects.push(g);const f=this.add.rectangle(s,o,i,l,16777215).setOrigin(.5);f.setStrokeStyle(3,1752220),this.overlayObjects.push(f);const b=this.add.text(s,o-l/2+28,e.title,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold",backgroundColor:"#1abc9c",padding:{x:20,y:8}}).setOrigin(.5);this.overlayObjects.push(b);const S=s-i/2+40+c/2,w=o-l/2+80;e.cities.forEach((v,C)=>{const F=C%a,B=Math.floor(C/a),x=S+F*(c+u),_=w+B*(h+y),L=this.add.rectangle(x,_,c,h,1752220).setOrigin(.5).setInteractive({useHandCursor:!0}),H=this.add.text(x,_,v.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);L.on("pointerover",()=>L.setFillStyle(1482885)),L.on("pointerout",()=>L.setFillStyle(1752220)),L.on("pointerdown",()=>{this.hideOverlay(),e.onSelect(v.id)}),this.overlayObjects.push(L,H)});const p=this.add.rectangle(s,o+l/2-28,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),I=this.add.text(s,o+l/2-28,"キャンセル",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);p.on("pointerover",()=>p.setFillStyle(6710886)),p.on("pointerout",()=>p.setFillStyle(8947848)),p.on("pointerdown",()=>{this.hideOverlay(),e.onCancel()}),this.overlayObjects.push(p,I)}showBankruptcy(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=e.properties.length,l=i>0?Math.min(240+i*62,520):240,a=this.add.rectangle(0,0,t,n,0,.65).setOrigin(0);this.overlayObjects.push(a);const c=this.add.rectangle(s,o,520,l,16777215).setOrigin(.5);c.setStrokeStyle(4,15105570),this.overlayObjects.push(c);const h=this.add.rectangle(s,o-l/2+28,520,56,15105570).setOrigin(.5);this.overlayObjects.push(h);const u=this.add.text(s,o-l/2+28,"⚠ 所持金不足",{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);this.overlayObjects.push(u);const y=Math.max(0,e.debtAmount-e.player.money),g=o-l/2+80,f=this.add.text(s,g,`${e.player.name} の所持金が不足しています
必要額：${O(e.debtAmount)}  所持：${O(e.player.money)}
不足額：${O(y)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#c0392b",fontStyle:"bold",align:"center"}).setOrigin(.5,0);if(this.overlayObjects.push(f),i===0){const p=this.add.text(s,o,`売却できる物件がありません
このまま続けます（負債確定）`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#777777",align:"center"}).setOrigin(.5);this.overlayObjects.push(p);const I=this.add.rectangle(s,o+l/2-36,180,42,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),v=this.add.text(s,o+l/2-36,"続ける",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);I.on("pointerover",()=>I.setFillStyle(13849600)),I.on("pointerout",()=>I.setFillStyle(15105570)),I.on("pointerdown",()=>{this.hideOverlay(),e.onConfirm()}),this.overlayObjects.push(I,v);return}const b=o-l/2+148;e.properties.forEach((p,I)=>{const v=b+I*62,C=this.add.rectangle(s,v,480,52,16774112).setOrigin(.5);this.overlayObjects.push(C);const F=this.add.text(s-215,v-8,p.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(F);const B=Math.floor(p.price*.5),x=this.add.text(s-215,v+12,`価格 ${O(p.price)} → 売却額 ${O(B)}（半額）`,{fontFamily:d.PRIMARY,fontSize:11,color:"#888888"}).setOrigin(0,.5);this.overlayObjects.push(x);const _=this.add.rectangle(s+195,v,100,38,15105570).setOrigin(.5).setInteractive({useHandCursor:!0}),L=this.add.text(s+195,v,"売る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);_.on("pointerover",()=>_.setFillStyle(13849600)),_.on("pointerout",()=>_.setFillStyle(15105570)),_.on("pointerdown",()=>{this.hideOverlay(),e.onSell(p.id)}),this.overlayObjects.push(_,L)});const S=this.add.rectangle(s,o+l/2-28,200,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),w=this.add.text(s,o+l/2-28,"このまま続ける（負債）",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff"}).setOrigin(.5).setDepth(1);S.on("pointerover",()=>S.setFillStyle(6710886)),S.on("pointerout",()=>S.setFillStyle(8947848)),S.on("pointerdown",()=>{this.hideOverlay(),e.onConfirm()}),this.overlayObjects.push(S,w)}showCityInfo(e){this.beginOverlay();const{width:t,height:n}=this.scale,s=t/2,o=n/2,i=e.properties.length,l=i===0?200:Math.min(180+i*52,500),a=this.add.rectangle(0,0,t,n,0,.4).setOrigin(0).setInteractive();a.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(a);const c=this.add.rectangle(s,o,480,l,16777215).setOrigin(.5);c.setStrokeStyle(3,m.PRIMARY),this.overlayObjects.push(c);const h=this.add.rectangle(s,o-l/2+26,480,52,m.PRIMARY).setOrigin(.5);this.overlayObjects.push(h);const u=this.add.text(s,o-l/2+22,e.cityName,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5,.5);this.overlayObjects.push(u);const y=this.add.text(s,o-l/2+40,e.regionName,{fontFamily:d.PRIMARY,fontSize:11,color:"#ffe0cc"}).setOrigin(.5,.5);if(this.overlayObjects.push(y),i===0){const b=this.add.text(s,o,"この都市に物件はありません",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#888888"}).setOrigin(.5);this.overlayObjects.push(b)}else{const b=o-l/2+76;e.properties.forEach((S,w)=>{const p=b+w*52,I=S.property,v=this.add.rectangle(s,p,450,44,w%2===0?16775408:16773344).setOrigin(.5);this.overlayObjects.push(v);const C=S.ownerColor??13421772,F=this.add.circle(s-205,p,8,C,S.ownerColor?1:.3);this.overlayObjects.push(F);const B=this.add.text(s-190,p-7,I.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#333333",fontStyle:"bold"}).setOrigin(0,.5);this.overlayObjects.push(B);const x=S.ownerName?`所有: ${S.ownerName}`:"未所有",_=S.ownerName?"#"+(S.ownerColor??8947848).toString(16).padStart(6,"0"):"#999999",L=this.add.text(s-190,p+8,x,{fontFamily:d.PRIMARY,fontSize:11,color:_}).setOrigin(0,.5);this.overlayObjects.push(L);const H=I.upgradeLevel>0?` Lv${I.upgradeLevel}`:"",Q=I.upgradeLevel>0?I.upgradeIncomes[I.upgradeLevel-1]??I.income:I.income,ee=this.add.text(s+220,p,`${O(I.price)}${H} / 収益${O(Q)}`,{fontFamily:d.PRIMARY,fontSize:11,color:"#555555"}).setOrigin(1,.5);this.overlayObjects.push(ee)})}const g=this.add.rectangle(s,o+l/2-26,140,38,8947848).setOrigin(.5).setInteractive({useHandCursor:!0}),f=this.add.text(s,o+l/2-26,"閉じる",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1);g.on("pointerover",()=>g.setFillStyle(6710886)),g.on("pointerout",()=>g.setFillStyle(8947848)),g.on("pointerdown",()=>{this.hideOverlay(),e.onClose()}),this.overlayObjects.push(g,f)}beginOverlay(){this.hideOverlay();const e=this.scene.get(A.GAME);e&&(e.input.enabled=!1)}hideOverlay(){this.overlayObjects.forEach(t=>t.destroy()),this.overlayObjects=[];const e=this.scene.get(A.GAME);e&&(e.input.enabled=!0)}}const Ce=[15158332,3447003,3066993,15965202],Ae=["#f1c40f","#aaaaaa","#cd7f32","#888888"];class Te extends T.Scene{constructor(){super({key:A.RESULT});M(this,"gameState")}init(e){this.gameState=e.gameState}create(){const{width:e,height:t}=this.scale,n=e/2;if(this.add.rectangle(0,0,e,t,m.HUD_BG).setOrigin(0),this.add.rectangle(0,t*.6,e,t*.4,853536,.8).setOrigin(0),this.add.rectangle(n,60,e,80,m.PRIMARY,.9).setOrigin(.5),this.add.text(n,60,"ゲーム終了！",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),!this.gameState||this.gameState.players.length===0){this.showNoDataFallback(n,t);return}const s=this.getRankedPlayers(this.gameState.players);this.showWinner(n,s[0]),this.showRankings(n,s),this.showGameInfo(n,t),this.createReturnButton(n,t-50),this.spawnConfetti(e,t),this.animateEntrance()}getRankedPlayers(e){return[...e].sort((t,n)=>n.totalAssets-t.totalAssets)}showWinner(e,t){this.add.text(e,130,"🏆 優勝者 🏆",{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#f1c40f",fontStyle:"bold"}).setOrigin(.5),this.add.text(e,175,t.name,{fontFamily:d.PRIMARY,fontSize:48,color:"#ffffff",fontStyle:"bold",stroke:"#cc0000",strokeThickness:3}).setOrigin(.5),this.add.text(e,215,`総資産 ${O(t.totalAssets)}`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:"#f1c40f",fontStyle:"bold"}).setOrigin(.5)}showRankings(e,t){this.add.text(e,265,"--- 最終順位 ---",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#aaaaaa"}).setOrigin(.5),t.forEach((n,s)=>{const o=310+s*80,i="#"+Ce[n.pawIndex].toString(16).padStart(6,"0"),l=s===0?2889744:1710638,a=s===0?.9:.6;this.add.rectangle(e,o,560,68,l,a).setOrigin(.5),s===0&&this.add.rectangle(e,o,560,68).setOrigin(.5).setStrokeStyle(2,15844367);const c=s+1;this.add.text(e-250,o,`${c}位`,{fontFamily:d.PRIMARY,fontSize:d.SIZE.LG,color:Ae[s]??"#888888",fontStyle:"bold"}).setOrigin(0,.5),this.add.text(e-160,o-14,n.name,{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:i,fontStyle:"bold"}).setOrigin(0,.5);const h=this.gameState.properties.filter(u=>u.ownerId===n.id).length;this.add.text(e-160,o+12,`所持金 ${O(n.money)}  物件${h}件`,{fontFamily:d.PRIMARY,fontSize:12,color:"#aaaaaa"}).setOrigin(0,.5),this.add.text(e+240,o,O(n.totalAssets),{fontFamily:d.PRIMARY,fontSize:d.SIZE.MD,color:"#ffffff",fontStyle:"bold"}).setOrigin(1,.5)})}showGameInfo(e,t){this.gameState&&this.add.text(e,t-110,`${this.gameState.totalYears}年間のゲームが終了しました`,{fontFamily:d.PRIMARY,fontSize:13,color:"#666666"}).setOrigin(.5)}createReturnButton(e,t){const n=this.add.rectangle(e,t,240,48,m.PRIMARY).setOrigin(.5).setInteractive({useHandCursor:!0});this.add.text(e,t,"タイトルへ戻る",{fontFamily:d.PRIMARY,fontSize:d.SIZE.SM,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5).setDepth(1),n.on("pointerover",()=>n.setFillStyle(15096362)),n.on("pointerout",()=>n.setFillStyle(m.PRIMARY)),n.on("pointerdown",()=>this.scene.start(A.TITLE))}showNoDataFallback(e,t){this.add.text(e,t/2,"ゲーム終了",{fontFamily:d.PRIMARY,fontSize:d.SIZE.XL,color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.createReturnButton(e,t/2+80)}spawnConfetti(e,t){const n=[16711680,16776960,65280,65535,16711935,16746496,16777215];for(let s=0;s<60;s++){const o=T.Math.Between(0,e),i=this.add.rectangle(o,-20,8,12,T.Utils.Array.GetRandom(n)).setDepth(200).setRotation(T.Math.FloatBetween(0,Math.PI*2));this.tweens.add({targets:i,y:t+30,x:o+T.Math.Between(-80,80),rotation:i.rotation+T.Math.FloatBetween(-3,3),alpha:{from:1,to:.4},duration:T.Math.Between(1800,3500),delay:T.Math.Between(0,1200),ease:"Sine.easeIn",onComplete:()=>i.destroy()})}}animateEntrance(){this.cameras.main.fadeIn(600,0,0,0)}}const xe={type:T.AUTO,width:D.WIDTH,height:D.HEIGHT,backgroundColor:"#fff9f0",scene:[oe,re,ie,le,Oe,Re,Te],scale:{mode:T.Scale.FIT,autoCenter:T.Scale.CENTER_BOTH},parent:"game-container"};new T.Game(xe);
